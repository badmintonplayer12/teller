<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Badminton Poengteller</title>
  <!-- Inter ‚Äì pene, jevnbrede sifre med tabular-nums (uten slashed zero) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    :root{ --vh: 1vh; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{ margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:#0f172a; color:#fff; display:flex; flex-direction:column; max-width:100vw; overflow-x:hidden; }
    header{ background:#1f2937; padding:.5rem 1rem; display:flex; align-items:center; gap:1rem; justify-content:space-between; position:relative; max-width:100vw; overflow:hidden }
    header h1{ font-size:1rem; margin:0 }
    .wrap{ flex:1; display:grid; grid-template-columns:1fr 1fr; gap:1rem; padding:1rem; max-width:100vw; overflow:hidden }
    .side{ background:#111827; border-radius:.8rem; padding:1rem; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative }
    .name{ font-size:1.2rem; margin-bottom:.5rem }
    .name input{ font:inherit; color:#e5e7eb; background:#1f2937; border:1px solid #0008; border-radius:.4rem; padding:.25rem .5rem; text-align:center; width:100% }

    /* Poeng: to faste ruter (tiere + enere). Inter + tabular-nums = like-brede sifre */
    .score{
      width:100%; display:flex; justify-content:center; align-items:center;
      text-align:center; font-weight:900; line-height:0.92; cursor:pointer;
      user-select:none; -webkit-user-select:none; white-space:nowrap; overflow:hidden;
      will-change:text-shadow,color; touch-action:manipulation;
      font-family:Inter, ui-sans-serif, system-ui, sans-serif;
      font-variant-numeric:tabular-nums; font-feature-settings:'tnum' 1;
    }
    .score::selection{ background:transparent }
    .digits{ display:flex; gap:var(--dgap, 0.08em); align-items:baseline }
    .digit{ width:1ch; text-align:center }
    .digit.ghost{ visibility:hidden }

    .minusBtn{ margin-top:.75rem; font-size:1.4rem; padding:.6rem 1rem; border-radius:.6rem; border:0; background:#ef4444; color:#fff; cursor:pointer; touch-action:manipulation }

    footer{ background:#1f2937; padding:.6rem 1rem; display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap; max-width:100vw; overflow:hidden }
    footer button{ padding:.6rem 1rem; border-radius:.6rem; border:0; cursor:pointer; touch-action:manipulation }

    #sets{ padding:.6rem 1rem; text-align:center; font-size:1.2rem }
    #winnerMsg{ padding:1rem 1rem 0; text-align:center; font-size:clamp(1.2rem,3.5vw,2rem); color:#facc15; font-weight:900; white-space:pre-line }

    .setCounter{ position:absolute; top:.5rem; right:.5rem; background:#22c55e; color:#06210f; font-weight:900; border-radius:50%; width:2rem; height:2rem; display:flex; align-items:center; justify-content:center }

    /* Trykk-animasjon: gl√∏d + fargeendring (uten layout-endring) */
    @keyframes glowChange{ 0%{ color:#fff; text-shadow:none } 40%{ color:#facc15; text-shadow:0 0 25px rgba(250,204,21,.8) } 100%{ color:#fff; text-shadow:none } }
    .score.pop{ animation:glowChange 280ms ease-out }

    .final .score, .final .minusBtn{ pointer-events:none; opacity:.85 }
    #newMatchBtn{ display:none; background:#22c55e; color:#06210f; font-weight:900 }
    .final #newMatchBtn{ display:inline-block }

    /* M√•leelement ‚Äì samme font/features som poeng for korrekt skalering */
    #measure{
      position:absolute; left:-9999px; top:-9999px; visibility:hidden;
      white-space:nowrap; font-weight:900; line-height:0.92;
      font-variant-numeric:tabular-nums; font-feature-settings:'tnum' 1;
      font-family:Inter, ui-sans-serif, system-ui, sans-serif;
    }
    #version{ position:absolute; top:.3rem; right:.5rem; font-size:.75rem; color:#9ca3af; pointer-events:none }
  </style>
</head>
<body>
  <header>
    <h1>üè∏ Badminton Poengteller</h1>
    <button id="fsBtn" onclick="toggleFullscreen()">‚õ∂ Fullskjerm</button>
    <div id="version">v2.2</div>
  </header>

  <div id="sets">Sett: 0-0</div>

  <div class="wrap">
    <div class="side" id="sideA">
      <div id="setCounterA" class="setCounter" style="display:none">0</div>
      <div class="name"><input id="nameA" value="Spiller A" /></div>
      <div class="score" id="scoreA" onclick="addPoint('A')">
        <span class="digits">
          <span class="digit" id="A_tens">0</span>
          <span class="digit" id="A_ones">0</span>
        </span>
      </div>
      <button class="minusBtn" onclick="removePoint('A')">‚àí1</button>
    </div>

    <div class="side" id="sideB">
      <div id="setCounterB" class="setCounter" style="display:none">0</div>
      <div class="name"><input id="nameB" value="Spiller B" /></div>
      <div class="score" id="scoreB" onclick="addPoint('B')">
        <span class="digits">
          <span class="digit" id="B_tens">0</span>
          <span class="digit" id="B_ones">0</span>
        </span>
      </div>
      <button class="minusBtn" onclick="removePoint('B')">‚àí1</button>
    </div>
  </div>

  <div id="winnerMsg"></div>

  <footer>
    <button onclick="swapSides()">Bytt side</button>
    <button onclick="resetSet()">Nullstill sett</button>
    <button id="newMatchBtn" onclick="startNewMatch()">Start ny kamp</button>
    <button onclick="resetMatch()">Nullstill kamp</button>
  </footer>

  <span id="measure">88</span>

  <script>
    // --- Viewport h√∏yde (mobil adressefelt) ---
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    setVH();

    // --- Tilstand ---
    let scoreA=0, scoreB=0;
    let setsA=0, setsB=0;
    const target=21, cap=30;
    let currentSet=1;
    let swappedAt11=false;
    let locked=false;          // l√•s poeng etter kamp-slutt
    let scoreFontPx=null;      // l√•s fontst√∏rrelse mellom oppdateringer

    // --- UI ---
    function update(){
      const a=scoreA, b=scoreB;
      // NB: bruk vanlig minus '-' (ikke en-dash)
      document.getElementById('sets').textContent = `Sett: ${setsA}-${setsB}`;

      const counterA=document.getElementById('setCounterA');
      const counterB=document.getElementById('setCounterB');
      counterA.style.display = setsA>0 ? 'flex' : 'none';
      counterB.style.display = setsB>0 ? 'flex' : 'none';
      if(setsA>0) counterA.textContent = setsA;
      if(setsB>0) counterB.textContent = setsB;

      // A
      const A_t = Math.floor(a/10), A_o=a%10;
      const A_tensEl=document.getElementById('A_tens');
      const A_onesEl=document.getElementById('A_ones');
      if(a<10){ A_tensEl.textContent='0'; A_tensEl.classList.add('ghost'); }
      else{ A_tensEl.textContent=String(A_t); A_tensEl.classList.remove('ghost'); }
      A_onesEl.textContent=String(A_o);

      // B
      const B_t = Math.floor(b/10), B_o=b%10;
      const B_tensEl=document.getElementById('B_tens');
      const B_onesEl=document.getElementById('B_ones');
      if(b<10){ B_tensEl.textContent='0'; B_tensEl.classList.add('ghost'); }
      else{ B_tensEl.textContent=String(B_t); B_tensEl.classList.remove('ghost'); }
      B_onesEl.textContent=String(B_o);
    }

    // --- Beregn/l√•s fontst√∏rrelsen kun ved skjerm/FS-endringer og n√•r kampen er ferdig ---
    function resizeScores(force){
      if(!force && typeof scoreFontPx==='number'){
        document.getElementById('scoreA').style.fontSize = scoreFontPx + 'px';
        document.getElementById('scoreB').style.fontSize = scoreFontPx + 'px';
        return;
      }
      const sA=document.getElementById('scoreA');
      const sB=document.getElementById('scoreB');
      const meas=document.getElementById('measure');

      // Minste av venstre/h√∏yre boks bestemmer, s√• ingen av dem kan overflowe
      const boxWidth=Math.min(sA.clientWidth,sB.clientWidth);
      const maxVhPct=document.body.classList.contains('final')?35:70;
      const maxH=Math.floor(window.innerHeight*(maxVhPct/100));

      // M√•l to ¬´8¬ª med samme gap som i .digits for √• speile faktisk layout
      const baseFont=100;
      meas.style.fontSize=baseFont+'px';
      meas.innerHTML = '<span class="digits" style="display:flex;gap:0.08em"><span>8</span><span>8</span></span>';
      const inner = meas.firstElementChild;
      const rect=inner.getBoundingClientRect();
      const wBase=rect.width||1, hBase=rect.height||1;

      const sizeByWidth=boxWidth/wBase*baseFont;
      const sizeByHeight=maxH/hBase*baseFont;
      scoreFontPx=Math.floor(Math.min(sizeByWidth,sizeByHeight));

      sA.style.fontSize=scoreFontPx+'px';
      sB.style.fontSize=scoreFontPx+'px';
    }

    // --- Effekt uten layout-hopp ---
    function bump(el){ el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop'); }

    // --- Handling ---
    function addPoint(side){ if(locked) return; if(side==='A') scoreA++; else scoreB++; checkSetEnd(); update(); bump(document.getElementById(side==='A'?'scoreA':'scoreB')); }
    function removePoint(side){ if(locked) return; if(side==='A'&&scoreA>0) scoreA--; if(side==='B'&&scoreB>0) scoreB--; update(); }

    function checkSetEnd(){
      const lead=Math.abs(scoreA-scoreB);
      if((scoreA>=target||scoreB>=target)&&(lead>=2||scoreA===cap||scoreB===cap)){
        if(scoreA>scoreB) setsA++; else setsB++;
        if(setsA===2||setsB===2){
          const nameA=document.getElementById('nameA').value;
          const nameB=document.getElementById('nameB').value;
          const matchWinner=setsA===2?nameA:nameB;
          const matchLoser=setsA===2?nameB:nameA;
          document.getElementById('winnerMsg').textContent=`üéâ GRATULERER ${matchWinner.toUpperCase()}! DU VANT KAMPEN!\nüëè BRA JOBBA ${matchLoser.toUpperCase()}, DU GJORDE DITT BESTE.`;
          document.body.classList.add('final');
          locked=true; resizeScores(true); // krymp tall i gratulasjonsvisning
          return;
        }
        // Nytt sett
        scoreA=0; scoreB=0; currentSet++; swappedAt11=false; swapSides();
      }
      // I tredje sett bytter man side ved f√∏rste som n√•r 11 (kun √©n gang)
      if(currentSet===3 && !swappedAt11 && (scoreA===11 || scoreB===11)){
        swapSides(); swappedAt11=true;
      }
    }

    function swapSides(){
      const nameA=document.getElementById('nameA');
      const nameB=document.getElementById('nameB');
      const tmpName=nameA.value; nameA.value=nameB.value; nameB.value=tmpName;
      const tmpScore=scoreA; scoreA=scoreB; scoreB=tmpScore;
      const tmpSets=setsA; setsA=setsB; setsB=tmpSets;
      update();
    }

    function resetSet(){ if(locked) return; scoreA=0; scoreB=0; swappedAt11=false; document.getElementById('winnerMsg').textContent=''; update(); }
    function resetMatch(){ scoreA=0; scoreB=0; setsA=0; setsB=0; currentSet=1; swappedAt11=false; locked=false; scoreFontPx=null; document.getElementById('winnerMsg').textContent=''; document.body.classList.remove('final'); update(); resizeScores(true); }
    function startNewMatch(){ resetMatch(); }

    function toggleFullscreen(){
      const btn=document.getElementById('fsBtn');
      if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); if(btn) btn.textContent='‚§¢ Avslutt fullskjerm'; }
      else{ document.exitFullscreen(); if(btn) btn.textContent='‚õ∂ Fullskjerm'; }
    }

    // --- Lyttere for re-kalibrering og touch ---
    window.addEventListener('resize', ()=>{ setVH(); resizeScores(true); });
    document.addEventListener('fullscreenchange', ()=>{ resizeScores(true); });

    // iOS: hindre double-tap zoom
    (function(){
      let lastTouchEnd=0;
      document.addEventListener('touchend', function(e){
        const now=Date.now();
        if(now-lastTouchEnd<=300){ e.preventDefault(); }
        lastTouchEnd=now;
      }, {passive:false});
    })();

    function bindTouch(id, fn){ const el=document.getElementById(id); if(!el) return; el.addEventListener('touchstart', (e)=>{ e.preventDefault(); fn(); }, {passive:false}); }
    bindTouch('scoreA', ()=>addPoint('A'));
    bindTouch('scoreB', ()=>addPoint('B'));
    bindTouch('newMatchBtn', ()=>startNewMatch());

    // --- Init ---
    update();
    resizeScores(true);

    // --- Tester (frivillig, i DevTools) ---
    function runTests(){
      const log=(ok,msg)=>console[ok?'log':'error']((ok?'‚úÖ':'‚ùå')+' '+msg);
      try{
        // Senterposisjon stabil 9‚Üí10 for begge sider
        resetMatch();
        const center = (id)=>{ const r=document.getElementById(id).getBoundingClientRect(); return r.left + r.width/2; };
        scoreA=9; scoreB=9; update(); const cA9=center('scoreA'), cB9=center('scoreB');
        scoreA=10; scoreB=10; update(); const cA10=center('scoreA'), cB10=center('scoreB');
        log(Math.abs(cA9-cA10) < 1.0, 'A: senter stabil 9‚Üí10');
        log(Math.abs(cB9-cB10) < 1.0, 'B: senter stabil 9‚Üí10');
        // Ingen horisontal scrolling
        log(document.documentElement.scrollWidth <= window.innerWidth+1, 'Ingen horisontal scrolling');
      }catch(e){ console.error('Tester feilet:', e); }
    }

    // Ekstra tester (ikke endre over): sjekk font-reset & minus-tegn
    function runTestsExtra(){
      const log=(ok,msg)=>console[ok?'log':'error']((ok?'‚úÖ':'‚ùå')+' '+msg);
      try{
        resetMatch(); const fBefore=scoreFontPx; scoreA=21; checkSetEnd(); scoreA=21; checkSetEnd();
        log(locked && document.body.classList.contains('final'), 'Finalel√•s ved kamp-slutt');
        const fFinal=scoreFontPx; startNewMatch(); const fAfter=scoreFontPx;
        log(typeof fBefore==='number' && typeof fFinal==='number' && fAfter===fBefore, 'Font resettes etter Start ny kamp');
        log(/Sett: \d+-\d+/.test(document.getElementById('sets').textContent), 'Sets-label bruker standard minus (-)');
      }catch(e){ console.error('Ekstra tester feilet:', e); }
    }
  </script>
</body>
</html>
