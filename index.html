<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Badminton Poengteller</title>
  <style>
    :root{ --vh: 1vh; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:#0f172a; color:#fff; display:flex; flex-direction:column; max-width:100vw; overflow-x:hidden; }

    header{ background:#1f2937; padding:.5rem 1rem; display:flex; align-items:center; gap:1rem; justify-content:space-between; position:relative; max-width:100vw; overflow:hidden }
    header h1{ font-size:1rem; margin:0 }
    #version{ position:absolute; top:.3rem; right:.5rem; font-size:.75rem; color:#9ca3af; pointer-events:none }

    .wrap{ flex:1; display:grid; grid-template-columns:1fr 2px 1fr; column-gap:3rem; padding:1rem; max-width:100vw; align-items:stretch }
    .divider{ background:#1e293b; }

    .side{ background:#111827; border-radius:.8rem; padding:1rem; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; position:relative; min-height:0; will-change:transform,opacity }

    /* Sideswap animasjoner */
    .swap-enter-left{ animation: enterLeft .35s ease both }
    .swap-exit-left{ animation: exitLeft .35s ease both }
    .swap-enter-right{ animation: enterRight .35s ease both }
    .swap-exit-right{ animation: exitRight .35s ease both }
    @keyframes exitLeft   { from{opacity:1;transform:translateX(0)}   to{opacity:.15;transform:translateX(-12%)} }
    @keyframes exitRight  { from{opacity:1;transform:translateX(0)}   to{opacity:.15;transform:translateX(12%)} }
    @keyframes enterLeft  { from{opacity:.15;transform:translateX(12%)}  to{opacity:1; transform:translateX(0)} }
    @keyframes enterRight { from{opacity:.15;transform:translateX(-12%)} to{opacity:1; transform:translateX(0)} }

    .name{ font-size:1.2rem; margin-bottom:.5rem }
    .name input{ font:inherit; color:#e5e7eb; background:#1f2937; border:1px solid #0008; border-radius:.4rem; padding:.25rem .5rem; text-align:center; width:100% }

    .setCounter{ position:absolute; top:.5rem; right:.5rem; background:#22c55e; color:#06210f; font-weight:900; border-radius:999px; padding:.25rem .6rem; min-width:2rem; text-align:center }

    .score{ width:100%; display:flex; justify-content:center; align-items:center; text-align:center; font-weight:900; line-height:0.92; cursor:pointer; user-select:none; -webkit-user-select:none; white-space:nowrap; overflow:hidden; font-variant-numeric:tabular-nums; will-change:filter,text-shadow,transform }
    .score::selection{ background:transparent }

    .digits{ display:flex; gap:var(--dgap, 0.08em); align-items:baseline }
    .digit{ display:inline-block; width:1ch; text-align:center }
    .digit.ghost{ visibility:hidden }

    .scoreBox{ flex:1 1 auto; width:100%; min-height:0; display:flex; align-items:center; justify-content:center }

    .minusBtn{ margin-top:.75rem; font-size:1.4rem; padding:.6rem 1rem; border-radius:.6rem; border:0; background:#ef4444; color:#fff; cursor:pointer }

    /* Trykk-gl√∏d */
    .glow{ animation: glowPulse .25s ease-out 1; }
    @keyframes glowPulse{ 0%{text-shadow:0 0 0 rgba(59,130,246,0); filter:drop-shadow(0 0 0 rgba(59,130,246,0));}
                           30%{text-shadow:0 0 18px rgba(59,130,246,.85);} 
                           100%{text-shadow:0 0 0 rgba(59,130,246,0);} }

    /* M√•leelement for fontberegning */
    #measure{ position:absolute; left:-9999px; top:-9999px; visibility:hidden; white-space:nowrap; font-weight:900; line-height:0.92; font-variant-numeric:tabular-nums }

    #sets{ padding:.6rem 1rem; text-align:center; font-size:1.2rem }
    #winnerMsg{ padding:1rem 1rem 0; text-align:center; font-size:clamp(1.2rem,3.5vw,2rem); color:#facc15; font-weight:900; white-space:pre-line }
  </style>
</head>
<body>
  <header>
    <h1>üè∏ Badminton Poengteller</h1>
    <button id="fsBtn" onclick="toggleFullscreen()">‚õ∂ Fullskjerm</button>
    <div id="version">v4.0R</div>
  </header>

  <div id="sets">Sett: 0-0</div>

  <div class="wrap" id="wrap">
    <div class="side" id="sideA">
      <div id="setCounterA" class="setCounter" style="display:none">0</div>
      <div class="name"><input id="nameA" value="Spiller A" /></div>
      <div class="scoreBox">
        <div class="score" id="scoreA" onclick="addPoint('A')">
          <span class="digits">
            <span class="digit" id="A_tens">0</span>
            <span class="digit" id="A_ones">0</span>
          </span>
        </div>
      </div>
      <button class="minusBtn" onclick="removePoint('A')">‚àí1</button>
    </div>

    <div class="divider"></div>

    <div class="side" id="sideB">
      <div id="setCounterB" class="setCounter" style="display:none">0</div>
      <div class="name"><input id="nameB" value="Spiller B" /></div>
      <div class="scoreBox">
        <div class="score" id="scoreB" onclick="addPoint('B')">
          <span class="digits">
            <span class="digit" id="B_tens">0</span>
            <span class="digit" id="B_ones">0</span>
          </span>
        </div>
      </div>
      <button class="minusBtn" onclick="removePoint('B')">‚àí1</button>
    </div>
  </div>

  <div id="winnerMsg"></div>

  <footer>
    <button onclick="swapSides()">Bytt side</button>
    <button onclick="resetSet()">Nullstill sett</button>
    <button id="newMatchBtn" onclick="startNewMatch()">Start ny kamp</button>
    <button onclick="resetMatch()">Nullstill kamp</button>
  </footer>

  <span id="measure">88</span>

  <script>
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    setVH();

    let scoreA=0, scoreB=0; let setsA=0, setsB=0; const target=21, cap=30; let currentSet=1; let swappedAt11=false; let locked=false;

    // rAF-basert, enkel og robust resize-k√∏ ‚Äì alltid re-beregn (ogs√• ved krymping)
    let rafId=null, toId=null;
    function queueFit(){
      cancelAnimationFrame(rafId); clearTimeout(toId);
      rafId = requestAnimationFrame(()=>{
        resizeScores();
        toId = setTimeout(resizeScores, 60); // lite etter-pass
      });
    }

    function update(){
      document.getElementById('sets').textContent = `Sett: ${setsA}-${setsB}`;

      const A_t = Math.floor(scoreA/10), A_o=scoreA%10; const B_t=Math.floor(scoreB/10), B_o=scoreB%10;
      const AT=document.getElementById('A_tens'), AO=document.getElementById('A_ones');
      const BT=document.getElementById('B_tens'), BO=document.getElementById('B_ones');
      if(scoreA<10){ AT.textContent='0'; AT.classList.add('ghost'); } else { AT.textContent=String(A_t); AT.classList.remove('ghost'); }
      AO.textContent=String(A_o);
      if(scoreB<10){ BT.textContent='0'; BT.classList.add('ghost'); } else { BT.textContent=String(B_t); BT.classList.remove('ghost'); }
      BO.textContent=String(B_o);
    }

    // Gl√∏d ved trykk
    function glow(id){ const el=document.getElementById(id); el.classList.remove('glow'); void el.offsetWidth; el.classList.add('glow'); }

    function addPoint(side){ if(locked) return; if(side==='A') scoreA++; else scoreB++; checkSetEnd(); update(); glow(side==='A'?'scoreA':'scoreB'); }
    function removePoint(side){ if(locked) return; if(side==='A'&&scoreA>0) scoreA--; if(side==='B'&&scoreB>0) scoreB--; update(); }

    function checkSetEnd(){
      const lead=Math.abs(scoreA-scoreB);
      if((scoreA>=target||scoreB>=target)&&(lead>=2||scoreA===cap||scoreB===cap)){
        if(scoreA>scoreB) setsA++; else setsB++;
        if(setsA===2||setsB===2){
          const nameA=document.getElementById('nameA').value; const nameB=document.getElementById('nameB').value;
          const matchWinner=setsA===2?nameA:nameB; const matchLoser=setsA===2?nameB:nameA;
          document.getElementById('winnerMsg').textContent=`üéâ GRATULERER ${matchWinner.toUpperCase()}! DU VANT KAMPEN!\nüëè BRA JOBBA ${matchLoser.toUpperCase()}, DU GJORDE DITT BESTE.`;
          document.body.classList.add('final'); locked=true; queueFit(); return;
        }
        scoreA=0; scoreB=0; currentSet++; swappedAt11=false; animateSwapThenSwapData();
      }
      if(currentSet===3 && !swappedAt11 && (scoreA===11||scoreB===11)){
        animateSwapThenSwapData(); swappedAt11=true;
      }
    }

    // Sideswap med liten glide-animasjon
    function animateSwapThenSwapData(){
      const a=document.getElementById('sideA');
      const b=document.getElementById('sideB');
      a.classList.remove('swap-enter-left','swap-exit-left');
      b.classList.remove('swap-enter-right','swap-exit-right');
      a.classList.add('swap-exit-left');
      b.classList.add('swap-exit-right');
      const onEnd=()=>{
        a.removeEventListener('animationend', onEnd);
        // bytt data
        const nameA=document.getElementById('nameA'); const nameB=document.getElementById('nameB');
        const tmpName=nameA.value; nameA.value=nameB.value; nameB.value=tmpName;
        const tmpScore=scoreA; scoreA=scoreB; scoreB=tmpScore;
        const tmpSets=setsA; setsA=setsB; setsB=tmpSets;
        update();
        // enter anim
        a.classList.remove('swap-exit-left'); b.classList.remove('swap-exit-right');
        a.classList.add('swap-enter-left'); b.classList.add('swap-enter-right');
        queueFit();
      };
      a.addEventListener('animationend', onEnd);
    }

    function swapSides(){ animateSwapThenSwapData(); }

    function resetSet(){ if(locked) return; scoreA=0; scoreB=0; swappedAt11=false; document.getElementById('winnerMsg').textContent=''; update(); queueFit(); }
    function resetMatch(){ scoreA=0; scoreB=0; setsA=0; setsB=0; currentSet=1; swappedAt11=false; locked=false; document.getElementById('winnerMsg').textContent=''; document.body.classList.remove('final'); update(); queueFit(); }
    function startNewMatch(){ resetMatch(); }

    function toggleFullscreen(){ const btn=document.getElementById('fsBtn'); if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); if(btn) btn.textContent='‚§¢ Avslutt fullskjerm'; } else { document.exitFullscreen(); if(btn) btn.textContent='‚õ∂ Fullskjerm'; } }

    // --- Fonttilpasning: pr√∏ver √• ligge s√• n√¶r 100% av h√∏yden (navn + poeng) som mulig, uten √• overskride bredde ---
    function resizeScores(){
      const sA=document.getElementById('scoreA');
      const sB=document.getElementById('scoreB');
      const nameA=document.querySelector('#sideA .name');
      const nameB=document.querySelector('#sideB .name');
      const vh = window.innerHeight || document.documentElement.clientHeight;
      const nameAH = nameA ? nameA.offsetHeight : 0;
      const nameBH = nameB ? nameB.offsetHeight : 0;
      const reservedTop = Math.max(nameAH, nameBH) + 10; // litt luft
      const maxH = Math.max(40, vh - reservedTop);

      const boxA = document.querySelector('#sideA .scoreBox');
      const boxB = document.querySelector('#sideB .scoreBox');
      const minBoxW = Math.min(boxA.clientWidth, boxB.clientWidth);

      // m√•l referanse ¬´88¬ª i baseFont
      const meas=document.getElementById('measure');
      const baseFont=100; meas.style.fontSize=baseFont+'px';
      meas.innerHTML = '<span class="digits" style="display:flex;gap:0.08em"><span style="display:inline-block;width:1ch">8</span><span style="display:inline-block;width:1ch">8</span></span>';
      const rect=meas.firstElementChild.getBoundingClientRect();
      const wBase=rect.width||1, hBase=rect.height||1;

      let nextFont = Math.floor(Math.min(minBoxW/wBase*baseFont, maxH/hBase*baseFont));
      sA.style.fontSize=nextFont+'px';
      sB.style.fontSize=nextFont+'px';

      // liten iterativ sikkerhet for √• garantere pass i b√•de bredde og h√∏yde
      for(let i=0;i<24;i++){
        const aR = sA.querySelector('.digits').getBoundingClientRect();
        const bR = sB.querySelector('.digits').getBoundingClientRect();
        const scaleA = Math.min(1, (minBoxW / aR.width) || 1, (maxH / aR.height) || 1);
        const scaleB = Math.min(1, (minBoxW / bR.width) || 1, (maxH / bR.height) || 1);
        const scale = Math.min(scaleA, scaleB);
        if(scale >= 0.999) break;
        nextFont = Math.max(1, Math.floor(nextFont * scale * 0.996));
        sA.style.fontSize=nextFont+'px';
        sB.style.fontSize=nextFont+'px';
      }
    }

    // Lyttere
    window.addEventListener('resize', ()=>{ setVH(); queueFit(); });
    document.addEventListener('fullscreenchange', ()=> queueFit());
    if(window.visualViewport){ visualViewport.addEventListener('resize', ()=> queueFit()); }

    // Init
    update();
    queueFit();
  </script>
</body>
</html>
