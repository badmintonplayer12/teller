<!DOCTYPE html><html lang="no"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/><title>Badminton Poengteller</title><style>:root{--gap:clamp(12px,3vw,36px);--divider:2px;--scrollGap:clamp(16px,2.2vw,40px);--accent:#60a5fa;--minus:#ef4444}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f172a;color:#fff;display:flex;flex-direction:column;max-width:100vw;overflow-x:hidden;user-select:none}.editing{user-select:auto}header{background:#1f2937;padding:.5rem 1rem;display:flex;align-items:center;gap:1rem;justify-content:space-between;position:relative}header h1{font-size:1rem;margin:0}#version{position:absolute;top:.3rem;right:.6rem;font-size:.75rem;color:#9ca3af;pointer-events:none}.wrap{flex:0 0 auto;min-height:100vh;display:grid;grid-template-columns:1fr var(--divider) 1fr;column-gap:var(--gap);padding:var(--gap);align-items:stretch;overflow:hidden;position:relative}.divider{width:var(--divider);background:#1e293b;z-index:2}.side{position:relative;background:#111827;border-radius:.8rem;padding:clamp(8px,1.8vw,16px);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow:hidden;will-change:transform;transition:transform 1s ease;z-index:1}.wrap.swap-go .left{transform:translateX(calc(100% + var(--gap) + var(--divider)))}.wrap.swap-go .right{transform:translateX(calc(-100% - var(--gap) - var(--divider)))}.no-trans .side{transition:none!important}.name{min-height:clamp(36px,6vh,56px);display:flex;align-items:center;justify-content:center;width:100%;margin:.6rem 0 .25rem 0;position:relative}.name .combo{position:relative;display:inline-flex;align-items:center}.name input{font:inherit;color:#e5e7eb;background:#1f2937;border:1px solid #0008;border-radius:.5rem;padding:.35rem .75rem;text-align:center;width:min(18ch,92%);max-width:18ch;overflow:hidden;text-overflow:ellipsis;transition:color .6s,text-shadow .6s}.name input:disabled{opacity:.95;cursor:default}.name button.drop{position:absolute;right:.35rem;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#9ca3af;cursor:pointer;font-size:1rem;line-height:1;padding:.1rem}.name .menu{position:absolute;left:0;right:0;top:calc(100% + 4px);background:#0b1224;border:1px solid #122042;border-radius:.5rem;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:10;display:none;max-height:40vh;overflow:auto}.name .menu.open{display:block}/* üëá NYTT: Skjul ‚ñæ-knappen n√•r navn er l√•st (ikke-editing) */body:not(.editing) .name button.drop{display:none}.name .menu button{display:block;width:100%;text-align:center;background:transparent;border:0;color:#e5e7eb;padding:.5rem .6rem;cursor:pointer}.name .menu button:hover{background:#0f1a33}.setCounter{position:absolute;right:-.35rem;top:50%;transform:translate(0,-50%);background:var(--accent);color:#061a2e;font-weight:900;border-radius:999px;padding:.18rem .62rem;min-width:2rem;text-align:center;box-shadow:0 0 10px rgba(96,165,250,.45),0 0 24px rgba(59,130,246,.35)}@media(max-width:520px){.setCounter{right:-.15rem}}.scoreBox{flex:1 1 auto;width:100%;min-height:0;display:flex;align-items:center;justify-content:center;overflow:hidden}.score{width:100%;display:flex;justify-content:center;align-items:center;text-align:center;font-weight:900;line-height:.92;cursor:pointer;white-space:nowrap;overflow:hidden;font-variant-numeric:tabular-nums;will-change:transform,text-shadow;padding:0 2vw;transition:color .6s,text-shadow .6s}.digits{display:flex;gap:.08em;align-items:baseline;max-width:100%;overflow:hidden}.digit{display:inline-block;width:1ch;text-align:center}.digit.ghost{visibility:hidden}.pop{animation:glowBurst .55s ease-out 1}.popMinus{animation:minusBurst .55s ease-out 1}@keyframes glowBurst{0%{text-shadow:0 0 0 rgba(96,165,250,0);transform:scale(1)}20%{text-shadow:0 0 30px rgba(96,165,250,.95),0 0 70px rgba(59,130,246,.8),0 0 110px rgba(37,99,235,.7);transform:scale(1.08)}60%{text-shadow:0 0 20px rgba(96,165,250,.55),0 0 50px rgba(59,130,246,.45);transform:scale(1.03)}100%{text-shadow:0 0 0 rgba(96,165,250,0);transform:scale(1)}}@keyframes minusBurst{0%{text-shadow:0 0 0 rgba(239,68,68,0);transform:scale(1)}20%{text-shadow:0 0 30px rgba(239,68,68,.95),0 0 70px rgba(239,68,68,.7),0 0 110px rgba(185,28,28,.6);transform:scale(0.96)}60%{text-shadow:0 0 20px rgba(239,68,68,.5),0 0 50px rgba(185,28,28,.4);transform:scale(0.985)}100%{text-shadow:0 0 0 rgba(239,68,68,0);transform:scale(1)}}.winner{color:#ffd700!important;animation:goldPulse 3s ease-in-out infinite}.winnerName{color:#ffd700!important;animation:goldPulse 3s ease-in-out infinite}@keyframes goldPulse{0%{text-shadow:0 0 3px rgba(255,215,0,.25),0 0 6px rgba(255,220,50,.2)}50%{text-shadow:0 0 8px rgba(255,215,0,.5),0 0 16px rgba(255,220,50,.4)}100%{text-shadow:0 0 3px rgba(255,215,0,.25),0 0 6px rgba(255,220,50,.2)}}#sets{padding:.35rem 1rem .2rem;text-align:center;font-size:1rem}#winnerMsg{padding:.4rem 1rem 0;text-align:center;font-size:clamp(1.1rem,3.5vw,2rem);color:#facc15;font-weight:900;white-space:pre-line}.summary{margin:.8rem var(--gap) 0;background:#0b1224;border:1px solid #0b1224;border-radius:.8rem;padding:1rem}.summary h3{margin:.2rem 0 .6rem 0;font-size:1.05rem}.summary table{width:100%;border-collapse:collapse}.summary th,.summary td{text-align:center;padding:.4rem .3rem;border-bottom:1px solid #1e293b}.summary tfoot td{font-weight:700}.controls{margin:1rem var(--gap) .6rem;display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap}.button{font:inherit;border:0;border-radius:.5rem;padding:.45rem .7rem;cursor:pointer;background:#243147;color:#e5e7eb;border:1px solid #32425f}.button.primary{background:#1f3a68;border-color:#35548c}.button.danger{background:#b91c1c;border-color:#7f1d1d;color:#fff}.history{margin:.8rem var(--gap) var(--gap);background:#0b1224;border:1px solid #0b1224;border-radius:.8rem;padding:1rem}.history h3{margin:.2rem 0 .6rem 0;font-size:1.05rem}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem .8rem;margin:.2rem 0 .8rem 0}.stat{background:#0f1a33;border:1px solid #122042;border-radius:.6rem;padding:.6rem .7rem;text-align:center}.muted{opacity:.85}.history table{width:100%;border-collapse:collapse}.history th,.history td{text-align:center;padding:.4rem .3rem;border-bottom:1px solid #1e293b}.history .leader{display:grid;grid-template-columns:1fr auto;gap:.35rem .6rem;align-items:center}.history .leader div{padding:.15rem .25rem;border-bottom:1px dashed #243147}.history table td.actions{white-space:nowrap}.toggleRow{display:flex;justify-content:center;margin:.4rem 0}.clickArea{position:absolute;top:0;bottom:0;width:calc(50% - var(--scrollGap));z-index:3;background:transparent;pointer-events:none}.areas-active .clickArea{pointer-events:auto;touch-action:pan-y}.clickArea.left{left:0}.clickArea.right{right:0}</style></head><body class="editing"><header><h1>üè∏ Badminton Poengteller</h1><button id="fsBtn">‚õ∂ Fullskjerm</button><div id="version">v5.18.2</div></header><div id="sets">Sett: 0-0</div><div class="wrap" id="wrap"><div class="clickArea left" id="leftArea" aria-label="Legg til poeng venstre"></div><div class="clickArea right" id="rightArea" aria-label="Legg til poeng h√∏yre"></div><div class="side left" id="sideA"><div class="name"><div class="combo"><input id="nameA" value="Spiller A" autocomplete="off" placeholder="Skriv eller velg spiller‚Ä¶"/><button class="drop" id="dropA" title="Vis lagrede navn">‚ñæ</button><div class="menu" id="menuA"></div></div><div id="setCounterA" class="setCounter" style="display:none">0</div></div><div class="scoreBox"><div class="score" id="scoreA"><span class="digits" id="A_digits"><span class="digit" id="A_tens">0</span><span class="digit" id="A_ones">0</span></span></div></div></div><div class="divider"></div><div class="side right" id="sideB"><div class="name"><div class="combo"><input id="nameB" value="Spiller B" autocomplete="off" placeholder="Skriv eller velg spiller‚Ä¶"/><button class="drop" id="dropB" title="Vis lagrede navn">‚ñæ</button><div class="menu" id="menuB"></div></div><div id="setCounterB" class="setCounter" style="display:none">0</div></div><div class="scoreBox"><div class="score" id="scoreB"><span class="digits" id="B_digits"><span class="digit" id="B_tens">0</span><span class="digit" id="B_ones">0</span></span></div></div></div></div><div id="winnerMsg"></div><div id="matchSummary" class="summary" style="display:none"><h3>Kampsammendrag</h3><div id="sumMeta" class="muted" style="margin:.2rem 0 .6rem 0"></div><table><thead><tr><th>Sett</th><th id="sumNameA">Spiller A</th><th id="sumNameB">Spiller B</th><th>Vinner</th></tr></thead><tbody id="summaryBody"></tbody><tfoot><tr><td colspan="4" id="summaryWinner"></td></tr></tfoot></table></div><div class="controls"><button id="swapBtn" class="button">Bytt side</button><button id="resetSetBtn" class="button">Nullstill sett</button><button id="newMatchBtn" class="button primary">Start ny kamp</button><button id="resetMatchBtn" class="button">Nullstill kamp</button></div><div class="toggleRow"><button id="toggleStatsBtn" class="button outline">Vis statistikk</button></div><div id="historyPanel" class="history" style="display:none"><div style="display:flex;gap:.5rem;justify-content:space-between;align-items:center"><h3>Siste 50 kamper & oversikt</h3><div style="display:flex;gap:.4rem;align-items:center"><button id="clearAllBtn" class="button danger" title="Slett alle lagrede kamper">Slett alle</button><span class="muted" id="storedCount"></span></div></div><div id="stats" class="stats"></div><div id="leaderboard"></div><div style="height:.6rem"></div><table><thead><tr><th>#</th><th>Dato</th><th>Spiller A</th><th>Spiller B</th><th>Sett</th><th>Vinner</th><th>Handling</th></tr></thead><tbody id="historyBody"></tbody></table></div><script>let scoreA=0,scoreB=0,setsA=0,setsB=0,target=21,cap=30,currentSet=1,swappedAt11=false,locked=false,swapping=false;let setHistory=[];let namesSavedThisMatch=false;const NAME_COOKIE='badm_prev_names_v2';const MAX_NAMES=8;const LONGPRESS_MS=800;const MOVE_THRESH=16;const LS_MATCHES='badm_matches_v1';const LS_LAST='badm_last_names_v1';const LS_LIVE='badm_live_v1';const $=s=>document.querySelector(s);/* ===== Navn lagring (localStorage) ===== */function loadPrevNames(){try{const raw=localStorage.getItem(NAME_COOKIE);if(!raw)return[];const arr=JSON.parse(raw);return Array.isArray(arr)?arr:[]}catch(e){return[]}}function savePrevNames(list){try{localStorage.setItem(NAME_COOKIE,JSON.stringify(list.slice(0,MAX_NAMES)))}catch(e){}}function addNamesToHistory(...names){let arr=loadPrevNames();for(const nm of names){const n=(nm||'').trim();if(!n)continue;const idx=arr.indexOf(n);if(idx!==-1)arr.splice(idx,1);arr.unshift(n)}arr=arr.slice(0,MAX_NAMES);savePrevNames(arr);renderNameMenus(arr)}function renderNameMenus(arr=loadPrevNames()){const make=(menu,input)=>{menu.innerHTML='';if(!arr.length){const em=document.createElement('div');em.className='muted';em.style.padding='.5rem';em.textContent='Ingen lagrede navn';menu.appendChild(em);return}arr.forEach(n=>{const b=document.createElement('button');b.type='button';b.textContent=n;b.addEventListener('click',()=>{input.value=n;menu.classList.remove('open')});menu.appendChild(b)})};make($('#menuA'),$('#nameA'));make($('#menuB'),$('#nameB'))}function bindNameDropdown(btn,input,menu){btn.addEventListener('click',e=>{e.stopPropagation();if(document.body.classList.contains('editing')){renderNameMenus();menu.classList.toggle('open')}});document.addEventListener('click',e=>{if(!menu.contains(e.target)&&e.target!==btn)menu.classList.remove('open')});menu.addEventListener('click',e=>e.stopPropagation())}/* ===== Sist brukte navn ===== */function saveLastNames(a,b){try{localStorage.setItem(LS_LAST,JSON.stringify([a,b]))}catch(e){}}function loadLastNames(){try{const raw=localStorage.getItem(LS_LAST);if(!raw)return null;const arr=JSON.parse(raw);return Array.isArray(arr)&&arr.length===2?arr:null}catch(e){return null}}/* ===== Live state ===== */const saveLiveState=(function(){let to=0;return function(){clearTimeout(to);to=setTimeout(()=>{try{const data={scoreA,scoreB,setsA,setsB,currentSet,swappedAt11,locked,setHistory,names:{A:$('#nameA')?.value||'Spiller A',B:$('#nameB')?.value||'Spiller B'},isALeft:$('#sideA')?.classList.contains('left')||false,winnerMsg:$('#winnerMsg')?.textContent||'',summaryVisible:document.getElementById('matchSummary')?.style.display==='block'};localStorage.setItem(LS_LIVE,JSON.stringify(data))}catch(e){}},80)}})();function clearLiveState(){try{localStorage.removeItem(LS_LIVE)}catch(e){}}function restoreLiveState(){try{const raw=localStorage.getItem(LS_LIVE);if(!raw)return false;const data=JSON.parse(raw);if(!data)return false;scoreA=data.scoreA||0;scoreB=data.scoreB||0;setsA=data.setsA||0;setsB=data.setsB||0;currentSet=data.currentSet||1;swappedAt11=!!data.swappedAt11;locked=!!data.locked;setHistory=Array.isArray(data.setHistory)?data.setHistory:[];if($('#nameA'))$('#nameA').value=data.names?.A||'Spiller A';if($('#nameB'))$('#nameB').value=data.names?.B||'Spiller B';setSidesDomTo(data.isALeft!==false);if($('#winnerMsg'))$('#winnerMsg').textContent=data.winnerMsg||'';if(data.summaryVisible){document.getElementById('matchSummary').style.display='block'}return true}catch(e){return false}}/* ===== Dom re-order for sideplassering ===== */function setSidesDomTo(isALeft){const wrap=$('#wrap'),sideA=$('#sideA'),sideB=$('#sideB'),divider=document.querySelector('.divider');if(!(wrap&&sideA&&sideB&&divider))return;const aIsLeft=sideA.classList.contains('left');if(aIsLeft===isALeft)return;wrap.classList.add('no-trans');try{if(isALeft){sideA.classList.add('left');sideA.classList.remove('right');sideB.classList.add('right');sideB.classList.remove('left');wrap.insertBefore(sideA,wrap.firstElementChild);wrap.insertBefore(divider,sideB)}else{sideB.classList.add('left');sideB.classList.remove('right');sideA.classList.add('right');sideA.classList.remove('left');wrap.insertBefore(sideB,wrap.firstElementChild);wrap.insertBefore(divider,sideA)}}catch(e){}wrap.classList.remove('no-trans')}/* ===== UI ===== */function update(){$('#sets').textContent=`Sett: ${setsA}-${setsB}`;const cA=$('#setCounterA'),cB=$('#setCounterB');cA.style.display=setsA>0?'flex':'none';cB.style.display=setsB>0?'flex':'none';if(setsA>0)cA.textContent=setsA;if(setsB>0)cB.textContent=setsB;const setDigits=(sc,p)=>{const t=Math.floor(sc/10),o=sc%10,te=$(`#${p}_tens`),oe=$(`#${p}_ones`);if(sc<10){te.textContent='0';te.classList.add('ghost')}else{te.textContent=String(t);te.classList.remove('ghost')}oe.textContent=String(o)};setDigits(scoreA,'A');setDigits(scoreB,'B');updateEditableState();saveLiveState()}function fitScores(){document.body.classList.add('measuring');const base=100,sA=$('#scoreA'),sB=$('#scoreB');if(!sA||!sB){document.body.classList.remove('measuring');return}sA.style.fontSize=base+'px';sB.style.fontSize=base+'px';const sideA=$('#sideA'),sideB=$('#sideB'),nameAH=$('#sideA .name')?.offsetHeight||0,nameBH=$('#sideB .name')?.offsetHeight||0,sidePad=e=>{const cs=getComputedStyle(e);return(parseFloat(cs.paddingTop)||0)+(parseFloat(cs.paddingBottom)||0)},availHA=Math.max(40,(sideA?.clientHeight||0)-nameAH-(sideA?sidePad(sideA):0)),availHB=Math.max(40,(sideB?.clientHeight||0)-nameBH-(sideB?sidePad(sideB):0)),boxA=$('#sideA .scoreBox'),boxB=$('#sideB .scoreBox'),padX=e=>{const cs=getComputedStyle(e);return(parseFloat(cs.paddingLeft)||0)+(parseFloat(cs.paddingRight)||0)},availWA=Math.max(40,(boxA?.clientWidth||0)-padX(sA)),availWB=Math.max(40,(boxB?.clientWidth||0)-padX(sB)),aRect=$('#A_digits')?.getBoundingClientRect(),bRect=$('#B_digits')?.getBoundingClientRect();if(!aRect||!bRect){document.body.classList.remove('measuring');return}const scaleA=Math.min(availWA/Math.max(1,aRect.width),availHA/Math.max(1,aRect.height)),scaleB=Math.min(availWB/Math.max(1,bRect.width),availHB/Math.max(1,bRect.height)),scale=Math.max(.01,Math.min(scaleA,scaleB)),f=Math.floor(base*scale);sA.style.fontSize=f+'px';sB.style.fontSize=f+'px';document.body.classList.remove('measuring');saveLiveState()}function bumpPlus(el){el.classList.remove('pop');void el.offsetWidth;el.classList.add('pop');setTimeout(()=>el.classList.remove('pop'),550)}function bumpMinus(el){el.classList.remove('popMinus');void el.offsetWidth;el.classList.add('popMinus');setTimeout(()=>el.classList.remove('popMinus'),550)}function updateEditableState(){const nameA=$('#nameA'),nameB=$('#nameB');const editable=(scoreA===0&&scoreB===0&&setsA===0&&setsB===0&&currentSet===1&&!locked);nameA.disabled=!editable;nameB.disabled=!editable;document.body.classList.toggle('editing',editable);document.body.classList.toggle('areas-active',!editable);if(!editable){$('#menuA')?.classList.remove('open');$('#menuB')?.classList.remove('open')}}function clearWinner(){['#scoreA','#scoreB'].forEach(sel=>$(sel)?.classList.remove('winner'));['#nameA','#nameB'].forEach(sel=>$(sel)?.classList.remove('winnerName'))}/* ===== Poeng ===== */function maybeSaveNamesOnStart(){if(namesSavedThisMatch)return;const editable=(scoreA===0&&scoreB===0&&setsA===0&&setsB===0&&currentSet===1&&!locked);if(!editable){const nA=$('#nameA')?.value||'Spiller A';const nB=$('#nameB')?.value||'Spiller B';addNamesToHistory(nA,nB);saveLastNames(nA,nB);namesSavedThisMatch=true}}function addPointByPosition(pos){if(locked||swapping)return;const el=pos==='left'?document.querySelector('.side.left'):document.querySelector('.side.right');if(!el)return;const isA=el.id==='sideA';addPoint(isA?'A':'B')}function addPoint(s){if(locked||swapping)return;if(s==='A')scoreA++;else scoreB++;maybeSaveNamesOnStart();checkSetEnd();update();bumpPlus($(s==='A'?'#scoreA':'#scoreB'));fitScores()}function removePoint(s){if(locked||swapping)return;if(s==='A'&&scoreA>0)scoreA--;if(s==='B'&&scoreB>0)scoreB--;update();bumpMinus($(s==='A'?'#scoreA':'#scoreB'));fitScores()}function removePointByPosition(pos){if(locked||swapping)return;const el=pos==='left'?document.querySelector('.side.left'):document.querySelector('.side.right');if(!el)return;const isA=el.id==='sideA';removePoint(isA?'A':'B')}/* ===== Sett/kamp ===== */function fmtDate(ts){const d=new Date(ts);return d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}function pushSetToHistory(a,b){setHistory.push({set:currentSet,a,b,winner:a>b?'A':(b>a?'B':'-')});saveLiveState()}function renderSummary(finalWinner){const box=$('#matchSummary');const body=$('#summaryBody');const nA=$('#nameA')?.value||'Spiller A';const nB=$('#nameB')?.value||'Spiller B';$('#sumNameA').textContent=nA;$('#sumNameB').textContent=nB;$('#sumMeta').textContent=`Spilt: ${fmtDate(Date.now())}`;body.innerHTML='';setHistory.forEach(row=>{const tr=document.createElement('tr');const tdSet=document.createElement('td');tdSet.textContent=String(row.set);const tdA=document.createElement('td');tdA.textContent=String(row.a);const tdB=document.createElement('td');tdB.textContent=String(row.b);const tdW=document.createElement('td');tdW.textContent=row.winner==='A'?nA:(row.winner==='B'?nB:'‚Äî');tr.append(tdSet,tdA,tdB,tdW);body.appendChild(tr)});$('#summaryWinner').textContent=`Kampvinner: ${finalWinner}`;box.style.display='block';saveLiveState()}function checkSetEnd(){const lead=Math.abs(scoreA-scoreB);if((scoreA>=target||scoreB>=target)&&(lead>=2||scoreA===cap||scoreB===cap)){pushSetToHistory(scoreA,scoreB);if(scoreA>scoreB)setsA++;else setsB++;if(setsA===2||setsB===2){const nameA=$('#nameA')?.value||'Spiller A',nameB=$('#nameB')?.value||'Spiller B',winner=setsA===2?nameA:nameB,loser=setsA===2?nameB:nameA;$('#winnerMsg').textContent=`üéâ GRATULERER ${winner.toUpperCase()}! DU VANT KAMPEN!\nüëè BRA JOBBA ${loser.toUpperCase()}, DU GJORDE DITT BESTE.`;if(setsA===2){$('#scoreA').classList.add('winner');$('#nameA').classList.add('winnerName')}else{$('#scoreB').classList.add('winner');$('#nameB').classList.add('winnerName')}locked=true;document.body.classList.remove('areas-active');renderSummary(winner);saveMatchToHistory();return}scoreA=0;scoreB=0;currentSet++;swappedAt11=false;startVisualSwap()}if(currentSet===3&&!swappedAt11&&(scoreA===11||scoreB===11)){startVisualSwap();swappedAt11=true}saveLiveState()}/* ===== Historikk & statistikk ===== */function computeStats(arr){const stats={matches:arr.length,sets:0,straight:0,three:0,deuceSets:0,avgMargin:0,maxTotalSet:null};let marginSum=0;arr.forEach(m=>{const sets=m.sets||[];stats.sets+=sets.length;const score=[0,0];sets.forEach(s=>{const a=+s.a||0,b=+s.b||0;score[a>b?0:1]++;const total=a+b;const margin=Math.abs(a-b);marginSum+=margin;if(a>=20&&b>=20)stats.deuceSets++;if(!stats.maxTotalSet||total>(stats.maxTotalSet.a+stats.maxTotalSet.b))stats.maxTotalSet={a,b,names:m.names}});if(score[0]===2||score[1]===2)stats.straight++;else stats.three++});stats.avgMargin=stats.sets?(marginSum/stats.sets):0;return stats}function loadMatches(){try{const raw=localStorage.getItem(LS_MATCHES);if(!raw)return[];const arr=JSON.parse(raw);return Array.isArray(arr)?arr:[]}catch(e){return[]}}function saveMatches(list){try{localStorage.setItem(LS_MATCHES,JSON.stringify(list.slice(0,50)))}catch(e){}}function saveMatchToHistory(){const nA=$('#nameA')?.value||'Spiller A';const nB=$('#nameB')?.value||'Spiller B';const winner=setsA===2?nA:nB;const obj={ts:Date.now(),names:{A:nA,B:nB},sets:setHistory.slice(),winner};let arr=loadMatches();arr.unshift(obj);arr=arr.slice(0,50);saveMatches(arr);saveLastNames(nA,nB);addNamesToHistory(nA,nB);renderHistory();clearLiveState()}function deleteMatch(idx){let arr=loadMatches();if(idx<0||idx>=arr.length)return;arr.splice(idx,1);saveMatches(arr);renderHistory()}function clearAllMatches(){if(!confirm('Slette ALLE lagrede kamper?'))return;saveMatches([]);renderHistory()}function renderStats(arr){const s=computeStats(arr);const el=$('#stats');el.innerHTML='';const card=(label,val)=>{const d=document.createElement('div');d.className='stat';d.innerHTML=`<div class="muted" style="font-size:.8rem">${label}</div><div style="font-size:1.15rem;font-weight:700">${val}</div>`;return d};el.append(card('Kamper lagret',s.matches),card('Sett spilt',s.sets),card('2‚Äì0-kamper',s.straight),card('3-settskamper',s.three),card('Deuce-sett (‚â•20‚Äì20)',`${s.deuceSets}`),card('Snitt seiersmargin/sett',s.avgMargin.toFixed(2)));if(s.maxTotalSet){const {a,b}=s.maxTotalSet;el.append(card('H√∏yest poengsum i sett',`${a}-${b}`))}}function renderHistory(){const panel=$('#historyPanel');const arr=loadMatches();$('#storedCount').textContent=`${arr.length} lagret`;if(!arr.length){panel.style.display='none';return}panel.style.display='block';renderStats(arr);const winMap=new Map();arr.forEach(m=>{winMap.set(m.winner,(winMap.get(m.winner)||0)+1)});const leaderDiv=$('#leaderboard');leaderDiv.innerHTML='<h4 style="margin:.2rem 0 .4rem 0">Seiersoversikt</h4>';const leaderList=[...winMap.entries()].sort((a,b)=>b[1]-a[1]);const cont=document.createElement('div');cont.className='leader';leaderList.forEach(([name,count])=>{const n=document.createElement('div');n.textContent=name;const c=document.createElement('div');c.textContent=count;cont.append(n,c)});if(!leaderList.length){const p=document.createElement('div');p.textContent='Ingen lagrede kamper enn√•.';leaderDiv.appendChild(p)}else{leaderDiv.appendChild(cont)}const body=$('#historyBody');body.innerHTML='';arr.forEach((m,i)=>{const tr=document.createElement('tr');const tdIdx=document.createElement('td');tdIdx.textContent=String(i+1);const tdDate=document.createElement('td');tdDate.textContent=fmtDate(m.ts);const tdA=document.createElement('td');tdA.textContent=m.names.A;const tdB=document.createElement('td');tdB.textContent=m.names.B;const tdSets=document.createElement('td');tdSets.textContent=(m.sets||[]).map(s=>`${s.a}-${s.b}`).join(' , ');const tdW=document.createElement('td');tdW.textContent=m.winner;const tdAct=document.createElement('td');tdAct.className='actions';const del=document.createElement('button');del.className='button outline';del.textContent='Slett';del.addEventListener('click',()=>deleteMatch(i));tdAct.append(del);tr.append(tdIdx,tdDate,tdA,tdB,tdSets,tdW,tdAct);body.appendChild(tr)})}/* ===== Bytte-animasjon ===== */function startVisualSwap(){if(swapping)return;swapping=true;document.body.classList.add('input-locked');const wrap=$('#wrap'),left=$('.side.left'),right=$('.side.right'),divider=document.querySelector('.divider');if(!(wrap instanceof Node)||!(left instanceof Node)||!(right instanceof Node)||!(divider instanceof Node)){swapping=false;document.body.classList.remove('input-locked');return}wrap.classList.add('swap-go');let finished=false;const complete=()=>{if(finished)return;finished=true;left.removeEventListener('transitionend',onEnd);right.removeEventListener('transitionend',onEnd);try{wrap.classList.add('no-trans');wrap.insertBefore(right,left);if(divider.parentNode!==wrap)wrap.appendChild(divider);wrap.insertBefore(divider,left);left.classList.remove('left');left.classList.add('right');right.classList.remove('right');right.classList.add('left')}catch(err){}wrap.classList.remove('swap-go');void wrap.offsetWidth;wrap.classList.remove('no-trans');update();fitScores();swapping=false;document.body.classList.remove('input-locked');saveLiveState()};const onEnd=e=>{if(e.target!==left&&e.target!==right)return;complete()};left.addEventListener('transitionend',onEnd);right.addEventListener('transitionend',onEnd);setTimeout(complete,1200)}function swapSides(){startVisualSwap()}/* ===== Reset ===== */function resetSet(){if(locked||swapping)return;scoreA=0;scoreB=0;swappedAt11=false;$('#winnerMsg').textContent='';clearWinner();setHistory=[];update();fitScores()}function resetMatch(){scoreA=0;scoreB=0;setsA=0;setsB=0;currentSet=1;swappedAt11=false;locked=false;setHistory=[];$('#winnerMsg').textContent='';$('#matchSummary').style.display='none';clearWinner();namesSavedThisMatch=false;update();fitScores()}function startNewMatch(){resetMatch();const last=loadLastNames();if(last){$('#nameA').value=last[0];$('#nameB').value=last[1]}const nA=$('#nameA').value||'Spiller A';const nB=$('#nameB').value||'Spiller B';addNamesToHistory(nA,nB);saveLastNames(nA,nB);renderNameMenus();clearLiveState()}/* ===== Fullskjerm ===== */function toggleFullscreen(){const btn=$('#fsBtn');if(!document.fullscreenElement){document.documentElement.requestFullscreen();if(btn)btn.textContent='‚§¢ Avslutt fullskjerm'}else{document.exitFullscreen();if(btn)btn.textContent='‚õ∂ Fullskjerm'}}/* ===== Langtrykk: ett ‚àí1, med haptikk ===== */function bindLongPressOne(el,action){let tid=0,px=0,py=0,down=false,done=false,scrollY0=0;const vibrate=m=>{try{navigator.vibrate&&navigator.vibrate(m)}catch(_){} };const start=(x,y)=>{down=true;done=false;px=x;py=y;scrollY0=window.scrollY;const onScroll=()=>{if(!down)return;cancel()};window.addEventListener('scroll',onScroll,{passive:true,once:true});tid=setTimeout(()=>{if(!down||done)return;done=true;action();vibrate(60)},LONGPRESS_MS)};const cancel=()=>{down=false;clearTimeout(tid)};el.addEventListener('pointerdown',e=>{if(e.pointerType==='mouse'&&e.button!==0)return;el.setPointerCapture?.(e.pointerId);start(e.clientX,e.clientY)},{passive:true});el.addEventListener('pointermove',e=>{if(!down)return;if(Math.hypot(e.clientX-px,e.clientY-py)>MOVE_THRESH||Math.abs(window.scrollY-scrollY0)>2)cancel()},{passive:true});['pointerup','pointercancel','pointerleave','lostpointercapture','blur'].forEach(ev=>el.addEventListener(ev,cancel,{passive:true}))}function bindTap(el,action){el.addEventListener('click',()=>action())}/* ===== Stats toggle ===== */function toggleStats(){const p=$('#historyPanel');const b=$('#toggleStatsBtn');const vis=p.style.display!=='none';p.style.display=vis?'none':'block';b.textContent=vis?'Vis statistikk':'Skjul statistikk'}/* ===== Init ===== */window.addEventListener('DOMContentLoaded',()=>{const restored=restoreLiveState();if(!restored){const last=loadLastNames();if(last){$('#nameA').value=last[0];$('#nameB').value=last[1]}}renderNameMenus();bindNameDropdown($('#dropA'),$('#nameA'),$('#menuA'));bindNameDropdown($('#dropB'),$('#nameB'),$('#menuB'));bindTap($('#scoreA'),()=>addPoint('A'));bindTap($('#scoreB'),()=>addPoint('B'));bindLongPressOne($('#scoreA'),()=>removePoint('A'));bindLongPressOne($('#scoreB'),()=>removePoint('B'));bindTap($('#leftArea'),()=>addPointByPosition('left'));bindTap($('#rightArea'),()=>addPointByPosition('right'));bindLongPressOne($('#leftArea'),()=>removePointByPosition('left'));bindLongPressOne($('#rightArea'),()=>removePointByPosition('right'));$('#swapBtn')?.addEventListener('click',swapSides);$('#resetSetBtn')?.addEventListener('click',resetSet);$('#newMatchBtn')?.addEventListener('click',startNewMatch);$('#resetMatchBtn')?.addEventListener('click',resetMatch);$('#fsBtn')?.addEventListener('click',toggleFullscreen);document.getElementById('clearAllBtn')?.addEventListener('click',clearAllMatches);document.getElementById('toggleStatsBtn')?.addEventListener('click',toggleStats);renderHistory();update();queueFit()});const queueFit=(()=>{let raf=0,t=0;return function(){cancelAnimationFrame(raf);clearTimeout(t);raf=requestAnimationFrame(()=>{fitScores();t=setTimeout(fitScores,60)})}})();window.addEventListener('resize',queueFit);document.addEventListener('fullscreenchange',queueFit);if(window.visualViewport){visualViewport.addEventListener('resize',queueFit)}window.addEventListener('orientationchange',()=>{setTimeout(queueFit,60)});window.addEventListener('beforeunload',saveLiveState);/* expose */window.addPoint=addPoint;window.removePoint=removePoint;window.swapSides=swapSides;window.resetSet=resetSet;window.resetMatch=resetMatch;window.startNewMatch=startNewMatch;window.toggleFullscreen=toggleFullscreen;</script></body></html>
