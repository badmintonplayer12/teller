<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Badminton Poengteller</title>
  <style>
    :root{ --vh: 1vh; }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";background:#0f172a;color:#fff;display:flex;flex-direction:column;height:100%;}
    header{background:#1f2937;padding:.5rem 1rem;display:flex;align-items:center;gap:1rem;justify-content:space-between}
    header h1{font-size:1rem;margin:0}
    .wrap{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}
    .side{background:#111827;border-radius:.8rem;padding:1rem;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
    .name{font-size:1.2rem;margin-bottom:.5rem}
    .name input{font:inherit;color:#e5e7eb;background:#1f2937;border:1px solid #0008;border-radius:.4rem;padding:.25rem .5rem;text-align:center;width:100%}

    /* Tall: Vi styrer font-st√∏rrelsen i JS for stabil h√∏yde og bredde.  */
    .score{width:100%; text-align:center; font-weight:900; line-height:0.92; cursor:pointer; user-select:none; -webkit-user-select:none; white-space:nowrap; overflow:hidden;
           font-variant-numeric: tabular-nums;}
    .score::selection{background:transparent}

    .minusBtn{margin-top:.75rem;font-size:1.4rem;padding:.6rem 1rem;border-radius:.6rem;border:0;background:#ef4444;color:#fff;cursor:pointer}

    footer{background:#1f2937;padding:.6rem 1rem;display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap}
    footer button{padding:.6rem 1rem;border-radius:.6rem;border:0;cursor:pointer}

    #sets{padding:.6rem 1rem;text-align:center;font-size:1.2rem}
    #winnerMsg{padding:1rem 1rem 0;text-align:center;font-size:clamp(1.2rem,3.5vw,2rem);color:#facc15;font-weight:900;white-space:pre-line}

    .setCounter{position:absolute;top:.5rem;right:.5rem;background:#22c55e;color:#06210f;font-weight:900;border-radius:50%;width:2rem;height:2rem;display:flex;align-items:center;justify-content:center}

    /* Trykk-animasjon p√• tallene */
    @keyframes pop { 0%{transform:scale(1);text-shadow:none;} 45%{transform:scale(1.08);text-shadow:0 0 18px rgba(250,204,21,.35);} 100%{transform:scale(1);text-shadow:none;} }
    .score.pop { animation: pop 180ms ease-out; }

    /* L√•s interaksjoner n√•r kampen er ferdig + mindre tall for plass til gratulasjon */
    .final .score, .final .minusBtn { pointer-events:none; opacity:.85 }
    #newMatchBtn{display:none;background:#22c55e;color:#06210f;font-weight:900}
    .final #newMatchBtn{display:inline-block}

    /* M√•lespan skjules, brukes for √• beregne fontst√∏rrelse */
    #measure{position:absolute;left:-9999px;top:-9999px;visibility:hidden;white-space:nowrap;font-weight:900;line-height:0.92;font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <header>
    <h1>üè∏ Badminton Poengteller</h1>
    <button id="fsBtn" onclick="toggleFullscreen()">‚õ∂ Fullskjerm</button>
  </header>

  <div id="sets">Sett: 0‚Äì0</div>

  <div class="wrap">
    <div class="side" id="sideA">
      <div id="setCounterA" class="setCounter" style="display:none">0</div>
      <div class="name"><input id="nameA" value="Spiller A" /></div>
      <div class="score" id="scoreA" onclick="addPoint('A')">0</div>
      <button class="minusBtn" onclick="removePoint('A')">‚àí1</button>
    </div>

    <div class="side" id="sideB">
      <div id="setCounterB" class="setCounter" style="display:none">0</div>
      <div class="name"><input id="nameB" value="Spiller B" /></div>
      <div class="score" id="scoreB" onclick="addPoint('B')">0</div>
      <button class="minusBtn" onclick="removePoint('B')">‚àí1</button>
    </div>
  </div>

  <div id="winnerMsg"></div>

  <footer>
    <button onclick="swapSides()">Bytt side</button>
    <button onclick="resetSet()">Nullstill sett</button>
    <button id="newMatchBtn" onclick="startNewMatch()">Start ny kamp</button>
    <button onclick="resetMatch()">Nullstill kamp</button>
  </footer>

  <!-- skjult m√•leelement for font-beregning -->
  <span id="measure">88</span>

  <script>
    // --- Viewport-h√∏yde fix for mobil ---
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    setVH(); window.addEventListener('resize', ()=>{ setVH(); resizeScores(); });

    // --- Tilstand ---
    let scoreA=0, scoreB=0;
    let setsA=0, setsB=0;
    const target=21, cap=30;
    let currentSet=1;           // 1, 2, 3
    let swappedAt11=false;      // i sett 3 ‚Äì bytt kun √©n gang ved 11
    let locked=false;           // l√•s poeng etter kamp-slutt

    // --- UI-oppdatering ---
    function update(){
      document.getElementById('scoreA').textContent=scoreA;
      document.getElementById('scoreB').textContent=scoreB;
      document.getElementById('sets').textContent=`Sett: ${setsA}‚Äì${setsB}`;
      const counterA=document.getElementById('setCounterA');
      const counterB=document.getElementById('setCounterB');
      if(setsA>0){counterA.style.display='flex';counterA.textContent=setsA;}else counterA.style.display='none';
      if(setsB>0){counterB.style.display='flex';counterB.textContent=setsB;}else counterB.style.display='none';
      resizeScores();
    }

    // --- Beregn fontst√∏rrelse slik at to siffer ("88") alltid f√•r plass ---
    function resizeScores(){
      const sideA = document.getElementById('sideA');
      const sideB = document.getElementById('sideB');
      const sA = document.getElementById('scoreA');
      const sB = document.getElementById('scoreB');
      const meas = document.getElementById('measure');

      const vwHalf = sideA.clientWidth; // ~50% av skjermen
      const maxVhPct = document.body.classList.contains('final') ? 35 : 70; // 70% h√∏yde normalt, 35% i finale
      const maxH = Math.floor(window.innerHeight * (maxVhPct/100));

      // M√•l med baseFont px og skaler
      const baseFont = 100; // px
      meas.style.fontSize = baseFont + 'px';
      const wBase = meas.getBoundingClientRect().width; // bredde av "88"
      const hBase = meas.getBoundingClientRect().height; // h√∏yde av "88"
      if(!wBase || !hBase) return;

      // Skaler slik at b√•de h√∏yde og bredde-krav ivaretas
      const sizeByWidth = vwHalf / wBase * baseFont; // s√• "88" f√•r plass i halve skjermen
      const sizeByHeight = maxH / hBase * baseFont;  // s√• h√∏yden er <= 70%/35% av skjermen
      const sizePx = Math.floor(Math.min(sizeByWidth, sizeByHeight));

      sA.style.fontSize = sizePx + 'px';
      sB.style.fontSize = sizePx + 'px';
    }

    // Hjelpefunksjon for trykk-animasjon
    function bump(el){ el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop'); }

    // --- Poengh√•ndtering ---
    function addPoint(side){
      if(locked) return; // l√•st etter kamp-slutt
      if(side==='A') scoreA++; else scoreB++;
      checkSetEnd();
      update();
      bump(document.getElementById(side==='A' ? 'scoreA' : 'scoreB'));
    }
    function removePoint(side){
      if(locked) return; // l√•st etter kamp-slutt
      if(side==='A' && scoreA>0) scoreA--; if(side==='B' && scoreB>0) scoreB--;
      update();
    }

    // --- Sett/kamp-logikk ---
    function checkSetEnd(){
      const lead=Math.abs(scoreA-scoreB);
      // Sett ferdig?
      if((scoreA>=target||scoreB>=target)&&(lead>=2||scoreA===cap||scoreB===cap)){
        if(scoreA>scoreB) setsA++; else setsB++;
        // Kamp ferdig? (best av 3)
        if(setsA===2||setsB===2){
          const nameA=document.getElementById('nameA').value;
          const nameB=document.getElementById('nameB').value;
          const matchWinner=setsA===2?nameA:nameB;
          const matchLoser=setsA===2?nameB:nameA;
          document.getElementById('winnerMsg').textContent=`üéâ GRATULERER ${matchWinner.toUpperCase()}! DU VANT KAMPEN!\nüëè BRA JOBBA ${matchLoser.toUpperCase()}, DU GJORDE DITT BESTE.`;
          document.body.classList.add('final');
          locked=true; // l√•s poengtrykk
          resizeScores(); // gj√∏r tallene mindre i finalemodus
          return; // ikke start nytt sett n√•r kampen er ferdig
        }
        // Nullstill poeng for nytt sett og bytt side
        scoreA=0;scoreB=0;
        currentSet++;
        swappedAt11=false;
        swapSides();
      }
      // I tredje sett: bytt side ved 11 poeng (kun √©n gang)
      if(currentSet===3 && !swappedAt11 && (scoreA===11 || scoreB===11)){
        swapSides();
        swappedAt11=true;
      }
    }

    // --- Verkt√∏y ---
    function swapSides(){
      // bytt navn
      const nameA=document.getElementById('nameA');
      const nameB=document.getElementById('nameB');
      const tmpName=nameA.value; nameA.value=nameB.value; nameB.value=tmpName;
      // bytt score
      const tmpScore=scoreA; scoreA=scoreB; scoreB=tmpScore;
      // bytt sett-teller
      const tmpSets=setsA; setsA=setsB; setsB=tmpSets;
      update();
    }

    function resetSet(){
      if(locked) return; // ikke la dem rote etter kamp-slutt
      scoreA=0;scoreB=0; swappedAt11=false; document.getElementById('winnerMsg').textContent=''; update();
    }

    function resetMatch(){
      scoreA=0;scoreB=0;setsA=0;setsB=0;currentSet=1; swappedAt11=false; locked=false; document.getElementById('winnerMsg').textContent=''; document.body.classList.remove('final'); update();
    }

    function startNewMatch(){ resetMatch(); }

    // --- Fullskjerm ---
    function toggleFullscreen(){
      const btn=document.getElementById('fsBtn');
      if(!document.fullscreenElement){
        document.documentElement.requestFullscreen();
        if(btn) btn.textContent='‚§¢ Avslutt fullskjerm';
      } else {
        document.exitFullscreen();
        if(btn) btn.textContent='‚õ∂ Fullskjerm';
      }
    }

    // --- Tester ---
    function runTests(){
      const log=(ok,msg)=>console[ok?'log':'error'](ok?'‚úÖ '+msg:'‚ùå '+msg);
      try{
        // Test 1: toggleFullscreen finnes
        log(typeof toggleFullscreen==='function','toggleFullscreen er definert');
        // Test 2: bredde endres ikke n√•r vi g√•r fra 9 -> 10
        resetMatch();
        const el=document.getElementById('scoreA');
        scoreA=9; update(); const w9=el.getBoundingClientRect().width;
        scoreA=10; update(); const w10=el.getBoundingClientRect().width;
        log(Math.abs(w9-w10) < 1.5, 'Bredden for scoreA er stabil fra 1- til 2-sifret');
        // Test 3: h√∏yden ~70% av skjermen (toleranse)
        resetMatch(); update();
        const h = el.getBoundingClientRect().height;
        const targetH = Math.round(window.innerHeight*0.70);
        log(h <= targetH+8, 'H√∏yden er ‚â§ 70% av skjermen');
        // Test 4: final-l√•s
        scoreA=21; checkSetEnd(); // A vinner 1. sett
        scoreA=21; checkSetEnd(); // A vinner 2. sett -> kamp slutt
        const before=scoreA; addPoint('A'); const after=scoreA;
        log(before===after && document.body.classList.contains('final'),'L√•ser poeng etter kamp-slutt');
      }catch(e){ console.error('Tester feilet:', e); }
    }

    // Init
    update();
  </script>
</body>
</html>
