<!DOCTYPE html> 
<html lang="no">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Badminton Poengteller</title>
<link rel="stylesheet" href="./css/base.css">
<link rel="stylesheet" href="./css/layout.css">
<link rel="stylesheet" href="./css/modal.css">
<link rel="stylesheet" href="./css/stats.css">
<link rel="stylesheet" href="./css/splash.css">
<link rel="stylesheet" href="./css/share.css">
<link rel="stylesheet" href="./css/tournament.css">
<!--
vNext highlights
- RTDB path: games/<gameId> (no UID in URL). hostUid stored once, validated by rules.
- Anonymous Firebase auth; spectator needs only ?mode=spectator&game=ID
- Reliable realtime (ref.on('value') for spectator, throttled ref.set for control) + presence flag
- Play gate + separate, clean "Rediger navn" modal (with recent-name dropdowns)
- Long-press-to-decrement w/ suppression (no accidental +1 on mouse-up, Chrome/Win fix)
- Stats view toggle; QR share (qrcodejs) w/ copy/share; clear local storage; kebab pulse hint
- Scrollbars hidden in match view; autoscale digits; glow animations; set swap & autoswap @11 in set 3
-->

<style>
/* Prevent splash from showing at all for match URLs - pure CSS solution */
body[data-match-mode] {
  overflow: visible !important;
}

body[data-match-mode] #splashMask {
  display: none !important;
}

/* Ultra-aggressive fallback */
body.splash-open.no-splash {
  overflow: visible !important;
}

body.splash-open.no-splash #splashMask {
  display: none !important;
}
</style>
</head>
<body class="splash-open">

<script data-match-url data-hide-splash>
// Early router: Hide splash immediately for direct match links
(function(){
  try {
    var params = new URL(location.href).searchParams;
    var mode = params.get('mode');
    var game = params.get('game');
    
    if (mode && game && (mode === 'spectator' || mode === 'counter' || mode === 'cocounter')) {
      // ULTRA-AGGRESSIVE: Set data attribute BEFORE any DOM manipulation
      document.body.setAttribute('data-match-mode', mode);
      
      // Remove splash classes and hide mask immediately
      document.body.classList.remove('splash-open');
      document.body.classList.add('no-splash');
      
      var splashMask = document.getElementById('splashMask');
      if (splashMask) {
        splashMask.style.display = 'none';
        splashMask.classList.remove('show');
        splashMask.setAttribute('aria-hidden', 'true');
      }
      
      // Triple backup: Ensure splash stays hidden
      document.addEventListener('DOMContentLoaded', function() {
        var splashMask = document.getElementById('splashMask');
        if (splashMask) {
          splashMask.style.display = 'none';
          splashMask.classList.remove('show');
          splashMask.setAttribute('aria-hidden', 'true');
        }
      });
    }
  } catch(e) {
    // Ignore errors in URL parsing
  }
})();
</script>

<div id="sets" aria-live="polite">Sett: 0-0</div>

  <div id="splashMask" class="splashMask show" aria-hidden="false">
    <div class="splashPanel" role="dialog" aria-labelledby="splashTitle" aria-modal="true">
      <h1 id="splashTitle" class="splashTitle">Velg kampoppsett</h1>
      <p class="splashLead">Velg format før du starter</p>
      <div class="splashGroup" role="group" aria-label="Spillform">
        <button type="button" class="splashToggle active" data-discipline="single" aria-pressed="true">Singel</button>
        <button type="button" class="splashToggle" data-discipline="double" aria-pressed="false">Dobbel</button>
      </div>
      <div class="splashGroup" role="group" aria-label="Kampmodus">
        <button type="button" class="splashToggle active" data-mode="singleMatch" aria-pressed="true">Enkeltkamp</button>
        <button type="button" class="splashToggle" data-mode="tournament" aria-pressed="false">Turnering</button>
      </div>
      <button type="button" id="splashStartBtn" class="splashStart">Start</button>
      <button type="button" id="splashContinueBtn" class="splashContinue" style="display:none">Fortsett pågående kamp</button>
    </div>
  </div>

<div id="tournamentMask" class="modalMask fullscreen" style="display:none" aria-hidden="true">
  <div class="modalPanel fullscreenPanel tournamentSetupPanel" role="dialog" aria-labelledby="tournamentTitle" aria-modal="true">
    <header>
      <div class="panelTop">
        <h2 id="tournamentTitle">Sett opp turnering</h2>
        <div class="panelActions">
          <button id="tournamentClose" class="closeBtn" aria-label="Lukk">×</button>
        </div>
      </div>
    </header>
    <div class="panelBody">
      <label class="tournamentLabel" for="tournamentName">Turneringsnavn</label>
      <input id="tournamentName" class="tournamentNameInput" placeholder="Turneringsnavn" autocomplete="off"/>
      <div class="tournamentSection">
        <div class="participantsHeader">
          <h3>Deltakere</h3>
          <button type="button" id="tournamentAddParticipant" class="btn btn--primary addParticipantBtn">Legg til deltaker</button>
        </div>
        <ul id="tournamentParticipants" class="participantsList"></ul>
      </div>
    </div>
    <footer>
      <button id="tournamentBack" class="btn btn--ghost">Tilbake</button>
      <button id="tournamentContinue" class="btn btn--primary" disabled>Fortsett</button>
    </footer>
  </div>
</div>

<!-- Tournament Overview Modal -->
<div id="tournamentOverviewMask" class="modalMask fullscreen" style="display:none" aria-hidden="true">
  <div class="modalPanel fullscreenPanel tournamentOverviewPanel" role="dialog" aria-labelledby="tournamentOverviewTitle">
    <header>
      <div class="panelTop">
        <h2 id="tournamentOverviewTitle">Turnering: <span id="tournamentOverviewName"></span></h2>
        <div class="panelActions">
          <button id="tournamentOverviewClose" class="closeBtn" aria-label="Lukk">×</button>
          <button id="tournamentOverviewBack" class="btn btn--ghost">Tilbake</button>
        </div>
      </div>
    </header>
    <div class="panelBody">
      <h3>Kamp-oversikt</h3>
      <div id="tournamentRounds" class="tournamentRounds"></div>
    </div>
    <footer>
      <button id="tournamentOverviewStart" class="btn btn--primary">Start første kamp</button>
    </footer>
  </div>
</div>

<!-- Stats Modal -->
<div id="statsMask" class="modalMask fullscreen" style="display:none" aria-hidden="true">
  <div class="modalPanel fullscreenPanel statsPanel" role="dialog" aria-labelledby="statsTitle">
    <header>
      <div class="panelTop">
        <h2 id="statsTitle">Statistikk</h2>
        <div class="panelActions">
          <button id="statsClose" class="closeBtn" aria-label="Lukk">×</button>
        </div>
      </div>
    </header>
    <div class="panelBody" id="statsPanelBody">
      <!-- Stats content will be rendered here -->
    </div>
  </div>
</div>

<div class="wrap" id="wrap">
  <div class="clickArea left" id="leftArea" aria-label="Legg til poeng venstre"></div>
  <div class="clickArea right" id="rightArea" aria-label="Legg til poeng høyre"></div>

  <div class="side left" id="sideA">
    <div class="name"><div class="chip"><span id="nameA_chip">Spiller A</span></div><div id="setCounterA" class="setCounter">0</div></div>
    <div class="scoreBox"><div class="score" id="scoreA"><span class="digits" id="A_digits"><span class="digit" id="A_tens">0</span><span class="digit" id="A_ones">0</span></span></div></div>
  </div>

  <div class="divider"></div>

  <div class="side right" id="sideB">
    <div class="name"><div class="chip"><span id="nameB_chip">Spiller B</span></div><div id="setCounterB" class="setCounter">0</div></div>
    <div class="scoreBox"><div class="score" id="scoreB"><span class="digits" id="B_digits"><span class="digit" id="B_tens">0</span><span class="digit" id="B_ones">0</span></span></div></div>
  </div>
</div>

<!-- Summary Actions -->
<div class="summaryActions">
  <button id="showSummaryBtn" class="summaryBtn" style="display:none">
    📊 Vis kampsammendrag
  </button>
  <button id="btnFinishMatch" class="summaryBtn finishBtn" style="display:none">
    ✅ Ferdigstill kamp
  </button>
</div>

<!-- Next Set Button (control only) -->
<button id="nextSetBtn" class="summaryBtn" style="display:none">
  ▶ Neste sett
</button>

<!-- Match Summary Modal -->
<div id="summaryMask" class="modalMask" style="display:none">
  <div class="modalBox summaryModal">
    <div class="modalHeader">
      <h2>🏆 Kamp ferdig!</h2>
      <button id="summaryClose" class="closeBtn" aria-label="Lukk">×</button>
    </div>
    
    <div class="modalContent">
      <div id="summaryWinner" class="winnerAnnouncement"></div>
      
      <div class="summaryTable">
  <h3>Kampsammendrag <span id="summaryFormat" class="format-indicator"></span></h3>
  <table>
          <thead>
            <tr>
              <th>Sett</th>
              <th id="sumNameA">Spiller A</th>
              <th id="sumNameB">Spiller B</th>
              <th>Vinner</th>
            </tr>
            <tr id="summaryPlayersRow" style="display:none">
              <th></th>
              <th id="sumPlayersA" class="player-names"></th>
              <th id="sumPlayersB" class="player-names"></th>
              <th></th>
            </tr>
          </thead>
    <tbody id="summaryBody"></tbody>
  </table>
      </div>
</div>

    <div class="modalActions">
      <button id="btnQuickStart" class="btn btn--primary">⚡ Hurtigstart</button>
      <button id="btnNewMatch" class="btn btn--secondary">🆕 Start ny kamp</button>
      <button id="btnCloseSummary" class="btn btn--secondary">Lukk</button>
    </div>
  </div>
</div>

<!-- kebab -->
<div id="kebab" aria-label="Meny" title="Meny" role="button" tabindex="0">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
</div>
<div id="menuPanel" role="menu" aria-label="Hovedmeny"></div>

<!-- share -->
<div id="shareMask" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
  <div class="share-modal">
    <!-- Header -->
    <div class="share-header">
      <div id="shareTitle" class="share-title">Del kamp</div>
      <button id="shareClose" class="btn btn--ghost" aria-label="Lukk">✕</button>
    </div>
    
    <!-- Role selection with clear label -->
    <div class="share-section">
      <div class="role-label">Del som:</div>
      <div class="role-segments">
        <button class="role-segment active" data-role="spectator">👥 Tilskuer</button>
        <button class="role-segment" data-role="cocounter">📱 Medteller</button>
      </div>
    </div>
    
    <!-- QR Code container -->
    <div class="share-section">
      <div id="qrBox" class="qr-container" aria-label="QR-kode"></div>
    </div>
    
    <!-- URL field - Hidden by default -->
    <div class="share-section" style="display:none">
      <div class="url-container">
        <input type="text" id="shareUrlInput" class="url-input" readonly placeholder="Genererer lenke...">
      </div>
    </div>
    
    <!-- Action buttons -->
    <div class="share-section">
      <div class="share-buttons">
        <button id="btnCopy" class="btn btn--primary btn--primary-action">Kopier lenke</button>
        <button id="btnWebShare" class="btn btn--secondary" style="display:none">Del via…</button>
      </div>
    </div>
  </div>
</div>

<!-- Name modal (used at start + when choosing Edit names) -->
<div id="nameMask">
  <div class="nameCard">
    <h3 style="margin:.2rem 0 1rem 0">Spillernavn</h3>
    
    <!-- Single format -->
    <div id="singleNames" class="nameRow">
      <div class="nameField">
        <label for="nameA">Venstre</label>
        <div class="autocomplete">
          <input id="nameA" placeholder="Spiller A" autocomplete="off"/>
          <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameA')">&#x25BC;</button>
          <div id="nameA-list" class="autocomplete-items"></div>
        </div>
      </div>
      <div class="nameField">
        <label for="nameB">Høyre</label>
        <div class="autocomplete">
          <input id="nameB" placeholder="Spiller B" autocomplete="off"/>
          <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameB')">&#x25BC;</button>
          <div id="nameB-list" class="autocomplete-items"></div>
        </div>
      </div>
    </div>
    
    <!-- Double format -->
    <div id="doubleNames" class="nameRow double" style="display:none">
      <!-- Team A (Left) -->
      <div class="teamWrapper teamA">
        <div class="teamHeader">
          <input id="teamNameA" class="teamNameInput" placeholder="Lag 1" autocomplete="off"/>
          <span class="teamNameLabel">Lag 1</span>
        </div>
        <div class="nameField">
          <label for="nameA1">Spiller 1</label>
          <div class="autocomplete">
            <input id="nameA1" placeholder="Spiller A" autocomplete="off"/>
            <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameA1')">&#x25BC;</button>
            <div id="nameA1-list" class="autocomplete-items"></div>
          </div>
        </div>
        <div class="nameField">
          <label for="nameA2">Spiller 2</label>
          <div class="autocomplete">
            <input id="nameA2" placeholder="Spiller A2" autocomplete="off"/>
            <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameA2')">&#x25BC;</button>
            <div id="nameA2-list" class="autocomplete-items"></div>
          </div>
        </div>
      </div>
      
      <!-- Team B (Right) -->
      <div class="teamWrapper teamB">
        <div class="teamHeader">
          <input id="teamNameB" class="teamNameInput" placeholder="Lag 2" autocomplete="off"/>
          <span class="teamNameLabel">Lag 2</span>
        </div>
        <div class="nameField">
          <label for="nameB1">Spiller 1</label>
          <div class="autocomplete">
            <input id="nameB1" placeholder="Spiller B" autocomplete="off"/>
            <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameB1')">&#x25BC;</button>
            <div id="nameB1-list" class="autocomplete-items"></div>
          </div>
        </div>
        <div class="nameField">
          <label for="nameB2">Spiller 2</label>
          <div class="autocomplete">
            <input id="nameB2" placeholder="Spiller B2" autocomplete="off"/>
            <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameB2')">&#x25BC;</button>
            <div id="nameB2-list" class="autocomplete-items"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modalActions">
      <button id="btnCancelNames" class="btn btn--ghost">Avbryt</button>
      <button id="btnSaveNames" class="btn btn--primary">Lagre</button>
      <button id="btnStart" class="btn btn--primary" style="background:#60a5fa;color:#061a2e">Start kamp</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- Finish Match Modal -->
<div id="finishMatchMask" class="modalMask" style="display:none" aria-hidden="true">
  <div class="modalPanel finishMatchPanel">
    <h3>Ferdigstill kamp</h3>
    <p id="finishMatchHint">Velg hvordan du vil avslutte kampen.</p>
    <p id="finishMatchInfo" class="muted" style="display:none;margin-top:.5rem;"></p>
    <div class="finishActions">
      <button id="finishMatchPlayed" class="btn btn--primary">Kampen er spilt ferdig</button>
      <button id="finishMatchWalkoverA" class="btn btn--secondary">Walkover – lag A</button>
      <button id="finishMatchWalkoverB" class="btn btn--secondary">Walkover – lag B</button>
      <button id="finishMatchCancel" class="btn btn--ghost">Avbryt</button>
    </div>
  </div>
</div>

<script type="module" src="./js/main.js"></script>

  <!-- Confirm Start Modal -->
  <div id="confirmStartMask" class="modalMask" style="display:none" aria-hidden="true">
    <div class="modalBox" role="dialog" aria-labelledby="confirmStartTitle" aria-modal="true">
      <div class="modalHeader">
        <h2 id="confirmStartTitle">Start på nytt?</h2>
        <button id="confirmStartClose" class="closeBtn" aria-label="Lukk">×</button>
      </div>
      <div class="modalContent">
        <p id="confirmStartText">
          Dette vil avslutte og slette pågående kamp. Fortsette?
        </p>
      </div>
      <div class="modalActions">
        <button id="confirmStartCancel" class="btn btn--secondary">Avbryt</button>
        <button id="confirmStartOk" class="btn btn--primary">Fortsett</button>
      </div>
    </div>
  </div>
</body>
</html>











