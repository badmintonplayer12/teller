<!DOCTYPE html><html lang="no"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/><title>Badminton Poengteller</title>
<!--
Badminton Poengteller ‚Äì unified control/spectator
- URL: index.html?mode=control | ?mode=spectator&game=ID
- Minimal UI (kun navn+poeng). Kebab-meny (‚ãÆ) i control.
- Stabil game-id per kontroll-bruker (localStorage badm_game_id_v1).
- Delingspanel: Ekte QR via qrcode.min.js (CDN). Hvis lib mangler ‚Üí bare lenke.
- Long-press (~800ms) for ‚àí1, uten +1 ved slipp (Chrome/Windows fix).
- BWF: 21 (win by 2, cap 30), best av 3, autoswap i sett 3 ved 11.
- Tabular digits, +1 bl√• glow, ‚àí1 r√∏d glow, vinner gullpuls.
- Bytt-side anim som ogs√• reordner DOM. Autoskalering (ingen horisontal overflow).
- Firebase Realtime DB v8 compat; lokal fallback hvis blokkert.
-->
<style>
:root{--gap:clamp(12px,3vw,36px);--divider:2px;--scrollGap:clamp(16px,2.2vw,40px);--accent:#60a5fa;--minus:#ef4444}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1224;color:#fff;display:flex;flex-direction:column;max-width:100vw;overflow-x:hidden;user-select:none}
.editing{user-select:auto}
.wrap{flex:1 1 auto;min-height:100vh;display:grid;grid-template-columns:1fr var(--divider) 1fr;column-gap:var(--gap);padding:var(--gap);align-items:stretch;overflow:hidden;position:relative}
.divider{width:var(--divider);background:#1e293b;z-index:2}
.side{position:relative;background:#0f172a;border-radius:.8rem;padding:clamp(8px,1.8vw,16px);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow:hidden;will-change:transform;transition:transform 1s ease;z-index:1}
.wrap.swap-go .left{transform:translateX(calc(100% + var(--gap) + var(--divider)))}
.wrap.swap-go .right{transform:translateX(calc(-100% - var(--gap) - var(--divider)))}
.no-trans .side{transition:none!important}
.name{min-height:clamp(36px,6vh,56px);display:flex;align-items:center;justify-content:center;width:100%;margin:.6rem 0 .25rem 0;position:relative}
.name input{font:inherit;color:#e5e7eb;background:#111827;border:1px solid #0008;border-radius:.5rem;padding:.35rem .75rem;text-align:center;width:min(18ch,92%);max-width:18ch;overflow:hidden;text-overflow:ellipsis;transition:color .6s,text-shadow .6s}
.name input:disabled{opacity:.95;cursor:default}
.setCounter{position:absolute;right:-.35rem;top:50%;transform:translate(0,-50%);background:var(--accent);color:#061a2e;font-weight:900;border-radius:999px;padding:.18rem .62rem;min-width:2rem;text-align:center;box-shadow:0 0 10px rgba(96,165,250,.45),0 0 24px rgba(59,130,246,.35);display:none}
@media(max-width:520px){.setCounter{right:-.15rem}}
.scoreBox{flex:1 1 auto;width:100%;min-height:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
.score{width:100%;display:flex;justify-content:center;align-items:center;text-align:center;font-weight:900;line-height:.92;cursor:pointer;white-space:nowrap;overflow:hidden;font-variant-numeric:tabular-nums;will-change:transform,text-shadow;padding:0 2vw;transition:color .6s,text-shadow .6s}
.digits{display:flex;gap:.08em;align-items:baseline;max-width:100%;overflow:hidden}
.digit{display:inline-block;width:1ch;text-align:center}
.digit.ghost{visibility:hidden}
.pop{animation:glowBurst .55s ease-out 1}
.popMinus{animation:minusBurst .55s ease-out 1}
@keyframes glowBurst{0%{text-shadow:0 0 0 rgba(96,165,250,0);transform:scale(1)}20%{text-shadow:0 0 30px rgba(96,165,250,.95),0 0 70px rgba(59,130,246,.8),0 0 110px rgba(37,99,235,.7);transform:scale(1.08)}60%{text-shadow:0 0 20px rgba(96,165,250,.55),0 0 50px rgba(59,130,246,.45);transform:scale(1.03)}100%{text-shadow:0 0 0 rgba(96,165,250,0);transform:scale(1)}}
@keyframes minusBurst{0%{text-shadow:0 0 0 rgba(239,68,68,0);transform:scale(1)}20%{text-shadow:0 0 30px rgba(239,68,68,.95),0 0 70px rgba(239,68,68,.7),0 0 110px rgba(185,28,28,.6);transform:scale(0.96)}60%{text-shadow:0 0 20px rgba(239,68,68,.5),0 0 50px rgba(185,28,28,.4);transform:scale(0.985)}100%{text-shadow:0 0 0 rgba(239,68,68,0);transform:scale(1)}}
.winner,.winnerName{color:#ffd700!important;animation:goldPulse 3s ease-in-out infinite}
@keyframes goldPulse{0%{text-shadow:0 0 3px rgba(255,215,0,.25),0 0 6px rgba(255,220,50,.2)}50%{text-shadow:0 0 8px rgba(255,215,0,.5),0 0 16px rgba(255,220,50,.4)}100%{text-shadow:0 0 3px rgba(255,215,0,.25),0 0 6px rgba(255,220,50,.2)}}
#sets{display:none}
#winnerMsg{padding:.4rem 1rem 0;text-align:center;font-size:clamp(1.1rem,3.5vw,2rem);color:#facc15;font-weight:900;white-space:pre-line}
.summary{margin:.8rem var(--gap) 0;background:#0b1224;border:1px solid #0b1224;border-radius:.8rem;padding:1rem;display:none}
.summary h3{margin:.2rem 0 .6rem 0;font-size:1.05rem}
.summary table{width:100%;border-collapse:collapse}
.summary th,.summary td{text-align:center;padding:.4rem .3rem;border-bottom:1px solid #1e293b}
.summary tfoot td{font-weight:700}
.history{display:none}

/* Kebab floating button */
#kebab{position:fixed;top:10px;right:10px;z-index:50;background:#0f172a;border:1px solid #233454;border-radius:.6rem;padding:.35rem .55rem;cursor:pointer;display:none}
#kebab:focus{outline:2px solid #60a5fa}
#kebab svg{display:block;width:20px;height:20px}

/* Kebab menu panel */
#menuPanel{position:fixed;top:46px;right:10px;background:#0b1224;border:1px solid #122042;border-radius:.6rem;box-shadow:0 8px 28px rgba(0,0,0,.45);z-index:51;display:none;min-width:240px}
.menuItem{display:flex;align-items:center;gap:.6rem;padding:.55rem .7rem;cursor:pointer;color:#e5e7eb}
.menuItem:hover{background:#0f1a33}
.menuHR{height:1px;background:#1e293b;margin:.25rem 0}

/* Share dialog */
#shareMask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
#shareCard{background:#0b1224;border:1px solid #122042;border-radius:.8rem;padding:1rem;max-width:92vw;width:min(560px,92vw)}
#qrBox{display:flex;align-items:center;justify-content:center;background:#ffffff;border:1px solid #233454;border-radius:.4rem;padding:12px;min-width:280px;min-height:280px}
#qrBox canvas,#qrBox img{image-rendering:pixelated;image-rendering:crisp-edges}
.shareRow{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:.5rem}
.button{font:inherit;border:0;border-radius:.5rem;padding:.45rem .7rem;cursor:pointer;background:#243147;color:#e5e7eb;border:1px solid #32425f}
.button.ghost{background:transparent}
#toast{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #233454;color:#e5e7eb;padding:.45rem .7rem;border-radius:.5rem;z-index:70;display:none}

.clickArea{position:absolute;top:0;bottom:0;width:calc(50% - var(--scrollGap));z-index:3;background:transparent;pointer-events:none}
.areas-active .clickArea{pointer-events:auto;touch-action:pan-y}
.clickArea.left{left:0}.clickArea.right{right:0}
</style></head>
<body>

<div id="sets" aria-live="polite">Sett: 0-0</div>

<div class="wrap" id="wrap">
  <div class="clickArea left" id="leftArea" aria-label="Legg til poeng venstre"></div>
  <div class="clickArea right" id="rightArea" aria-label="Legg til poeng h√∏yre"></div>

  <div class="side left" id="sideA">
    <div class="name"><input id="nameA" value="Spiller A" autocomplete="off" placeholder="Spiller A"/><div id="setCounterA" class="setCounter">0</div></div>
    <div class="scoreBox"><div class="score" id="scoreA"><span class="digits" id="A_digits"><span class="digit" id="A_tens">0</span><span class="digit" id="A_ones">0</span></span></div></div>
  </div>

  <div class="divider"></div>

  <div class="side right" id="sideB">
    <div class="name"><input id="nameB" value="Spiller B" autocomplete="off" placeholder="Spiller B"/><div id="setCounterB" class="setCounter">0</div></div>
    <div class="scoreBox"><div class="score" id="scoreB"><span class="digits" id="B_digits"><span class="digit" id="B_tens">0</span><span class="digit" id="B_ones">0</span></span></div></div>
  </div>
</div>

<div id="winnerMsg"></div>
<div id="matchSummary" class="summary">
  <h3>Kampsammendrag</h3>
  <div id="sumMeta" class="muted" style="margin:.2rem 0 .6rem 0"></div>
  <table>
    <thead><tr><th>Sett</th><th id="sumNameA">Spiller A</th><th id="sumNameB">Spiller B</th><th>Vinner</th></tr></thead>
    <tbody id="summaryBody"></tbody>
    <tfoot><tr><td colspan="4" id="summaryWinner"></td></tr></tfoot>
  </table>
</div>

<!-- Kebab (control only) -->
<div id="kebab" aria-label="Meny" title="Meny" role="button" tabindex="0">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
</div>

<!-- Kebab menu panel -->
<div id="menuPanel" role="menu" aria-label="Hovedmeny">
  <div class="menuItem" id="miShare" role="menuitem">üîó Del‚Ä¶</div>
  <div class="menuItem" id="miTempUnlock" role="menuitem">‚úèÔ∏è Rediger spillernavn (midlertidig)</div>
  <div class="menuItem" id="miNewMatch" role="menuitem">üÜï Start ny kamp</div>
  <div class="menuItem" id="miResetSet" role="menuitem">‚ôªÔ∏è Nullstill sett</div>
  <div class="menuItem" id="miSwap" role="menuitem">‚áÑ Bytt side</div>
  <div class="menuHR"></div>
  <div class="menuItem" id="miFullscreen" role="menuitem">‚õ∂ Fullskjerm</div>
  <div class="menuItem" id="miStats" role="menuitem">üìä Vis/Skjul statistikk</div>
</div>

<!-- Share dialog -->
<div id="shareMask" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
  <div id="shareCard">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
      <div id="shareTitle" style="font-weight:700">Del tilskuervy</div>
      <button id="shareClose" class="button ghost" aria-label="Lukk">‚úï</button>
    </div>
    <div id="qrBox" aria-label="QR-kode"></div>
    <div id="shareUrl" style="text-align:center;word-break:break-all;margin-top:.5rem;font-size:.9rem;color:#93c5fd"></div>
    <div class="shareRow">
      <button id="btnCopy" class="button">Kopier lenke</button>
      <button id="btnOpenSpectator" class="button">√Öpne tilskuer</button>
      <button id="btnWebShare" class="button" style="display:none">Del via‚Ä¶</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
(function(){
  // ---------- Helpers ----------
  function $(s){return document.querySelector(s)}
  function $all(s){return Array.prototype.slice.call(document.querySelectorAll(s)||[])}
  function toast(msg){var t=$('#toast');if(!t)return;t.textContent=msg;t.style.display='block';setTimeout(function(){t.style.display='none'},1400)}
  var LONGPRESS_MS=800,MOVE_THRESH=16;
  var LS_MATCHES='badm_matches_v1',LS_LAST='badm_last_names_v1',LS_LIVE='badm_live_v1',LS_GAMEID='badm_game_id_v1';
  var params=(function(){try{return new URL(location.href).searchParams}catch(e){return{get:function(){return null}}}})();
  var MODE=((params.get('mode')||'control')+'').toLowerCase();
  var IS_SPECTATOR=MODE==='spectator';

  // ---------- State ----------
  var scoreA=0,scoreB=0,setsA=0,setsB=0,target=21,cap=30,currentSet=1,swappedAt11=false,locked=false,swapping=false;
  var setHistory=[];var namesSavedThisMatch=false;
  var tempNamesUnlocked=false; // kebab: midlertidig navne-redigering, l√•ses ved neste poeng

  // ---------- DOM / side-ordre ----------
  function setSidesDomTo(isALeft){
    var wrap=$('#wrap'),sideA=$('#sideA'),sideB=$('#sideB'),divider=document.querySelector('.divider');
    if(!(wrap&&sideA&&sideB&&divider))return;
    var aIsLeft=sideA.classList.contains('left');if(aIsLeft===isALeft)return;
    wrap.classList.add('no-trans');
    try{
      if(isALeft){
        sideA.classList.add('left');sideA.classList.remove('right');
        sideB.classList.add('right');sideB.classList.remove('left');
        wrap.insertBefore(sideA,wrap.firstElementChild);
        wrap.insertBefore(divider,sideB);
      }else{
        sideB.classList.add('left');sideB.classList.remove('right');
        sideA.classList.add('right');sideA.classList.remove('left');
        wrap.insertBefore(sideB,wrap.firstElementChild);
        wrap.insertBefore(divider,sideA);
      }
    }catch(e){}
    wrap.classList.remove('no-trans')
  }
  function startVisualSwap(){if(swapping)return;swapping=true;
    var wrap=$('#wrap'),left=document.querySelector('.side.left'),right=document.querySelector('.side.right'),divider=document.querySelector('.divider');
    if(!(wrap&&left&&right&&divider)){swapping=false;return}
    wrap.classList.add('swap-go');var finished=false;
    function complete(){if(finished)return;finished=true;
      left.removeEventListener('transitionend',onEnd);right.removeEventListener('transitionend',onEnd);
      try{wrap.classList.add('no-trans');wrap.insertBefore(right,left);if(divider.parentNode!==wrap)wrap.appendChild(divider);wrap.insertBefore(divider,left);left.classList.remove('left');left.classList.add('right');right.classList.remove('right');right.classList.add('left')}catch(e){}
      wrap.classList.remove('swap-go');void wrap.offsetWidth;wrap.classList.remove('no-trans');fitScores();swapping=false;saveLiveState();if(window.pushStateThrottled)window.pushStateThrottled()}
    function onEnd(e){if(e.target!==left&&e.target!==right)return;complete()}
    left.addEventListener('transitionend',onEnd);right.addEventListener('transitionend',onEnd);setTimeout(complete,1200)
  }
  function swapSides(){startVisualSwap()}

  // ---------- Score UI ----------
  function setDigits(sc,p){var t=Math.floor(sc/10),o=sc%10,te=$('#'+p+'_tens'),oe=$('#'+p+'_ones');if(sc<10){te.textContent='0';te.classList.add('ghost')}else{te.textContent=String(t);te.classList.remove('ghost')}oe.textContent=String(o)}
  function updateScores(){setDigits(scoreA,'A');setDigits(scoreB,'B');var setsEl=$('#sets');setsEl.textContent='Sett: '+setsA+'-'+setsB;var cA=$('#setCounterA'),cB=$('#setCounterB');cA.style.display=setsA>0?'flex':'none';cB.style.display=setsB>0?'flex':'none';if(setsA>0)cA.textContent=setsA;if(setsB>0)cB.textContent=setsB;updateEditableState();saveLiveState()}
  
  
  function fitScores(){
  document.body.classList.add('measuring');
  var base=100, sA=$('#scoreA'), sB=$('#scoreB');
  if(!sA||!sB){ document.body.classList.remove('measuring'); return; }

  // Sett midlertidig base for √• m√•le riktig
  sA.style.fontSize = base+'px';
  sB.style.fontSize = base+'px';

  var sideA=$('#sideA'), sideB=$('#sideB');
  var nameAH=(($('#sideA .name')||{}).offsetHeight)||0;
  var nameBH=(($('#sideB .name')||{}).offsetHeight)||0;

  function sidePadY(el){ var cs=getComputedStyle(el); return (parseFloat(cs.paddingTop)||0)+(parseFloat(cs.paddingBottom)||0); }
  function padX(el){ var cs=getComputedStyle(el); return (parseFloat(cs.paddingLeft)||0)+(parseFloat(cs.paddingRight)||0); }

  var availHA=Math.max(40, ((sideA&&sideA.clientHeight)||0) - nameAH - (sideA?sidePadY(sideA):0));
  var availHB=Math.max(40, ((sideB&&sideB.clientHeight)||0) - nameBH - (sideB?sidePadY(sideB):0));

  var boxA=$('#sideA .scoreBox'), boxB=$('#sideB .scoreBox');
  var availWA=Math.max(40, ((boxA&&boxA.clientWidth)||0) - padX(sA));
  var availWB=Math.max(40, ((boxB&&boxB.clientWidth)||0) - padX(sB));

  var aRect=$('#A_digits').getBoundingClientRect();
  var bRect=$('#B_digits').getBoundingClientRect();

  var scaleA=Math.min(availWA/Math.max(1,aRect.width), availHA/Math.max(1,aRect.height));
  var scaleB=Math.min(availWB/Math.max(1,bRect.width), availHB/Math.max(1,bRect.height));

  // Ny, uavhengig font-size per side
  var fA=Math.floor(base*Math.max(.01,scaleA));
  var fB=Math.floor(base*Math.max(.01,scaleB));

  // Oppdater bare hvis endret for √• unng√• un√∏dvendig ‚Äúbump‚Äù
  if(sA.style.fontSize !== fA+'px') sA.style.fontSize = fA+'px';
  if(sB.style.fontSize !== fB+'px') sB.style.fontSize = fB+'px';

  document.body.classList.remove('measuring');
  saveLiveState();
}
  var queueFit=(function(){var raf=0,t=0;return function(){cancelAnimationFrame(raf);clearTimeout(t);raf=requestAnimationFrame(function(){fitScores();t=setTimeout(fitScores,60)})}})();
  addEventListener('resize',queueFit);document.addEventListener('fullscreenchange',queueFit);if(window.visualViewport)visualViewport.addEventListener('resize',queueFit);
  addEventListener('orientationchange',function(){setTimeout(queueFit,60)});
  function bumpPlus(el){if(!el)return;el.classList.remove('pop');void el.offsetWidth;el.classList.add('pop');setTimeout(function(){el.classList.remove('pop')},550)}
  function bumpMinus(el){if(!el)return;el.classList.remove('popMinus');void el.offsetWidth;el.classList.add('popMinus');setTimeout(function(){el.classList.remove('popMinus')},550)}
  function clearWinner(){['#scoreA','#scoreB'].forEach(function(sel){var e=$(sel);if(e)e.classList.remove('winner')});['#nameA','#nameB'].forEach(function(sel){var e=$(sel);if(e)e.classList.remove('winnerName')})}

  // ---------- Editable / click-areas ----------
  function updateEditableState(){
    var nameA=$('#nameA'),nameB=$('#nameB');
    var atStart=(scoreA===0&&scoreB===0&&setsA===0&&setsB===0&&currentSet===1&&!locked);
    var editable=!IS_SPECTATOR && (atStart || tempNamesUnlocked);
    nameA.disabled=!editable;nameB.disabled=!editable;
    if(editable)document.body.classList.add('editing');else document.body.classList.remove('editing');
    if(!editable&&!IS_SPECTATOR)document.body.classList.add('areas-active');else document.body.classList.remove('areas-active');
  }

  // ---------- Points & Logic ----------
  function maybeSaveNamesOnStart(){if(namesSavedThisMatch)return;var atStart=(scoreA===0&&scoreB===0&&setsA===0&&setsB===0&&currentSet===1&&!locked);if(!atStart){var nA=$('#nameA').value||'Spiller A',nB=$('#nameB').value||'Spiller B';saveLastNames(nA,nB);namesSavedThisMatch=true}}
  function addPoint(s){if(locked||swapping||IS_SPECTATOR)return;if(s==='A')scoreA++;else scoreB++;tempNamesUnlocked=false;maybeSaveNamesOnStart();checkSetEnd();updateScores();bumpPlus($(s==='A'?'#scoreA':'#scoreB'));fitScores();if(window.pushStateThrottled)window.pushStateThrottled()}
  function removePoint(s){if(locked||swapping||IS_SPECTATOR)return;if(s==='A'&&scoreA>0)scoreA--;if(s==='B'&&scoreB>0)scoreB--;tempNamesUnlocked=false;updateScores();bumpMinus($(s==='A'?'#scoreA':'#scoreB'));fitScores();if(window.pushStateThrottled)window.pushStateThrottled()}
  function addPointByPosition(pos){var isA=document.querySelector('.side.left').id==='sideA';addPoint((pos==='left')?(isA?'A':'B'):(isA?'B':'A'))}
  function removePointByPosition(pos){var isA=document.querySelector('.side.left').id==='sideA';removePoint((pos==='left')?(isA?'A':'B'):(isA?'B':'A'))}

  function fmtDate(ts){var d=new Date(ts);return d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
  function pushSetToHistory(a,b){setHistory.push({set:currentSet,a:a,b:b,winner:a>b?'A':(b>a?'B':'-')});saveLiveState()}
  function renderSummary(finalWinner){var box=$('#matchSummary');var body=$('#summaryBody');var nA=$('#nameA').value||'Spiller A',nB=$('#nameB').value||'Spiller B';
    $('#sumNameA').textContent=nA;$('#sumNameB').textContent=nB;$('#sumMeta').textContent='Spilt: '+fmtDate(Date.now());
    body.innerHTML='';for(var i=0;i<setHistory.length;i++){var r=setHistory[i];var tr=document.createElement('tr');['set','a','b'].forEach(function(k){var td=document.createElement('td');td.textContent=String(r[k]);tr.appendChild(td)});var tdW=document.createElement('td');tdW.textContent=r.winner==='A'?nA:(r.winner==='B'?nB:'‚Äî');tr.appendChild(tdW);body.appendChild(tr)}
    $('#summaryWinner').textContent='Kampvinner: '+finalWinner;box.style.display='block';saveLiveState()
  }
  function checkSetEnd(){var lead=Math.abs(scoreA-scoreB);if((scoreA>=target||scoreB>=target)&&(lead>=2||scoreA===cap||scoreB===cap)){
      pushSetToHistory(scoreA,scoreB);if(scoreA>scoreB)setsA++;else setsB++;
      if(setsA===2||setsB===2){var nameA=$('#nameA').value||'Spiller A',nameB=$('#nameB').value||'Spiller B';var winner=setsA===2?nameA:nameB;var loser=setsA===2?nameB:nameA;
        $('#winnerMsg').textContent='üéâ GRATULERER '+winner.toUpperCase()+'! DU VANT KAMPEN!\nüëè BRA JOBBA '+loser.toUpperCase()+', DU GJORDE DITT BESTE.';
        if(setsA===2){$('#scoreA').classList.add('winner');$('#nameA').classList.add('winnerName')}else{$('#scoreB').classList.add('winner');$('#nameB').classList.add('winnerName')}
        locked=true;document.body.classList.remove('areas-active');renderSummary(winner);saveMatchToHistory();return
      }
      scoreA=0;scoreB=0;currentSet++;swappedAt11=false;startVisualSwap()
    }
    if(currentSet===3&&!swappedAt11&&(scoreA===11||scoreB===11)){startVisualSwap();swappedAt11=true}
    saveLiveState()
  }

  // ---------- History & Stats (vises via meny) ----------
  function loadMatches(){try{var raw=localStorage.getItem(LS_MATCHES);if(!raw)return[];var arr=JSON.parse(raw);return Array.isArray(arr)?arr:[]}catch(e){return[]}}
  function saveMatches(list){try{localStorage.setItem(LS_MATCHES,JSON.stringify(list.slice(0,50)))}catch(e){}}
  function saveMatchToHistory(){var nA=$('#nameA').value||'Spiller A',nB=$('#nameB').value||'Spiller B';var winner=setsA===2?nA:nB;var obj={ts:Date.now(),names:{A:nA,B:nB},sets:setHistory.slice(),winner:winner};var arr=loadMatches();arr.unshift(obj);arr=arr.slice(0,50);saveMatches(arr);saveLastNames(nA,nB);renderHistory();clearLiveState()}
  function deleteMatch(idx){var arr=loadMatches();if(idx<0||idx>=arr.length)return;arr.splice(idx,1);saveMatches(arr);renderStats(loadMatches())}
  function fmtStats(arr){var stats={matches:arr.length,sets:0,straight:0,three:0,deuceSets:0,avgMargin:0,maxTotalSet:null};var marginSum=0;
    for(var i=0;i<arr.length;i++){var m=arr[i];var sets=(m.sets||[]);stats.sets+=sets.length;var score=[0,0];
      for(var j=0;j<sets.length;j++){var s=m.sets[j];var a=+s.a||0,b=+s.b||0;score[a>b?0:1]++;var total=a+b;var margin=Math.abs(a-b);marginSum+=margin;if(a>=20&&b>=20)stats.deuceSets++;if(!stats.maxTotalSet||total>((stats.maxTotalSet.a||0)+(stats.maxTotalSet.b||0)))stats.maxTotalSet={a:a,b:b,names:m.names}}
      if(score[0]===2||score[1]===2)stats.straight++;else stats.three++
    }
    stats.avgMargin=stats.sets?(marginSum/stats.sets):0;return stats}
  function renderStats(arr){var s=fmtStats(arr);var el=document.getElementById('stats');if(!el){el=document.createElement('div');el.id='stats';el.className='stats';var h=document.createElement('div');h.className='history';h.innerHTML='<h3>Siste 50 kamper & oversikt</h3><div style="height:.6rem"></div>';h.appendChild(el);var leader=document.createElement('div');leader.id='leaderboard';h.appendChild(leader);var tbl=document.createElement('table');tbl.innerHTML='<thead><tr><th>#</th><th>Dato</th><th>Spiller A</th><th>Spiller B</th><th>Sett</th><th>Vinner</th><th>Handling</th></tr></thead><tbody id="historyBody"></tbody>';h.appendChild(tbl);document.body.appendChild(h)}
    function card(label,val){var d=document.createElement('div');d.className='stat';d.innerHTML='<div class="muted" style="font-size:.8rem">'+label+'</div><div style="font-size:1.15rem;font-weight:700">'+val+'</div>';return d}
    el.innerHTML='';el.appendChild(card('Kamper lagret',s.matches));el.appendChild(card('Sett spilt',s.sets));el.appendChild(card('2‚Äì0-kamper',s.straight));el.appendChild(card('3-settskamper',s.three));el.appendChild(card('Deuce-sett (‚â•20‚Äì20)',String(s.deuceSets)));el.appendChild(card('Snitt seiersmargin/sett',s.avgMargin.toFixed(2)));
    
    if (s.maxTotalSet) {
  el.appendChild(
    card('H√∏yest poengsum i sett', String(s.maxTotalSet.a) + '-' + String(s.maxTotalSet.b))
  );
}
    var arr=loadMatches(),winMap={};for(var i=0;i<arr.length;i++){var w=arr[i].winner||'';winMap[w]=(winMap[w]||0)+1}
    var leaderDiv=document.getElementById('leaderboard');leaderDiv.innerHTML='<h4 style="margin:.2rem 0 .4rem 0">Seiersoversikt</h4>';
    var entries=[];for(var k in winMap)if(Object.prototype.hasOwnProperty.call(winMap,k))entries.push([k,winMap[k]]);
    entries.sort(function(a,b){return b[1]-a[1]});
    if(!entries.length){var p=document.createElement('div');p.textContent='Ingen lagrede kamper enn√•.';leaderDiv.appendChild(p)}else{var cont=document.createElement('div');cont.className='leader';for(var ii=0;ii<entries.length;ii++){var n=document.createElement('div');n.textContent=entries[ii][0];var c=document.createElement('div');c.textContent=entries[ii][1];cont.appendChild(n);cont.appendChild(c)}leaderDiv.appendChild(cont)}
    var body=document.getElementById('historyBody');body.innerHTML='';for(i=0;i<arr.length;i++){var m=arr[i];var tr=document.createElement('tr');
      var tdIdx=document.createElement('td');tdIdx.textContent=String(i+1);
      var tdDate=document.createElement('td');tdDate.textContent=fmtDate(m.ts);
      var tdA=document.createElement('td');tdA.textContent=m.names.A;
      var tdB=document.createElement('td');tdB.textContent=m.names.B;
      var tdSets=document.createElement('td');var parts=[];for(var j=0;j<(m.sets||[]).length;j++){var s2=m.sets[j];parts.push(String(s2.a)+'-'+String(s2.b))}tdSets.textContent=parts.join(' , ');
      var tdW=document.createElement('td');tdW.textContent=m.winner;
      var tdAct=document.createElement('td');tdAct.className='actions';var del=document.createElement('button');del.className='button';del.textContent='Slett';(function(idx){del.addEventListener('click',function(){deleteMatch(idx)})})(i);
      tdAct.appendChild(del);
      tr.appendChild(tdIdx);tr.appendChild(tdDate);tr.appendChild(tdA);tr.appendChild(tdB);tr.appendChild(tdSets);tr.appendChild(tdW);tr.appendChild(tdAct);body.appendChild(tr)
    }
    document.querySelector('.history').style.display='block';
  }
  function renderHistory(){}

  function saveLastNames(a,b){try{localStorage.setItem(LS_LAST,JSON.stringify([a,b]))}catch(e){}}
  function clearLiveState(){try{localStorage.removeItem(LS_LIVE)}catch(e){}}
  var saveLiveState=(function(){var to=0;return function(){clearTimeout(to);to=setTimeout(function(){try{
    var data={scoreA:scoreA,scoreB:scoreB,setsA:setsA,setsB:setsB,currentSet:currentSet,swappedAt11:swappedAt11,locked:locked,setHistory:setHistory,
      names:{A:($('#nameA')||{}).value||'Spiller A',B:($('#nameB')||{}).value||'Spiller B'},
      isALeft:$('#sideA')?$('#sideA').classList.contains('left'):true,
      winnerMsg:($('#winnerMsg')&&$('#winnerMsg').textContent)||'',
      summaryVisible:($('#matchSummary')&&$('#matchSummary').style.display==='block')
    };
    localStorage.setItem(LS_LIVE,JSON.stringify(data))}catch(e){}},80)}})();
  function restoreLiveState(){try{var raw=localStorage.getItem(LS_LIVE);if(!raw)return false;var d=JSON.parse(raw);if(!d)return false;
    scoreA=d.scoreA||0;scoreB=d.scoreB||0;setsA=d.setsA||0;setsB=d.setsB||0;currentSet=d.currentSet||1;swappedAt11=!!d.swappedAt11;locked=!!d.locked;setHistory=Array.isArray(d.setHistory)?d.setHistory:[];
    if($('#nameA'))$('#nameA').value=(d.names&&d.names.A)||'Spiller A';
    if($('#nameB'))$('#nameB').value=(d.names&&d.names.B)||'Spiller B';
    setSidesDomTo(!(d.isALeft===false));
    if($('#winnerMsg'))$('#winnerMsg').textContent=d.winnerMsg||'';
    if(d.summaryVisible)$('#matchSummary').style.display='block';
    return true}catch(e){return false}}

  // ---------- Fullscreen ----------
  function toggleFullscreen(){if(!document.fullscreenElement){document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}else{document.exitFullscreen&&document.exitFullscreen()}}

  // ---------- Long-press ‚àí1 uten +1 ved slipp ----------
  function bindLongPressOne(el,action){var tid=0,px=0,py=0,down=false,done=false,scrollY0=0;var suppressUntil=0;
    function vibrate(m){try{if(navigator.vibrate)navigator.vibrate(m)}catch(_){}} 
    function start(x,y){down=true;done=false;px=x;py=y;scrollY0=window.scrollY;clearTimeout(tid);tid=setTimeout(function(){if(!down||done)return;done=true;suppressUntil=performance.now()+1500;action();vibrate(60)},LONGPRESS_MS)}
    function cancel(){down=false;clearTimeout(tid)}
    el.addEventListener('click',function(e){if(performance.now()<suppressUntil){e.stopPropagation();e.preventDefault()}},true);
    el.addEventListener('pointerdown',function(e){if(e.pointerType==='mouse'&&e.button!==0)return;if(el.setPointerCapture)el.setPointerCapture(e.pointerId);start(e.clientX,e.clientY)},{passive:true});
    el.addEventListener('pointermove',function(e){if(!down)return;if(Math.hypot(e.clientX-px,e.clientY-py)>MOVE_THRESH||Math.abs(window.scrollY-scrollY0)>2)cancel()},{passive:true});
    ['pointerup','pointercancel','pointerleave','lostpointercapture','blur'].forEach(function(ev){el.addEventListener(ev,function(){if(done){suppressUntil=Math.max(suppressUntil,performance.now()+500)}cancel()},{passive:true})})
  }
  function bindTap(el,fn){el.addEventListener('click',fn)}

  // ---------- Kebab Meny ----------
  var kebab=$('#kebab'), panel=$('#menuPanel');
  function togglePanel(){panel.style.display=(panel.style.display==='block')?'none':'block'}
  function closePanel(){panel.style.display='none'}
  kebab.addEventListener('click',function(e){e.stopPropagation();togglePanel()});
  kebab.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();togglePanel()}});
  document.addEventListener('click',function(e){if(!panel.contains(e.target)&&e.target!==kebab)closePanel()});
  document.addEventListener('keydown',function(e){if(e.key==='Escape'){closePanel();closeShare()}});

  // Menu items
  $('#miShare').addEventListener('click',function(){closePanel();openShare()});
  $('#miTempUnlock').addEventListener('click',function(){closePanel();tempNamesUnlocked=true;updateEditableState();toast('Navn kan redigeres til neste poeng')});
  $('#miNewMatch').addEventListener('click',function(){closePanel();startNewMatch()});
  $('#miResetSet').addEventListener('click',function(){closePanel();resetSet()});
  $('#miSwap').addEventListener('click',function(){closePanel();swapSides()});
  $('#miFullscreen').addEventListener('click',function(){closePanel();toggleFullscreen()});
  $('#miStats').addEventListener('click',function(){closePanel();renderStats(loadMatches())});

  // ---------- Deling (ekte QR via CDN; ellers bare lenke) ----------
  function loadScriptOnce(src, cb){
    if (document.querySelector('script[data-dyn="'+src+'"]')) { cb(); return; }
    var s=document.createElement('script');
    s.src=src; s.async=true; s.setAttribute('data-dyn', src);
    s.onload=function(){ cb(); };
    s.onerror=function(){ cb(new Error('load-fail')); };
    document.head.appendChild(s);
  }
  function ensureQrLib(cb){
    if (window.QRCode) { cb(null); return; }
    loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
      function(err){ cb((!err && window.QRCode) ? null : new Error('no-lib')); });
  }
  function openShare(){
    var url = spectatorUrlFor(ensureStableGameId());
    var shareUrlEl = document.getElementById('shareUrl');
    var box = document.getElementById('qrBox');
    shareUrlEl.textContent = url;
    box.innerHTML = ''; // tom container

    ensureQrLib(function(err){
      if (!err && window.QRCode){
        new QRCode(box, {
          text: url,
          width: 280,
          height: 280,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.Q
        });
      } else {
        box.innerHTML = '<div style="color:#fbbf24;text-align:center">QR-kode utilgjengelig. Kopier lenken under.</div>';
      }
      document.getElementById('shareMask').style.display='flex';
      var wsb=document.getElementById('btnWebShare');
      if (wsb) wsb.style.display = (navigator.share ? 'inline-block' : 'none');
    });
  }
  function closeShare(){document.getElementById('shareMask').style.display='none'}
  $('#shareClose').addEventListener('click',closeShare);

  function copyToClipboard(text){
    if(navigator.clipboard && window.isSecureContext){return navigator.clipboard.writeText(text)}
    try{var ta=document.createElement('textarea');ta.value=text;ta.setAttribute('readonly','');ta.style.position='fixed';ta.style.top='-1000px';ta.style.opacity='0';ta.style.userSelect='text';document.body.appendChild(ta);ta.focus();ta.select();var ok=document.execCommand('copy');document.body.removeChild(ta);if(ok)return Promise.resolve()}catch(e){}
    return Promise.reject(new Error('copy-fallback-failed'))
  }
  $('#btnCopy').addEventListener('click',function(){
    var url=$('#shareUrl').textContent;copyToClipboard(url).then(function(){toast('Lenke kopiert');if(window.pushStateNow)window.pushStateNow()})
    .catch(function(){toast('Kopier mislyktes ‚Äì marker og trykk Ctrl+C');var sel=window.getSelection();var r=document.createRange();r.selectNodeContents($('#shareUrl'));sel.removeAllRanges();sel.addRange(r);});
  });
  $('#btnOpenSpectator').addEventListener('click',function(){var url=$('#shareUrl').textContent;window.open(url,'_blank');if(window.pushStateNow)window.pushStateNow()});
  $('#btnWebShare').addEventListener('click',function(){if(!navigator.share)return;var url=$('#shareUrl').textContent;navigator.share({title:'Tilskuervy',text:'Badminton tilskuervy',url:url}).catch(function(){})});

  // ---------- Stabil Game ID + URLs ----------
  function readUrlGame(){var g=params.get('game');return g&&String(g).trim()?g:null}
  function getStoredGameId(){try{return localStorage.getItem(LS_GAMEID)||null}catch(e){return null}}
  function setStoredGameId(g){try{localStorage.setItem(LS_GAMEID,g)}catch(e){}}
  function makeId(n){n=n||8;var a='ABCDEFGHJKLMNPQRSTUVXYZ23456789',out='';for(var i=0;i<n;i++)out+=a.charAt(Math.floor(Math.random()*a.length));return out}
  function ensureStableGameId(){var fromUrl=readUrlGame();if(fromUrl){setStoredGameId(fromUrl);return fromUrl}var stored=getStoredGameId();if(stored)return stored;var g=makeId(8);setStoredGameId(g);return g}
  function spectatorUrlFor(g){try{var u=new URL(location.href);u.searchParams.set('mode','spectator');u.searchParams.set('game',g);return u.toString()}catch(e){return location.origin+location.pathname+'?mode=spectator&game='+encodeURIComponent(g)}}

  // ---------- Firebase (v8 compat) ----------
  window.pushStateThrottled=null;window.pushStateNow=null;
  function domScore(prefix){var tens=document.getElementById(prefix+'_tens'),ones=document.getElementById(prefix+'_ones');if(tens&&ones){var t=(tens.textContent||'0').trim();var o=(ones.textContent||'0').trim();var n=parseInt(t+o,10);return isNaN(n)?0:n}return 0}
  function getSets(prefix){var el=document.getElementById(prefix==='A'?'setCounterA':'setCounterB');return (el&&el.style.display!=='none')?Number(el.textContent||0):0}
  function getName(prefix){var el=document.getElementById(prefix==='A'?'nameA':'nameB');return el?(el.value||el.textContent||('Spiller '+prefix)):('Spiller '+prefix)}
  function getState(){return{ts:Date.now(),names:{A:getName('A'),B:getName('B')},scores:{A:domScore('A'),B:domScore('B')},sets:{A:getSets('A'),B:getSets('B')},currentSet:currentSet,isALeft:($('#sideA')&&$('#sideA').classList.contains('left'))||false,msg:($('#winnerMsg')&&$('#winnerMsg').textContent)||''}}
  function patch(name){var o=window[name];window[name]=function(){var r;try{if(typeof o==='function')r=o.apply(this,arguments)}finally{if(window.pushStateThrottled)window.pushStateThrottled()}return r}}
  ;['updateScores','addPoint','removePoint','resetSet','startNewMatch','swapSides'].forEach(patch);

  function setupFirebase(){
    var stableId=ensureStableGameId();
    if(IS_SPECTATOR && !readUrlGame()){alert('Mangler ?game=ID i URL for tilskuer');return}
    function loadScript(src,cb){var s=document.createElement('script');s.src=src;s.onload=function(){cb(null)};s.onerror=function(){cb(new Error('load '+src))};document.head.appendChild(s)}
    var fired=false;function onReady(){if(fired)return;fired=true;try{
      if(!window.firebase||!window.firebase.apps){console.warn('Firebase ikke tilgjengelig ‚Äì lokal modus');return}
      var conf={apiKey:'AIzaSyC_ApdJ1Xjldak5lw2myQI-6Y08ncU2UtM',authDomain:'badmintonteller.firebaseapp.com',projectId:'badmintonteller',storageBucket:'badmintonteller.firebasestorage.app',messagingSenderId:'776787720081',appId:'1:776787720081:web:6802244ed1a94519760c30',measurementId:'G-9PK8TF32H2',databaseURL:'https://badmintonteller-default-rtdb.europe-west1.firebasedatabase.app/'};
      if(!firebase.apps.length)firebase.initializeApp(conf);var db=firebase.database();
      if(IS_SPECTATOR){
        // husk forrige verdier for selektiv bump
        var prevA=null, prevB=null;
        db.ref('games/'+readUrlGame()).on('value',function(snap){
          var v=snap.val();if(!v)return;
          // sett sideposisjon f√∏r digits for √• unng√• feil bump
          if(typeof v.isALeft==='boolean')setSidesDomTo(v.isALeft);
          $('#nameA').value=(v.names&&v.names.A)||'Spiller A';
          $('#nameB').value=(v.names&&v.names.B)||'Spiller B';
          setsA=Number((v.sets&&v.sets.A)||0);setsB=Number((v.sets&&v.sets.B)||0);
          var a=Number((v.scores&&v.scores.A)||0),b=Number((v.scores&&v.scores.B)||0);
          scoreA=a;scoreB=b;updateScores();
          // kun bump den som endret seg
          if(prevA!==null && a!==prevA)((a>prevA)?bumpPlus:bumpMinus)($('#scoreA'));
          if(prevB!==null && b!==prevB)((b>prevB)?bumpPlus:bumpMinus)($('#scoreB'));
          prevA=a; prevB=b;
          clearWinner();
          $('#winnerMsg').textContent=v.msg||'';
          queueFit();
        })
      }else{
        var to=0;window.pushStateThrottled=function(){clearTimeout(to);to=setTimeout(function(){db.ref('games/'+stableId).set(getState())},250)};
        window.pushStateNow=function(){clearTimeout(to);return db.ref('games/'+stableId).set(getState())};
        db.ref('games/'+stableId+'/online').onDisconnect().set(false);
        db.ref('games/'+stableId+'/online').set(true);
        window.pushStateNow();
      }
    }catch(e){console.warn('Firebase feil, lokal modus',e)}}
    loadScript('https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js',function(){loadScript('https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js',onReady)})
  }

  // ---------- Resets ----------
  function resetSet(){scoreA=0;scoreB=0;swappedAt11=false;updateScores();fitScores();saveLiveState();if(window.pushStateThrottled)window.pushStateThrottled()}
  function startNewMatch(){scoreA=0;scoreB=0;setsA=0;setsB=0;currentSet=1;swappedAt11=false;locked=false;setHistory=[];$('#winnerMsg').textContent='';clearWinner();$('#matchSummary').style.display='none';document.body.classList.remove('areas-active');tempNamesUnlocked=false;updateEditableState();updateScores();fitScores();saveLiveState();if(window.pushStateThrottled)window.pushStateThrottled()}

  // ---------- Init ----------
  function init(){
    updateScores();fitScores();
    if(IS_SPECTATOR){
      document.body.classList.remove('areas-active');
      document.body.classList.remove('editing');
      $('#kebab').style.display='none';$('#menuPanel').style.display='none';
    }else{
      $('#kebab').style.display='block';
      bindLongPressOne($('#scoreA'),function(){removePoint('A')});bindLongPressOne($('#scoreB'),function(){removePoint('B')});
      bindTap($('#scoreA'),function(){addPoint('A')});bindTap($('#scoreB'),function(){addPoint('B')});
      bindLongPressOne($('#leftArea'),function(){removePointByPosition('left')});bindLongPressOne($('#rightArea'),function(){removePointByPosition('right')});
      bindTap($('#leftArea'),function(){addPointByPosition('left')});bindTap($('#rightArea'),function(){addPointByPosition('right')});
    }
    setupFirebase();
  }

  document.addEventListener('DOMContentLoaded',function(){
    var restored=restoreLiveState();
    if(!restored&&!IS_SPECTATOR){try{var last=JSON.parse(localStorage.getItem(LS_LAST)||'[]');if(last&&last.length===2){$('#nameA').value=last[0];$('#nameB').value=last[1]}}catch(e){}}
    renderHistory();init();
  });

  // Expose (debug)
  window.startNewMatch=startNewMatch;window.resetSet=resetSet;window.swapSides=swapSides;

})();</script>
</body></html>
