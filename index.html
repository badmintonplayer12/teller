<!DOCTYPE html> 
<html lang="no">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Badminton Poengteller</title>
<!--
vNext highlights
- RTDB path: games/<gameId> (no UID in URL). hostUid stored once, validated by rules.
- Anonymous Firebase auth; spectator needs only ?mode=spectator&game=ID
- Reliable realtime (ref.on('value') for spectator, throttled ref.set for control) + presence flag
- Play gate + separate, clean "Rediger navn" modal (with recent-name dropdowns)
- Long-press-to-decrement w/ suppression (no accidental +1 on mouse-up, Chrome/Win fix)
- Stats view toggle; QR share (qrcodejs) w/ copy/share; clear local storage; kebab pulse hint
- Scrollbars hidden in match view; autoscale digits; glow animations; set swap & autoswap @11 in set 3
-->
<style>
:root{--gap:clamp(12px,3vw,36px);--divider:2px;--accent:#60a5fa;--minus:#ef4444}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1224;color:#fff;display:flex;flex-direction:column;max-width:100vw;overflow-x:hidden;user-select:none}
body.no-scroll{overflow-y:hidden}

/* layout */
.wrap{flex:1 1 auto;min-height:100vh;display:grid;grid-template-columns:1fr var(--divider) 1fr;column-gap:var(--gap);padding:var(--gap);align-items:stretch;overflow:hidden;position:relative}
.divider{width:var(--divider);background:#1e293b;z-index:2}
.side{position:relative;background:#0f172a;border-radius:.8rem;padding:clamp(8px,1.8vw,16px);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow:hidden;will-change:transform;transition:transform 1s ease;z-index:1}
.wrap.swap-go .left{transform:translateX(calc(100% + var(--gap) + var(--divider)))}
.wrap.swap-go .right{transform:translateX(calc(-100% - var(--gap) - var(--divider)))}
.no-trans .side{transition:none!important}

/* name chips */
.name{min-height:clamp(36px,6vh,56px);display:flex;align-items:center;justify-content:center;width:100%;margin:.6rem 0 .25rem 0;position:relative}
.name .chip{background:#111827;border:1px solid #0008;border-radius:.5rem;min-width:12ch;max-width:22ch;padding:.35rem .8rem}
.name .chip span{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.setCounter{position:absolute;right:-.35rem;top:50%;transform:translate(0,-50%);background:var(--accent);color:#061a2e;font-weight:900;border-radius:999px;padding:.18rem .62rem;min-width:2rem;text-align:center;box-shadow:0 0 10px rgba(96,165,250,.45),0 0 24px rgba(59,130,246,.35);display:none}
@media (max-width:520px){ .setCounter{ right:-.15rem } }

/* scores */
.scoreBox{flex:1 1 auto;width:100%;min-height:0;display:flex;align-items:center;justify-content:center;overflow:visible}
.score{width:100%;display:flex;justify-content:center;align-items:center;text-align:center;font-weight:900;line-height:.92;cursor:pointer;white-space:nowrap;overflow:visible;font-variant-numeric:tabular-nums;will-change:transform,text-shadow;padding:0 2vw;transition:color .6s,text-shadow .6s}
.digits{display:flex;gap:.08em;align-items:baseline;max-width:100%;overflow:visible}
.digit{display:inline-block;width:1ch;text-align:center}
.digit.ghost{visibility:hidden}

/* animations */
.pop{animation:glowBurst .55s ease-out 1}
.popMinus{animation:minusBurst .55s ease-out 1}
@keyframes glowBurst{0%{text-shadow:0 0 0 rgba(96,165,250,0);transform:scale(1)}20%{text-shadow:0 0 30px rgba(96,165,250,.95),0 0 70px rgba(59,130,246,.8),0 0 110px rgba(37,99,235,.7);transform:scale(1.08)}60%{text-shadow:0 0 20px rgba(96,165,250,.55),0 0 50px rgba(59,130,246,.45);transform:scale(1.03)}100%{text-shadow:0 0 0 rgba(96,165,250,0);transform:scale(1)}}
@keyframes minusBurst{0%{text-shadow:0 0 0 rgba(239,68,68,0);transform:scale(1)}20%{text-shadow:0 0 30px rgba(239,68,68,.95),0 0 70px rgba(239,68,68,.7),0 0 110px rgba(185,28,28,.6);transform:scale(0.96)}60%{text-shadow:0 0 20px rgba(239,68,68,.5),0 0 50px rgba(185,28,28,.4);transform:scale(0.985)}100%{text-shadow:0 0 0 rgba(239,68,68,0);transform:scale(1)}}
.winner,.winnerName{color:#ffd700!important;animation:goldPulse 3s ease-in-out infinite}
@keyframes goldPulse{0%{text-shadow:0 0 3px rgba(255,215,0,.25),0 0 6px rgba(255,220,50,.2)}50%{text-shadow:0 0 8px rgba(255,215,0,.5),0 0 16px rgba(255,220,50,.4)}100%{text-shadow:0 0 3px rgba(255,215,0,.25),0 0 6px rgba(255,220,50,.2)}}

#sets{padding:.35rem 1rem .2rem;text-align:center;font-size:1rem;display:none}
#winnerMsg{padding:.4rem 1rem 0;text-align:center;font-size:clamp(1.1rem,3.5vw,2rem);color:#facc15;font-weight:900;white-space:pre-line}

/* click areas */
.clickArea{position:absolute;top:0;bottom:0;width:calc(50% - 24px);z-index:3;background:transparent;pointer-events:none}
.areas-active .clickArea{pointer-events:auto;touch-action:pan-y}
.clickArea.left{left:0}
.clickArea.right{right:0}

/* kebab */
#kebab{position:fixed;top:10px;right:10px;z-index:50;background:#0f172a;border:1px solid #233454;border-radius:.6rem;padding:.35rem .55rem;cursor:pointer;display:none}
#kebab svg{display:block;width:20px;height:20px}
#kebab.pulse{box-shadow:0 0 0 0 rgba(96,165,250,.55);animation:kebabPulse 1.8s ease-out 2}
@keyframes kebabPulse{0%{box-shadow:0 0 0 0 rgba(96,165,250,.55)}70%{box-shadow:0 0 0 14px rgba(96,165,250,0)}100%{box-shadow:0 0 0 0 rgba(96,165,250,0)}}
#menuPanel{position:fixed;top:46px;right:10px;background:#0b1224;border:1px solid #122042;border-radius:.6rem;box-shadow:0 8px 28px rgba(0,0,0,.45);z-index:51;display:none;min-width:240px}
.menuItem{display:flex;align-items:center;gap:.6rem;padding:.55rem .7rem;cursor:pointer;color:#e5e7eb}
.menuItem:hover{background:#0f1a33}
.menuHR{height:1px;background:#1e293b;margin:.25rem 0}

/* share */
#shareMask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
#shareCard{background:#0b1224;border:1px solid #122042;border-radius:.8rem;padding:1rem;max-width:92vw;width:min(560px,92vw)}
#qrBox{display:block;margin:.5rem auto;background:#0f172a;border:1px solid #233454;border-radius:.4rem;padding:.5rem;min-width:240px;text-align:center}
.shareRow{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:.5rem}
.button{font:inherit;border:0;border-radius:.5rem;padding:.45rem .7rem;cursor:pointer;background:#243147;color:#e5e7eb;border:1px solid #32425f}
.button.ghost{background:transparent}
#toast{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #233454;color:#e5e7eb;padding:.45rem .7rem;border-radius:.5rem;z-index:70;display:none}

/* Name modal (separate screen) */
#nameMask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:65}
.nameCard{background:#0b1224;border:1px solid #122042;border-radius:1rem;padding:1rem 1.2rem;width:min(560px,92vw);max-width:calc(100vw - 2rem)}
.nameRow{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
.nameField{display:flex;flex-direction:column;gap:.3rem;min-width:0}
.nameField label{font-size:.85rem;color:#93c5fd}
.nameField input{font:inherit;background:#111827;color:#e5e7eb;border:1px solid #233454;border-radius:.6rem;padding:.5rem .7rem;width:100%;box-sizing:border-box}
.autocomplete{position:relative;display:block;width:100%}
.autocomplete input{padding-right:2.5rem;width:100%;box-sizing:border-box}
.dropdown-btn{position:absolute;right:.5rem;top:50%;transform:translateY(-50%);background:none;border:none;color:#94a3b8;cursor:pointer;font-size:.8rem;padding:.2rem;border-radius:.2rem;transition:color .2s}
.dropdown-btn:hover{color:#e2e8f0;background:rgba(255,255,255,.1)}
/* Dropdown i flukt med input-feltet */
.autocomplete-items{
  position: absolute;
  /* trekk den opp 1px så kantene møtes uten "glippe" */
  top: calc(100% - 1px);
  left: 0;
  right: 0;

  /* samme kant som input, men uten top-kant */
  border: 1px solid #233454;
  border-top: none;

  /* samme radius som input – kun nede */
  border-radius: 0 0 .6rem .6rem;

  background: #111827;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  overflow: hidden;            /* klipp runde hjørner riktig */
  z-index: 1000;               /* over annet innhold i modalen */
  max-height: 200px;           /* behold høydebegrensning */
  /* fjern eventuelle interne margins/padding som kan skape skjevhet */
  margin: 0;
}

.autocomplete-items div{
  padding: .6rem .8rem;
  border-bottom: 1px solid #233454;
}
.autocomplete-items div:last-child{ border-bottom: 0; }
.autocomplete-active{background-color:#60a5fa !important;color:#061a2e !important}
.modalActions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:1rem}

/* hide webkit scrollbar in match - DISABLED FOR DEBUGGING */
/* .wrap::-webkit-scrollbar{display:none} */

/* Modal Base Styles */
.modalMask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modalBox {
  background: #0f172a;
  border-radius: 1rem;
  padding: 1.5rem;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  border: 1px solid #1e293b;
}

.modalHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #1e293b;
}

.modalHeader h2 {
  margin: 0;
  color: #e2e8f0;
  font-size: 1.5rem;
}

.closeBtn {
  background: none;
  border: none;
  color: #94a3b8;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 0.25rem;
  transition: color 0.2s;
}

.closeBtn:hover {
  color: #e2e8f0;
  background: rgba(255, 255, 255, 0.1);
}

.modalContent {
  margin-bottom: 1.5rem;
}

.modalActions {
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btnPrimary {
  background: var(--accent);
  color: #061a2e;
}

.btnPrimary:hover {
  background: #60a5fa;
  transform: translateY(-1px);
}

.btnSecondary {
  background: #374151;
  color: #e2e8f0;
}

.btnSecondary:hover {
  background: #4b5563;
  transform: translateY(-1px);
}

/* Summary Modal */
.summaryModal {
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
}

.winnerAnnouncement {
  text-align: center;
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: rgba(96, 165, 250, 0.1);
  border-radius: 0.5rem;
  border: 1px solid rgba(96, 165, 250, 0.3);
}

.summaryTable {
  margin: 1rem 0;
}

.summaryTable h3 {
  margin: 0 0 0.8rem 0;
  font-size: 1.1rem;
  color: #e2e8f0;
}

.summaryTable table {
  width: 100%;
  border-collapse: collapse;
  background: rgba(15, 23, 42, 0.5);
  border-radius: 0.5rem;
  overflow: hidden;
}

.summaryTable th,
.summaryTable td {
  padding: 0.6rem 0.8rem;
  text-align: center;
  border-bottom: 1px solid rgba(30, 41, 59, 0.5);
}

.summaryTable th {
  background: rgba(30, 41, 59, 0.8);
  font-weight: 600;
  color: #cbd5e1;
}

.summaryTable td {
  color: #e2e8f0;
}

.summaryTable tbody tr:last-child td {
  border-bottom: none;
}

.summaryTable tbody tr:hover {
  background: rgba(30, 41, 59, 0.3);
}

/* Statistics Styles */
.summary {
  margin: .8rem clamp(12px, 3vw, 36px) 0;
  background: #0b1224;
  border: 1px solid #0b1224;
  border-radius: .8rem;
  padding: 1rem;
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: .6rem;
  margin-bottom: 1rem;
}

.stat {
  background: #0f1a33;
  border: 1px solid #122042;
  border-radius: .6rem;
  padding: .6rem .7rem;
  text-align: center;
}

.stat .muted {
  opacity: .85;
  font-size: .8rem;
}

.leader {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: .35rem .6rem;
}

#statsHost {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #0b1224;
  overflow-y: auto;
  z-index: 50;
  padding: 1rem;
}

/* Override z-index when in stats mode */
body.stats-mode #kebab {
  z-index: 1001;
}

body.stats-mode #menuPanel {
  z-index: 1002;
}

#statsHost table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

#statsHost th,
#statsHost td {
  padding: 0.5rem;
  text-align: left;
  border-bottom: 1px solid #1e293b;
}

#statsHost th {
  background: #1e293b;
  font-weight: 600;
}

#statsHost tr:hover {
  background: rgba(30, 41, 59, 0.3);
}

/* Summary Button */
.summaryBtn {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: #061a2e;
  border: none;
  border-radius: 2rem;
  padding: 1rem 2rem;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 25px rgba(96, 165, 250, 0.4);
  transition: all 0.3s ease;
  z-index: 10;
  animation: pulse 2s infinite;
}

.summaryBtn:hover {
  background: #60a5fa;
  transform: translateX(-50%) translateY(-2px);
  box-shadow: 0 12px 35px rgba(96, 165, 250, 0.6);
}

.summaryBtn:active {
  transform: translateX(-50%) translateY(0);
}

@keyframes pulse {
  0% {
    box-shadow: 0 8px 25px rgba(96, 165, 250, 0.4);
  }
  50% {
    box-shadow: 0 8px 25px rgba(96, 165, 250, 0.8);
  }
  100% {
    box-shadow: 0 8px 25px rgba(96, 165, 250, 0.4);
  }
}
</style>
</head>
<body>

<div id="sets" aria-live="polite">Sett: 0-0</div>

<div class="wrap" id="wrap">
  <div class="clickArea left" id="leftArea" aria-label="Legg til poeng venstre"></div>
  <div class="clickArea right" id="rightArea" aria-label="Legg til poeng høyre"></div>

  <div class="side left" id="sideA">
    <div class="name"><div class="chip"><span id="nameA_chip">Spiller A</span></div><div id="setCounterA" class="setCounter">0</div></div>
    <div class="scoreBox"><div class="score" id="scoreA"><span class="digits" id="A_digits"><span class="digit" id="A_tens">0</span><span class="digit" id="A_ones">0</span></span></div></div>
  </div>

  <div class="divider"></div>

  <div class="side right" id="sideB">
    <div class="name"><div class="chip"><span id="nameB_chip">Spiller B</span></div><div id="setCounterB" class="setCounter">0</div></div>
    <div class="scoreBox"><div class="score" id="scoreB"><span class="digits" id="B_digits"><span class="digit" id="B_tens">0</span><span class="digit" id="B_ones">0</span></span></div></div>
  </div>
</div>

<div id="winnerMsg"></div>

<!-- Show Summary Button -->
<button id="showSummaryBtn" class="summaryBtn" style="display:none">
  📊 Vis kampsammendrag
</button>

<!-- Next Set Button (control only) -->
<button id="nextSetBtn" class="summaryBtn" style="display:none">
  ▶ Neste sett
</button>

<!-- Match Summary Modal -->
<div id="summaryMask" class="modalMask" style="display:none">
  <div class="modalBox summaryModal">
    <div class="modalHeader">
      <h2>🏆 Kamp ferdig!</h2>
      <button id="summaryClose" class="closeBtn" aria-label="Lukk">×</button>
    </div>
    
    <div class="modalContent">
      <div id="summaryWinner" class="winnerAnnouncement"></div>
      
      <div class="summaryTable">
  <h3>Kampsammendrag</h3>
  <table>
          <thead>
            <tr>
              <th>Sett</th>
              <th id="sumNameA">Spiller A</th>
              <th id="sumNameB">Spiller B</th>
              <th>Vinner</th>
            </tr>
          </thead>
    <tbody id="summaryBody"></tbody>
  </table>
      </div>
</div>

    <div class="modalActions">
      <button id="btnNewMatch" class="btn btnPrimary">🆕 Start ny kamp</button>
      <button id="btnCloseSummary" class="btn btnSecondary">Lukk</button>
    </div>
  </div>
</div>

<!-- kebab -->
<div id="kebab" aria-label="Meny" title="Meny" role="button" tabindex="0">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
</div>
<div id="menuPanel" role="menu" aria-label="Hovedmeny"></div>

<!-- share -->
<div id="shareMask" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
  <div id="shareCard">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
      <div id="shareTitle" style="font-weight:700">Del tilskuervy</div>
      <button id="shareClose" class="button ghost" aria-label="Lukk">✕</button>
    </div>
    <div id="qrBox" aria-label="QR-kode"></div>
    <div style="text-align:center;word-break:break-all;margin-top:.25rem;font-size:.85rem;color:#93c5fd" id="shareUrl"></div>
    <div class="shareRow">
      <button id="btnCopy" class="button">Kopier lenke</button>
      <button id="btnOpenSpectator" class="button">Åpne tilskuer</button>
      <button id="btnWebShare" class="button" style="display:none">Del via…</button>
    </div>
  </div>
</div>

<!-- Name modal (used at start + when choosing Edit names) -->
<div id="nameMask">
  <div class="nameCard">
    <h3 style="margin:.2rem 0 1rem 0">Spillernavn</h3>
    <div class="nameRow">
      <div class="nameField">
        <label for="nameA">Venstre</label>
        <div class="autocomplete">
          <input id="nameA" placeholder="Spiller A" autocomplete="off"/>
          <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameA')">▼</button>
          <div id="nameA-list" class="autocomplete-items"></div>
        </div>
      </div>
      <div class="nameField">
        <label for="nameB">Høyre</label>
        <div class="autocomplete">
          <input id="nameB" placeholder="Spiller B" autocomplete="off"/>
          <button type="button" class="dropdown-btn" onclick="toggleDropdown('nameB')">▼</button>
          <div id="nameB-list" class="autocomplete-items"></div>
        </div>
      </div>
    </div>
    <div class="modalActions">
      <button id="btnCancelNames" class="button ghost">Avbryt</button>
      <button id="btnSaveNames" class="button">Lagre</button>
      <button id="btnStart" class="button" style="background:#60a5fa;color:#061a2e">Start kamp</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
(function(){
'use strict';
/* ===== Helpers ===== */
  function $(s){return document.querySelector(s)}
function toast(msg){var t=$('#toast'); if(!t) return; t.textContent=msg; t.style.display='block'; setTimeout(function(){t.style.display='none'},1400)}
function qs(name){try{return new URL(location.href).searchParams.get(name)}catch(e){return null}}
function setBodyScroll(match){document.body.classList.toggle('no-scroll', !!match)}

/* ===== Constants ===== */
var LONGPRESS_MS=800, MOVE_THRESH=16;
var LS_MATCHES='badm_matches_v1', LS_LAST='badm_last_names_v1', LS_LIVE='badm_live_v1', LS_GAMEID='badm_game_id_v3', LS_KB_TIP='badm_kebab_tip_v1', LS_PREV='badm_prev_names_v3';
var MODE=(qs('mode')||'control').toLowerCase();
  var IS_SPECTATOR=MODE==='spectator';
window.VIEW_MODE='match';

/* ===== State ===== */
  var scoreA=0,scoreB=0,setsA=0,setsB=0,target=21,cap=30,currentSet=1,swappedAt11=false,locked=false,swapping=false,betweenSets=false,pendingSetWinner=null;
var setHistory=[];var allowScoring=false;var nameEditMode=false;var namesSavedThisMatch=false;

/* ===== GameId only ===== */
function makeId(n){n=n||9;var a='ABCDEFGHJKLMNPQRSTUVXYZ23456789',s='';for(var i=0;i<n;i++)s+=a[(Math.random()*a.length)|0];return s}
function ensureGameId(){try{var p=new URL(location.href).searchParams;var from=p.get('game');if(from){localStorage.setItem(LS_GAMEID,from);return from}var cur=localStorage.getItem(LS_GAMEID);if(cur)return cur;var g=makeId(9);localStorage.setItem(LS_GAMEID,g);return g}catch(e){return 'LOCALTEST'}}
var GAME_ID = IS_SPECTATOR ? (qs('game')||'') : ensureGameId();
function spectatorShareUrl(){var gid=ensureGameId();try{var u=new URL(location.href);u.searchParams.set('mode','spectator');u.searchParams.set('game',gid);return u.toString()}catch(e){return location.origin+location.pathname+'?mode=spectator&game='+encodeURIComponent(gid)}}

/* ===== Layout / swap ===== */
function setSidesDomTo(isALeftTarget){
  var wrap=$('#wrap'), A=$('#sideA'), B=$('#sideB'), div=document.querySelector('.divider');
  if(!(wrap&&A&&B&&div)) return;

  // Ta vare på "sanne" A/B med dagens layout
  var namesBefore = readABFromModalInputs();

  var aLeft=A.classList.contains('left');
  if(aLeft===isALeftTarget) return;

    wrap.classList.add('no-trans');
    try{
    if(isALeftTarget){
      A.classList.add('left'); A.classList.remove('right');
      B.classList.add('right'); B.classList.remove('left');
      wrap.insertBefore(A,wrap.firstElementChild);
      wrap.insertBefore(div,B);
      }else{
      B.classList.add('left');  B.classList.remove('right');
      A.classList.add('right'); A.classList.remove('left');
      wrap.insertBefore(B,wrap.firstElementChild);
      wrap.insertBefore(div,A);
      }
    }catch(e){}
    wrap.classList.remove('no-trans');

  // **Synk input-feltene til ny layout**
  if (!IS_SPECTATOR) {
    writeModalInputsFromAB(namesBefore.A, namesBefore.B);
    updateNameChips();
  }
  }
  function startVisualSwap(done){
  if(swapping) return;
  swapping = true;

  // Ta vare på "sanne" A/B før vi bytter layout
  var namesBefore = readABFromModalInputs();

  var wrap=$('#wrap'), left=document.querySelector('.side.left'), right=document.querySelector('.side.right'), div=document.querySelector('.divider');
  if(!(wrap&&left&&right&&div)){swapping=false;return}

  wrap.classList.add('swap-go');
  var finished=false;
  function complete(){
    if(finished) return; finished=true;
    left.removeEventListener('transitionend',onEnd);
    right.removeEventListener('transitionend',onEnd);

      try{
        wrap.classList.add('no-trans');
        wrap.insertBefore(right,left);
      if(div.parentNode!==wrap) wrap.appendChild(div);
      wrap.insertBefore(div,left);
      left.classList.remove('left'); left.classList.add('right');
      right.classList.remove('right'); right.classList.add('left');
      }catch(e){}

    wrap.classList.remove('swap-go'); void wrap.offsetWidth; wrap.classList.remove('no-trans');

    // **VIKTIG:** Synk input-feltene til ny layout
    if (!IS_SPECTATOR) {
      writeModalInputsFromAB(namesBefore.A, namesBefore.B);
      updateNameChips();
    }

    fitScores();
    swapping = false;
    saveLiveState();
    (typeof pushStateNow === 'function' ? pushStateNow() : pushStateThrottled()); // flush isALeft nå

    if (typeof done === 'function') {  // …så kan vi gjøre "etter-animasjon"
      try { done(); } catch(_) {}
    }
  }
  function onEnd(e){ if(e.target!==left&&e.target!==right) return; complete() }

  left.addEventListener('transitionend',onEnd);
  right.addEventListener('transitionend',onEnd);
    setTimeout(complete,1200);
  }
  function swapSides(){startVisualSwap()}

/* ===== Score UI ===== */
function setDigits(sc,p){var t=Math.floor(sc/10),o=sc%10,te=$('#'+p+'_tens'),oe=$('#'+p+'_ones');if(sc<10){te.textContent='0';te.classList.add('ghost')}else{te.textContent=String(t);te.classList.remove('ghost')}oe.textContent=String(o)}
function updateNameChips(){
  // I spectator skal navn KUN komme fra RTDB-snapshot (setNameChipsDirect)
  if (IS_SPECTATOR) return;
  updateNameChipsFromModal();
}
function updateScores(){
  setDigits(scoreA,'A'); setDigits(scoreB,'B');

  var cA = document.getElementById('setCounterA');
  var cB = document.getElementById('setCounterB');
  if (cA){ cA.textContent = String(setsA); cA.style.display = (setsA > 0 ? 'flex' : 'none'); }
  if (cB){ cB.textContent = String(setsB); cB.style.display = (setsB > 0 ? 'flex' : 'none'); }

  var setsEl = document.getElementById('sets');
  if (setsEl){ setsEl.textContent = 'Sett: ' + setsA + '-' + setsB; }

  updateEditableState();
  saveLiveState();
}
  function fitScores(){
  if (IS_SPECTATOR && (
      document.getElementById('A_digits')?.classList.contains('pop') ||
      document.getElementById('A_digits')?.classList.contains('popMinus') ||
      document.getElementById('B_digits')?.classList.contains('pop') ||
      document.getElementById('B_digits')?.classList.contains('popMinus')
    )) return;

  document.body.classList.add('measuring');var base=100,sA=$('#scoreA'),sB=$('#scoreB');if(!sA||!sB){document.body.classList.remove('measuring');return}sA.style.fontSize=base+'px';sB.style.fontSize=base+'px';var nameAH=(($('#sideA .name')||{}).offsetHeight)||0;var nameBH=(($('#sideB .name')||{}).offsetHeight)||0;function padY(e){var cs=getComputedStyle(e);return (parseFloat(cs.paddingTop)||0)+(parseFloat(cs.paddingBottom)||0)}var availHA=Math.max(40,(($('#sideA')||{}).clientHeight||0)-nameAH-padY($('#sideA')));var availHB=Math.max(40,(($('#sideB')||{}).clientHeight||0)-nameBH-padY($('#sideB')));function padX(e){var cs=getComputedStyle(e);return (parseFloat(cs.paddingLeft)||0)+(parseFloat(cs.paddingRight)||0)}var availWA=Math.max(40,(($('#sideA .scoreBox')||{}).clientWidth||0)-padX(sA));var availWB=Math.max(40,(($('#sideB .scoreBox')||{}).clientWidth||0)-padX(sB));var aRect=$('#A_digits').getBoundingClientRect();var bRect=$('#B_digits').getBoundingClientRect();var scaleA=Math.min(availWA/Math.max(1,aRect.width),availHA/Math.max(1,aRect.height));var scaleB=Math.min(availWB/Math.max(1,bRect.width),availHB/Math.max(1,bRect.height));var f=Math.floor(base*Math.max(.01,Math.min(scaleA,scaleB)));sA.style.fontSize=f+'px';sB.style.fontSize=f+'px';document.body.classList.remove('measuring');saveLiveState()
  }
  var queueFit=(function(){var raf=0,t=0;return function(){cancelAnimationFrame(raf);clearTimeout(t);raf=requestAnimationFrame(function(){fitScores();t=setTimeout(fitScores,60)})}})();
addEventListener('resize',queueFit); if(window.visualViewport) visualViewport.addEventListener('resize',queueFit); addEventListener('orientationchange',function(){setTimeout(queueFit,60)})
  function bumpPlus(el){if(!el)return;el.classList.remove('pop');void el.offsetWidth;el.classList.add('pop');setTimeout(function(){el.classList.remove('pop')},550)}
  function bumpMinus(el){if(!el)return;el.classList.remove('popMinus');void el.offsetWidth;el.classList.add('popMinus');setTimeout(function(){el.classList.remove('popMinus')},550)}
function clearWinner(){['#scoreA','#scoreB'].forEach(function(sel){var e=$(sel);if(e)e.classList.remove('winner')});['#nameA_chip','#nameB_chip'].forEach(function(sel){var e=$(sel);if(e)e.classList.remove('winnerName')})}

/* ===== Helpers ===== */
function isALeft() {
  var left = document.querySelector('.side.left');
  return left && left.id === 'sideA';
}

// Leser verdiene slik brukeren ser dem i modalen (Venstre/Høyre),
// og returnerer et konsistent {A, B} uansett sidebytte.
function readABFromModalInputs() {
  var leftVal  = ($('#nameA')?.value || 'Spiller A'); // label: Venstre
  var rightVal = ($('#nameB')?.value || 'Spiller B'); // label: Høyre
  return isALeft()
    ? { A: leftVal,  B: rightVal }
    : { A: rightVal, B: leftVal  };
}

// Når du skal fylle modalen, ta utgangspunkt i «sanne» A/B
// og speil dem til Venstre/Høyre basert på gjeldende sideoppsett.
function writeModalInputsFromAB(Aname, Bname) {
  if (isALeft()) {
    $('#nameA').value = Aname;  // Venstre viser A
    $('#nameB').value = Bname;  // Høyre viser B
  } else {
    $('#nameA').value = Bname;  // Venstre viser B (A står til høyre)
    $('#nameB').value = Aname;  // Høyre viser A
  }
}

// Oppdater chipper basert på "sanne" A/B utledet fra modalen.
function updateNameChipsFromModal() {
  var n = readABFromModalInputs();
  var ca = $('#nameA_chip'), cb = $('#nameB_chip');
  if (ca) ca.textContent = n.A;
  if (cb) cb.textContent = n.B;
}

/* ===== Edit / Name modal / Play gate ===== */
function showNameModal(startMode){
  nameEditMode=true;
  allowScoring=false;
  renderRecentOptions();
  $('#nameMask').style.display='flex';
  setBodyScroll(false);
  
  // Sett inn "sanne" A/B i modalen som venstre/høyre i henhold til layout
  var Aname = $('#nameA')?.value || 'Spiller A';
  var Bname = $('#nameB')?.value || 'Spiller B';
  // OBS: disse feltene har tidligere vært brukt «som kildedata».
  // Etter denne patchen blir de kun en buffer for A/B.
  writeModalInputsFromAB(Aname, Bname);
  updateNameChips();
  
  if(startMode){
    // Start kamp modus: vis Start og Avbryt
    $('#btnStart').style.display='inline-block';
    $('#btnSaveNames').style.display='none';
  } else {
    // Rediger navn modus: vis Lagre og Avbryt
    $('#btnStart').style.display='none';
    $('#btnSaveNames').style.display='inline-block';
  }
}
function hideNameModal(){nameEditMode=false;$('#nameMask').style.display='none';setBodyScroll(true);updateEditableState()}
function updateEditableState(){
  var atStart=(scoreA===0&&scoreB===0&&setsA===0&&setsB===0&&currentSet===1&&!locked);
  if(!IS_SPECTATOR && (atStart||nameEditMode) && !allowScoring){
    document.body.classList.remove('areas-active')
  }else if(!IS_SPECTATOR){
    document.body.classList.add('areas-active')
  }
  // Viktig: ikke rør navnechips i spectator
  if (!IS_SPECTATOR) updateNameChips();
}

/* ===== Logic ===== */
function maybeSaveNamesOnStart(){if(namesSavedThisMatch)return;var atStart=(scoreA===0&&scoreB===0&&setsA===0&&setsB===0&&currentSet===1&&!locked);if(!atStart){var n = readABFromModalInputs();saveLastNames(n.A,n.B);namesSavedThisMatch=true}}
function addPoint(s){if(!allowScoring||locked||swapping||IS_SPECTATOR)return;if(s==='A')scoreA++;else scoreB++;maybeSaveNamesOnStart();checkSetEnd();updateScores();bumpPlus($(s==='A'?'#scoreA':'#scoreB'));fitScores();pushStateThrottled()}
function removePoint(s){if(!allowScoring||locked||swapping||IS_SPECTATOR)return;if(s==='A'&&scoreA>0)scoreA--;if(s==='B'&&scoreB>0)scoreB--;updateScores();bumpMinus($(s==='A'?'#scoreA':'#scoreB'));fitScores();pushStateThrottled()}
  function addPointByPosition(pos){var isA=document.querySelector('.side.left').id==='sideA';addPoint((pos==='left')?(isA?'A':'B'):(isA?'B':'A'))}
  function removePointByPosition(pos){var isA=document.querySelector('.side.left').id==='sideA';removePoint((pos==='left')?(isA?'A':'B'):(isA?'B':'A'))}
  function fmtDate(ts){var d=new Date(ts);return d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
  // 1) Logg settet korrekt
function pushSetToHistory(a, b){
  var w = (a > b) ? 'A' : (b > a ? 'B' : '-');
  setHistory.push({ set: currentSet, a: a, b: b, winner: w });
  console.log('Sett lagret:', { set: currentSet, a: a, b: b, winner: w });
  console.log('setHistory nå:', setHistory);
  saveLiveState();
}
function buildWinnerMsg(w,l){return '🎉 GRATULERER '+w.toUpperCase()+'! DU VANT KAMPEN!\n👏 BRA JOBBA '+l.toUpperCase()+', DU GJORDE DITT BESTE.'}
// 2) Render sammendraget (bygger rader)
function renderSummary(finalWinnerName){
  console.log('renderSummary() kalt med winner:', finalWinnerName);
  console.log('setHistory lengde:', setHistory.length);
  console.log('setHistory innhold:', setHistory);
  
  var n = readABFromModalInputs();
  var nA = n.A, nB = n.B;

  var hA = document.getElementById('sumNameA');
  var hB = document.getElementById('sumNameB');
  if (hA) hA.textContent = nA;
  if (hB) hB.textContent = nB;

  var body = document.getElementById('summaryBody');
  if (!body) {
    console.log('FEIL: summaryBody element ikke funnet!');
    return;
  }
  body.innerHTML = '';

  for (var i = 0; i < setHistory.length; i++) {
    var s = setHistory[i];
    var tr = document.createElement('tr');

    var tdSet = document.createElement('td'); tdSet.textContent = String(s.set); tr.appendChild(tdSet);
    var tdA   = document.createElement('td'); tdA.textContent   = String(s.a);   tr.appendChild(tdA);
    var tdB   = document.createElement('td'); tdB.textContent   = String(s.b);   tr.appendChild(tdB);
    var tdW   = document.createElement('td');
    tdW.textContent = s.winner === 'A' ? nA : (s.winner === 'B' ? nB : '—');
    tr.appendChild(tdW);

      body.appendChild(tr);
    console.log('Rad lagt til:', s);
  }

  var winEl = document.getElementById('summaryWinner');
  if (winEl) winEl.textContent = finalWinnerName ? ('🎉 ' + finalWinnerName + ' vant kampen! 🎉') : '';

  // Vis modal
  var mask = document.getElementById('summaryMask');
  if (mask) {
    mask.style.display = 'flex';
    setBodyScroll(true);
    console.log('summaryMask satt til display: flex');
  } else {
    console.log('FEIL: summaryMask element ikke funnet!');
  }
    saveLiveState();
  }
function checkSetEnd(){
  var leadOk = Math.abs(scoreA - scoreB) >= 2 || scoreA === cap || scoreB === cap;

  if ((scoreA >= target || scoreB >= target) && leadOk) {
    // Hvem vant settet?
    var winner = (scoreA > scoreB) ? 'A' : 'B';

    // Logg settet (til historikk/tabell)
    pushSetToHistory(scoreA, scoreB);

    // Blir kampen avgjort av dette settet?
    var willFinish = (winner === 'A') ? (setsA + 1 >= 2) : (setsB + 1 >= 2);

    if (willFinish) {
      // Oppdater sett-teller og avslutt kampen NÅ (ingen "Neste sett"-knapp)
      if (winner === 'A') setsA++; else setsB++;
      locked = true; betweenSets = false; pendingSetWinner = null;

      var n = readABFromModalInputs();
      var wName = (winner === 'A') ? n.A : n.B;
      var lName = (winner === 'A') ? n.B : n.A;

      $('#winnerMsg').textContent =
        '🎉 GRATULERER ' + wName.toUpperCase() + '! DU VANT KAMPEN!\n' +
        '👏 BRA JOBBA ' + lName.toUpperCase() + ', DU GJORDE DITT BESTE.';

      if (winner === 'A') {
        $('#scoreA')?.classList.add('winner');
        $('#nameA_chip')?.classList.add('winnerName');
      } else {
        $('#scoreB')?.classList.add('winner');
        $('#nameB_chip')?.classList.add('winnerName');
      }

      // Vis sammendragsknappen
      var summaryBtn = document.getElementById('showSummaryBtn');
      if (summaryBtn) summaryBtn.style.display = 'block';

      // Lagre kampen i historikk
      var obj = { ts: Date.now(), names: {A:n.A, B:n.B}, sets: setHistory.slice(), winner: wName };
      var arr = loadMatches(); arr.unshift(obj); saveMatches(arr); saveLastNames(n.A, n.B);

      updateScores(); fitScores(); saveLiveState(); pushStateThrottled();
      return;
    }

    // --- Sett pause mellom sett (stopp på 21) ---
    // Øk sett-telleren NÅ, men behold 21–x på skjermen
    if (winner === 'A') setsA++; else setsB++;
    pendingSetWinner = winner;
    betweenSets = true;
    locked = true;

    // Vis "Neste sett" bare i kontroll-modus
    var ns = document.getElementById('nextSetBtn');
    if (ns && !IS_SPECTATOR) ns.style.display = 'block';

    updateScores(); fitScores(); saveLiveState(); pushStateThrottled();
    return;
  }

  // Autoswap ved 11 i tredje sett (uendret)
  if (currentSet === 3 && !swappedAt11 && (scoreA === 11 || scoreB === 11)) {
    startVisualSwap();
    swappedAt11 = true;
  }

  saveLiveState();
}

function advanceToNextSet(){
  if (!betweenSets) return;

  // Lås under animasjonen og skjul knappen
  locked = true;
  var ns = document.getElementById('nextSetBtn');
  if (ns) ns.style.display = 'none';

  // Forbered ny setttilstand (men ikke rør poeng før etter swap)
  currentSet++;
  swappedAt11 = false;

  startVisualSwap(function afterSwap(){
    // Nå er animasjonen ferdig – nullstill poeng
    scoreA = 0;
    scoreB = 0;

    betweenSets = false;
    pendingSetWinner = null;
    locked = false;

    updateScores();
    fitScores();
    saveLiveState();

    // Vent litt lenger enn CSS-transition (1s) før vi sender 0–0 til RTDB
    setTimeout(function(){
      if (typeof pushStateNow === 'function') pushStateNow();
      else pushStateThrottled();
    }, 1050); // justér om du endrer animasjonsvarighet
  });
}

/* ===== History + recent names ===== */
function loadMatches(){try{var raw=localStorage.getItem(LS_MATCHES);return raw?JSON.parse(raw):[]}catch(e){return[]}}
  function saveMatches(list){try{localStorage.setItem(LS_MATCHES,JSON.stringify(list))}catch(e){}}
  function saveMatchToHistory(){var n = readABFromModalInputs();var nA = n.A, nB = n.B;var winner=setsA===2?nA:nB;var obj={ts:Date.now(),names:{A:nA,B:nB},sets:setHistory.slice(),winner:winner};var arr=loadMatches();arr.unshift(obj);saveMatches(arr);saveLastNames(nA,nB);clearLiveState()}
function getPrevNames(){try{var arr=JSON.parse(localStorage.getItem(LS_PREV)||'[]');return Array.isArray(arr)?arr:[]}catch(e){return[]}}
function setPrevNames(arr){try{localStorage.setItem(LS_PREV,JSON.stringify(arr.slice(0,100)))}catch(e){}}
function pushPrev(n){n=(n||'').trim();if(!n)return;var arr=getPrevNames().filter(function(x){return x!==n});arr.unshift(n);setPrevNames(arr)}
function getRecentNames(limit){return getPrevNames().slice(0,limit||6)}
function renderRecentOptions(){
  // Autocomplete funksjonalitet er nå integrert i input-feltene
  // Denne funksjonen er ikke lenger nødvendig, men beholdes for kompatibilitet
}
function saveLastNames(a,b){try{localStorage.setItem(LS_LAST,JSON.stringify([a,b]))}catch(e){}pushPrev(a);pushPrev(b);renderRecentOptions();updateNameChips()}

/* ===== Live state ===== */
  function clearLiveState(){try{localStorage.removeItem(LS_LIVE)}catch(e){}}
var saveLiveState=(function(){var to=0;return function(){clearTimeout(to);to=setTimeout(function(){try{var n = readABFromModalInputs();var data={scoreA:scoreA,scoreB:scoreB,setsA:setsA,setsB:setsB,currentSet:currentSet,swappedAt11:swappedAt11,locked:locked,setHistory:setHistory,names:{A:n.A,B:n.B},isALeft:$('#sideA')?$('#sideA').classList.contains('left'):true,winnerMsg:($('#winnerMsg')&&$('#winnerMsg').textContent)||'',summaryVisible:($('#summaryMask')&&$('#summaryMask').style.display==='flex'),allowScoring:allowScoring,nameEditMode:nameEditMode,betweenSets:betweenSets};localStorage.setItem(LS_LIVE,JSON.stringify(data))}catch(e){}},80)}})();
function restoreLiveState(){try{var raw=localStorage.getItem(LS_LIVE);if(!raw)return false;var d=JSON.parse(raw);if(!d)return false;scoreA=d.scoreA||0;scoreB=d.scoreB||0;setsA=d.setsA||0;setsB=d.setsB||0;currentSet=d.currentSet||1;swappedAt11=!!d.swappedAt11;locked=!!d.locked;setHistory=Array.isArray(d.setHistory)?d.setHistory:[];$('#nameA').value=(d.names&&d.names.A)||'Spiller A';$('#nameB').value=(d.names&&d.names.B)||'Spiller B';if (!IS_SPECTATOR) updateNameChips();setSidesDomTo(!(d.isALeft===false));$('#winnerMsg').textContent=d.winnerMsg||'';if(d.summaryVisible){var mask=document.getElementById('summaryMask');if(mask){mask.style.display='flex';setBodyScroll(true)}}allowScoring=!!d.allowScoring;nameEditMode=!!d.nameEditMode;betweenSets=!!d.betweenSets;var ns=document.getElementById('nextSetBtn');if(ns)ns.style.display=(!IS_SPECTATOR&&betweenSets)?'block':'none';return true}catch(e){return false}}

/* ===== Fullscreen ===== */
  function toggleFullscreen(){if(!document.fullscreenElement){document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}else{document.exitFullscreen&&document.exitFullscreen()}}

/* ===== Long-press decrement (no accidental +1) ===== */
function bindLongPressOne(el, action){
  var tid = 0, px = 0, py = 0, down = false, didLong = false, scrollY0 = 0;
  var swallowNextClick = false; // <- blokker kun neste click etter long-press

  function vibrate(m){ try{ if(navigator.vibrate) navigator.vibrate(m) }catch(_){} }

  function start(x, y){
    down = true; didLong = false;
    px = x; py = y; scrollY0 = window.scrollY;
    clearTimeout(tid);
    tid = setTimeout(function(){
      if(!down || didLong) return;
      didLong = true;
      swallowNextClick = true;   // blokker release-klikket én gang
      action();
      vibrate(60);
    }, LONGPRESS_MS);
  }

  function cancel(){ down = false; clearTimeout(tid) }

  // Blokker bare DET FØRSTE klikket etter en long-press-release
  el.addEventListener('click', function(e){
    if (swallowNextClick){
      swallowNextClick = false;          // brukt opp
      e.stopPropagation();
      e.preventDefault();
    }
  }, true);

  el.addEventListener('pointerdown', function(e){
    if(e.pointerType === 'mouse' && e.button !== 0) return;
    if(el.setPointerCapture) el.setPointerCapture(e.pointerId);
    // Ny gest: sørg for at vi IKKE lenger blokkerer – muliggjør umiddelbar +1
    swallowNextClick = false;
    start(e.clientX, e.clientY);
  }, {passive:true});

  el.addEventListener('pointermove', function(e){
    if(!down) return;
    if(Math.hypot(e.clientX - px, e.clientY - py) > MOVE_THRESH ||
       Math.abs(window.scrollY - scrollY0) > 2){
      cancel();
    }
  }, {passive:true});

  ['pointerup','pointercancel','pointerleave','lostpointercapture','blur']
    .forEach(function(ev){
      el.addEventListener(ev, function(){ cancel() }, {passive:true});
    });
}
function bindTap(el,fn){el&&el.addEventListener('click',fn)}

/* ===== Menu ===== */
  var kebab=$('#kebab'), panel=$('#menuPanel');
function menuItem(id,label){return '<div class="menuItem" id="'+id+'" role="menuitem">'+label+'</div>'}
  function renderMenu(){
  var VM = window.VIEW_MODE || 'match';
  console.log('renderMenu: KALLT - VM er:', VM, 'window.VIEW_MODE er:', window.VIEW_MODE);
  
  if(IS_SPECTATOR){
    kebab.style.display='none';
    panel.style.display='none';
    return;
  }
  
var html='';
if(VM==='match'){
  console.log('renderMenu: Lager kamp-modus meny');
html+=menuItem('miShare','🔗 Del…');
html+=menuItem('miNewMatch','🆕 Start ny kamp');
html+=menuItem('miResetSet','♻️ Nullstill sett');
html+=menuItem('miSwap','⇄ Bytt side');
html+='<div class="menuHR"></div>';
html+=menuItem('miEditNames','✏️ Rediger spillernavn');
html+=menuItem('miClearStorage','🗑️ Nullstill lagret data');
html+=menuItem('miFullscreen','⛶ Fullskjerm');
html+=menuItem('miStats','📊 Vis statistikk');
} else if(VM==='stats'){
  console.log('renderMenu: Lager statistikk-modus meny');
html+=menuItem('miBackToMatch','↩︎ Vis kamp');
html+='<div class="menuHR"></div>';
html+=menuItem('miFullscreen','⛶ Fullskjerm');
html+=menuItem('miClearStorage','🗑️ Nullstill lagret data');
} else {
  console.log('renderMenu: Ukjent VM:', VM);
}
  
panel.innerHTML=html;
  
  var bind=function(id,fn){
    var e=document.getElementById(id);
    if(e) e.onclick=function(){
      panel.style.display='none';
      fn();
    };
  };
  
bind('miShare',openShare);
bind('miNewMatch',startNewMatch);
bind('miResetSet',resetSet);
bind('miSwap',swapSides);
  bind('miEditNames',function(){showNameModal(false)});
  bind('miClearStorage',function(){try{localStorage.clear();toast('Lagret data slettet')}catch(e){toast('Kunne ikke slette')}location.reload()});
bind('miFullscreen',toggleFullscreen);
  bind('miStats',function(){renderStats(loadMatches())});
  bind('miBackToMatch',showMatch);
}
  function togglePanel(){panel.style.display=(panel.style.display==='block')?'none':'block'}
  function closePanel(){panel.style.display='none'}
kebab.addEventListener('click',function(e){e.stopPropagation();togglePanel()});document.addEventListener('click',function(e){if(!panel.contains(e.target)&&e.target!==kebab)closePanel()});document.addEventListener('keydown',function(e){if(e.key==='Escape'){closePanel();closeShare()}})

/* ===== Share dialog (QR) ===== */
  function loadScriptOnce(src,cb){if(document.querySelector('script[data-dyn="'+src+'"]')){cb();return}var s=document.createElement('script');s.src=src;s.async=true;s.setAttribute('data-dyn',src);s.onload=function(){cb()};s.onerror=function(){cb(new Error('load-fail'))};document.head.appendChild(s)}
function ensureQrLib(cb){if(window.QRCode){cb(null);return}loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',function(err){if(!err&&window.QRCode)cb(null);else cb(new Error('no-lib'))})}
function openShare(){var url=spectatorShareUrl();var box=document.getElementById('qrBox');document.getElementById('shareUrl').textContent=url;box.innerHTML='';ensureQrLib(function(err){if(!err&&window.QRCode){new QRCode(box,{text:url,width:280,height:280,colorDark:'#ffffff',colorLight:'#0f172a',correctLevel:QRCode.CorrectLevel.Q})}else{box.innerHTML='<div style="color:#fbbf24;text-align:center">QR utilgjengelig – bruk lenken under.</div>'}document.getElementById('shareMask').style.display='flex';var wsb=document.getElementById('btnWebShare');wsb.style.display=(navigator.share?'inline-block':'none')})}
function closeShare(){document.getElementById('shareMask').style.display='none'}
(function(){var b=document.getElementById('shareClose');if(b)b.addEventListener('click',closeShare)})();
(function(){var c=document.getElementById('btnCopy');if(c)c.addEventListener('click',function(){var url=document.getElementById('shareUrl').textContent;if(navigator.clipboard&&window.isSecureContext){navigator.clipboard.writeText(url).then(function(){toast('Lenke kopiert')})}else{try{var ta=document.createElement('textarea');ta.value=url;ta.style.position='fixed';ta.style.top='-1000px';document.body.appendChild(ta);ta.focus();ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('Lenke kopiert')}catch(e){toast('Kopier mislyktes')}}})})();
(function(){var o=document.getElementById('btnOpenSpectator');if(o)o.addEventListener('click',function(){var url=document.getElementById('shareUrl').textContent;window.open(url,'_blank')})})();
(function(){var w=document.getElementById('btnWebShare');if(w)w.addEventListener('click',function(){var url=document.getElementById('shareUrl').textContent;if(navigator.share)navigator.share({title:'Tilskuervy',text:'Badminton teller',url:url}).catch(function(){})})})();

/* ===== Stats shell (rendered on demand) ===== */
  function ensureStatsShell(){
  var ex = document.getElementById('statsHost');
  if (ex) return ex;
  
  var host = document.createElement('div');
  host.id = 'statsHost';
  host.className = 'summary';
  host.style.display = 'none';
  host.innerHTML = 
    '<h3>Alle kamper & oversikt</h3>' +
    '<div id="stats" class="stats"></div>' +
    '<div id="leaderboard"></div>' +
    '<div style="height:.6rem"></div>' +
    '<table>' +
      '<thead><tr>' +
        '<th>#</th><th>Dato</th><th>Spiller A</th><th>Spiller B</th><th>Sett</th><th>Vinner</th><th>Handling</th>' +
      '</tr></thead>' +
      '<tbody id="historyBody"></tbody>' +
    '</table>';
  document.body.appendChild(host);
  return host;
}

function fmtStats(arr) {
  var stats = {
    matches: arr.length,
    sets: 0,
    straight: 0,      // 2–0-kamper
    three: 0,         // 2–1-kamper
    deuceSets: 0,     // sett som nådde ≥20–20
    avgMargin: 0,     // snitt seiersmargin per sett
    maxTotalSet: null // {a,b,names}
  };
  var marginSum = 0;

  for (var i = 0; i < arr.length; i++) {
    var m = arr[i];
    var sets = m.sets || [];
    stats.sets += sets.length;
    var wins = [0, 0]; // [A,B]

    for (var j = 0; j < sets.length; j++) {
      var s = sets[j];
      var a = +s.a || 0, b = +s.b || 0;

      wins[a > b ? 0 : 1]++;

      var total = a + b;
      var margin = Math.abs(a - b);
      marginSum += margin;

      if (a >= 20 && b >= 20) stats.deuceSets++;
      if (!stats.maxTotalSet || total > (stats.maxTotalSet.a + stats.maxTotalSet.b)) {
        stats.maxTotalSet = { a: a, b: b, names: m.names };
      }
    }

    if (wins[0] === 2 || wins[1] === 2) stats.straight++;
    else stats.three++;
  }

  stats.avgMargin = stats.sets ? (marginSum / stats.sets) : 0;
  return stats;
}
function renderStats(arr) {
  var s = fmtStats(arr);
  var host = ensureStatsShell();
  host.style.display = 'block';
  
  // Skjul kampvisningen
  document.querySelector('.wrap').style.display = 'none';
  var summaryBtn = document.getElementById('showSummaryBtn');
  if (summaryBtn) summaryBtn.style.display = 'none';
  
  // Sett VIEW_MODE til stats og legg til CSS-klasse
  window.VIEW_MODE = 'stats';
  document.body.classList.add('stats-mode');
  
  // Debug logging
  console.log('renderStats: VIEW_MODE satt til:', window.VIEW_MODE);
  
  // Oppdater menyen
  renderMenu();
  
  var el = document.getElementById('stats');
  el.innerHTML = '';

  function card(label, val) {
    var d = document.createElement('div');
    d.className = 'stat';
    d.innerHTML = 
      '<div class="muted">' + label + '</div>' +
      '<div style="font-size:1.15rem;font-weight:700">' + val + '</div>';
    return d;
  }

  el.appendChild(card('Kamper lagret', s.matches));
  el.appendChild(card('Sett spilt', s.sets));
  el.appendChild(card('2–0-kamper', s.straight));
  el.appendChild(card('3-settskamper', s.three));
  el.appendChild(card('Deuce-sett (≥20–20)', String(s.deuceSets)));
  el.appendChild(card('Snitt seiersmargin/sett', s.avgMargin.toFixed(2)));
  if (s.maxTotalSet) {
    el.appendChild(card('Høyest poeng i ett sett', s.maxTotalSet.a + '-' + s.maxTotalSet.b));
  }

  // Leaderboard (antall seire per spiller-navn)
  var all = loadMatches();
  var winMap = {};
  for (var i = 0; i < all.length; i++) {
    var w = all[i].winner || '';
    winMap[w] = (winMap[w] || 0) + 1;
  }

  var leaderDiv = document.getElementById('leaderboard');
  leaderDiv.innerHTML = '<h4 style="margin:.2rem 0 .4rem 0">Seiersoversikt</h4>';

  var entries = [];
  for (var k in winMap) {
    if (Object.prototype.hasOwnProperty.call(winMap, k)) {
      entries.push([k, winMap[k]]);
    }
  }
  entries.sort(function(a, b) { return b[1] - a[1]; });

  if (!entries.length) {
    leaderDiv.appendChild(document.createTextNode('Ingen lagrede kamper ennå.'));
  } else {
    var cont = document.createElement('div');
    cont.className = 'leader';
    for (var ii = 0; ii < entries.length; ii++) {
      var n = document.createElement('div');
      n.textContent = entries[ii][0];
      var c = document.createElement('div');
      c.textContent = entries[ii][1];
      c.style.textAlign = 'right';
      cont.appendChild(n);
      cont.appendChild(c);
    }
    leaderDiv.appendChild(cont);
  }

  // Historikktabell
  var body = document.getElementById('historyBody');
  body.innerHTML = '';
  for (i = 0; i < all.length; i++) {
    (function(idx) {
      var m = all[idx];
      var tr = document.createElement('tr');

      function td(txt) {
        var x = document.createElement('td');
        x.textContent = txt;
        return x;
      }
      
      function fmtDate(ts) {
        var d = new Date(ts);
        return d.toLocaleString(undefined, {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      tr.appendChild(td(String(idx + 1)));
      tr.appendChild(td(fmtDate(m.ts)));
      tr.appendChild(td(m.names.A));
      tr.appendChild(td(m.names.B));

      var parts = [];
      for (var j = 0; j < (m.sets || []).length; j++) {
        var s2 = m.sets[j];
        parts.push(String(s2.a) + '-' + String(s2.b));
      }
      tr.appendChild(td(parts.join(' , ')));
      tr.appendChild(td(m.winner));

      var tdAct = document.createElement('td');
      var del = document.createElement('button');
      del.className = 'button';
      del.textContent = 'Slett';
      del.addEventListener('click', function() {
        var arr2 = loadMatches();
        arr2.splice(idx, 1);
        saveMatches(arr2);
        renderStats(loadMatches());
      });
      tdAct.appendChild(del);
      tr.appendChild(tdAct);

      body.appendChild(tr);
    })(i);
  }
}

function showMatch() {
  // Vis kampvisningen igjen
  var wrap = document.querySelector('.wrap');
  if (wrap) {
    // Viktig: la CSS ta over (grid fra stylesheet), eller sett eksplisitt 'grid'
    wrap.style.display = ''; // eller: wrap.style.display = 'grid';
  }

  var statsHost = document.getElementById('statsHost');
  if (statsHost) statsHost.style.display = 'none';

  // Sett modus tilbake og rydd opp
  window.VIEW_MODE = 'match';
  document.body.classList.remove('stats-mode');
  setBodyScroll(false);          // i tilfelle noe har låst scroll
  updateEditableState();         // reaktiverer .areas-active for klikk
  fitScores();                   // rekalkulerer fontstørrelser etter layout-endring

  // Bygg riktig meny (kamp-menyen)
  renderMenu();
}

/* ===== Spectator helpers/state ===== */
var __spectPrev = { isALeft: null, A: null, B: null, setsA: null, setsB: null };
var __spectIsSwapping = false;     // ny
var __spectPendingZero = false;    // ny

function setNameChipsDirect(Aname, Bname){
  var ca = document.getElementById('nameA_chip');
  var cb = document.getElementById('nameB_chip');
  if (ca) ca.textContent = Aname || 'Spiller A';
  if (cb) cb.textContent = Bname || 'Spiller B';
}

// Swap-ANIMASJON for spectator (ingen modal-synk)
function startVisualSwapSpectator(done){
  var wrap = document.getElementById('wrap');
  var left = document.querySelector('.side.left');
  var right = document.querySelector('.side.right');
  var div = document.querySelector('.divider');
  if (!(wrap && left && right && div)) { if (typeof done==='function') done(); return; }

  if (wrap.classList.contains('swap-go')) return;

  __spectIsSwapping = true; // <— NYTT

  wrap.classList.add('swap-go');
  var finished = false;
  function complete(){
    if (finished) return; finished = true;
    try{
      wrap.classList.add('no-trans');
      // bytt plass i DOM
      wrap.insertBefore(right, left);
      if (div.parentNode !== wrap) wrap.appendChild(div);
      wrap.insertBefore(div, left);
      left.classList.remove('left');  left.classList.add('right');
      right.classList.remove('right'); right.classList.add('left');
    }catch(e){}
    wrap.classList.remove('swap-go'); void wrap.offsetWidth; wrap.classList.remove('no-trans');
    fitScores();

    __spectIsSwapping = false; // <— NYTT

    // Hvis vi utsatte 0–0, påfør det nå – uten glød
    if (__spectPendingZero) {
      __spectPendingZero = false;
      scoreA = 0; scoreB = 0;
      updateScores();
      document.getElementById('A_digits')?.classList.remove('pop','popMinus');
      document.getElementById('B_digits')?.classList.remove('pop','popMinus');
    }

    if (typeof done==='function') { try{ done(); }catch(_){} }
  }
  function onEnd(e){
    if (e.target !== left && e.target !== right) return;
    left.removeEventListener('transitionend', onEnd);
    right.removeEventListener('transitionend', onEnd);
    complete();
  }
  left.addEventListener('transitionend', onEnd);
  right.addEventListener('transitionend', onEnd);
  setTimeout(complete, 1200);
}

/* ===== Firebase v8 compat (games/<gameId>) ===== */
var pushStateThrottled=function(){};var pushStateNow=function(){};
function getStateForSync(){
  var n = readABFromModalInputs();
  return {
    ts: Date.now(),
    hostUid: (window.firebase && firebase.auth && firebase.auth().currentUser ? firebase.auth().currentUser.uid : null),
    names: { A: n.A, B: n.B },
    scores: { A: scoreA, B: scoreB },
    sets: { A: setsA, B: setsB },
    currentSet: currentSet,
    isALeft: ($('#sideA') && $('#sideA').classList.contains('left')) || false,
    msg: ($('#winnerMsg') && $('#winnerMsg').textContent) || '',
    online: true
    // <- IKKE betweenSets i RTDB
  };
}
function setupFirebase(){function loadScript(src,cb){var s=document.createElement('script');s.src=src;s.async=true;s.onload=function(){cb(null)};s.onerror=function(){cb(new Error('load '+src))};document.head.appendChild(s)}function afterSDK(){if(!window.firebase){console.warn('Firebase ikke tilgjengelig – lokal modus');return}var conf={apiKey:'AIzaSyC_ApdJ1Xjldak5lw2myQI-6Y08ncU2UtM',authDomain:'badmintonteller.firebaseapp.com',projectId:'badmintonteller',storageBucket:'badmintonteller.firebasestorage.app',messagingSenderId:'776787720081',appId:'1:776787720081:web:6802244ed1a94519760c30',measurementId:'G-9PK8TF32H2',databaseURL:'https://badmintonteller-default-rtdb.europe-west1.firebasedatabase.app/'};if(!firebase.apps.length)firebase.initializeApp(conf);firebase.auth().onAuthStateChanged(function(user){if(!user){firebase.auth().signInAnonymously().catch(function(e){console.warn('Anon auth feilet',e)});return}var db=firebase.database();if(IS_SPECTATOR){var gid=qs('game');if(!gid){alert('Mangler ?game=ID i URL');return}var ref=db.ref('games/'+gid);ref.off();ref.on('value',function(snap){var v=snap.val();if(!v)return;

// 1) Les verdier fra DB
var nextIsALeft = !!v.isALeft;
var a = Number((v.scores && v.scores.A) || 0);
var b = Number((v.scores && v.scores.B) || 0);
var prevA = __spectPrev.A;
var prevB = __spectPrev.B;
var prevSA = __spectPrev.setsA;
var prevSB = __spectPrev.setsB;

// Hent sett-tellere fra DB (disse driver de blå sirklene)
var sA = Number((v.sets && v.sets.A) || 0);
var sB = Number((v.sets && v.sets.B) || 0);

var isSetChange = (prevSA != null && (sA !== prevSA || sB !== prevSB));

// NY: kjenn igjen "reset til 0–0"
var dropToZero = (a === 0 && b === 0) && ((prevA > 0) || (prevB > 0));

var wantSwap = (__spectPrev.isALeft !== null) && (__spectPrev.isALeft !== nextIsALeft); // ny

// Hold igjen 0–0 til etter animasjonen
if (dropToZero && (wantSwap || __spectIsSwapping)) {
  __spectPendingZero = true;
  // behold gamle poeng på skjermen mens vi animerer bytte
  a = (typeof prevA === 'number') ? prevA : a;
  b = (typeof prevB === 'number') ? prevB : b;
}

scoreA = a; scoreB = b;
setsA = sA; setsB = sB;
// (valgfritt) oppdater også currentSet om du vil vise det senere:
currentSet = Number(v.currentSet || currentSet);

// 2) Navn: ALDRI via modal i spectator
setNameChipsDirect((v.names && v.names.A) || 'Spiller A',
                   (v.names && v.names.B) || 'Spiller B');

// 3) Sideswap: første gang -> sett direkte. Ved endring -> ANIMER
if (__spectPrev.isALeft === null) {
  setSidesDomTo(nextIsALeft);   // init
} else if (__spectPrev.isALeft !== nextIsALeft) {
  startVisualSwapSpectator();   // animert bytte
}

// 4) Poeng -> oppdater og bump KUN siden som endret seg
updateScores();

// Ikke glød ved sett-overgang eller ved 0–0-reset
var suppressBumps = isSetChange || dropToZero;

var elA = document.getElementById('A_digits');
var elB = document.getElementById('B_digits');

if (!suppressBumps) {
  if (prevA != null && a !== prevA) ((a > prevA) ? bumpPlus : bumpMinus)(elA);
  if (prevB != null && b !== prevB) ((b > prevB) ? bumpPlus : bumpMinus)(elB);
} else {
  // Sørg for at ingen "hengende" animasjonsklasser ligger igjen
  elA?.classList.remove('pop','popMinus');
  elB?.classList.remove('pop','popMinus');
}

            clearWinner();
document.getElementById('winnerMsg').textContent = v.msg || '';
if (v.msg && v.msg.indexOf('GRATULERER') > -1) {
  if (scoreA > scoreB) {
    document.getElementById('scoreA')?.classList.add('winner');
    document.getElementById('nameA_chip')?.classList.add('winnerName');
  } else {
    document.getElementById('scoreB')?.classList.add('winner');
    document.getElementById('nameB_chip')?.classList.add('winnerName');
  }
}

// I spectator: ikke re-fit på hvert poeng (gir "dobbel bump").
// Refit kun ved første snapshot eller når layout endres (swap).
if (__spectPrev.isALeft === null || __spectPrev.isALeft !== nextIsALeft) {
            queueFit();
}
// Refit også når sett-badgene endrer seg (sjeldent – ved sett-slutt)
if (prevSA != null && (prevSA !== setsA || prevSB !== setsB)) {
  queueFit();
}

__spectPrev = { isALeft: nextIsALeft, A: a, B: b, setsA: setsA, setsB: setsB };
},function(err){console.warn('RTDB lesefeil',err&&err.code);toast('Kan ikke lese kampdata')})}else{var gid=ensureGameId();var ref=db.ref('games/'+gid);var to=0;pushStateThrottled=function(){clearTimeout(to);to=setTimeout(function(){ref.set(getStateForSync())},180)};pushStateNow=function(){clearTimeout(to);return ref.set(getStateForSync())};db.ref('games/'+gid+'/online').onDisconnect().set(false);db.ref('games/'+gid+'/online').set(true);pushStateNow()}})}loadScript('https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js',function(){loadScript('https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js',function(){loadScript('https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js',afterSDK)})})}

/* ===== Resets ===== */
function resetSet(){betweenSets=false;pendingSetWinner=null;var ns=document.getElementById('nextSetBtn');if(ns)ns.style.display='none';scoreA=0;scoreB=0;swappedAt11=false;updateScores();fitScores();saveLiveState();pushStateThrottled()}
function startNewMatch(){betweenSets=false;pendingSetWinner=null;var ns=document.getElementById('nextSetBtn');if(ns)ns.style.display='none';scoreA=0;scoreB=0;setsA=0;setsB=0;currentSet=1;swappedAt11=false;locked=false;setHistory=[];$('#winnerMsg').textContent='';clearWinner();closeSummaryModal();var summaryBtn=document.getElementById('showSummaryBtn');if(summaryBtn)summaryBtn.style.display='none';document.body.classList.remove('areas-active');allowScoring=false;nameEditMode=false;updateEditableState();updateScores();fitScores();saveLiveState();pushStateThrottled();showNameModal(true)}

/* ===== Summary Modal ===== */
function closeSummaryModal(){
  var mask = document.getElementById('summaryMask');
  if (mask) {
    mask.style.display = 'none';
    setBodyScroll(false);
  }
}

/* ===== Autocomplete functionality ===== */
function autocomplete(input, listId) {
  var currentFocus = -1;
  
  input.addEventListener("input", function(e) {
    var val = this.value;
    var list = document.getElementById(listId);
    list.innerHTML = "";
    
    if (!val) {
      list.style.display = "none";
      return;
    }
    
    // Autocomplete bruker alle 100 navn
    var prevNames = getPrevNames();
    var matches = prevNames.filter(function(name) {
      return name.toLowerCase().indexOf(val.toLowerCase()) > -1;
    });
    
    if (matches.length === 0) {
      list.style.display = "none";
      return;
    }
    
    list.style.display = "block";
    matches.forEach(function(match) {
      var div = document.createElement("div");
      var strong = document.createElement("strong");
      strong.textContent = match.substr(0, val.length);
      var remainder = document.createTextNode(match.substr(val.length));
      div.appendChild(strong);
      div.appendChild(remainder);

      var hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.value = match;
      div.appendChild(hiddenInput);
      div.addEventListener("click", function(e) {
        input.value = this.getElementsByTagName("input")[0].value;
        list.style.display = "none";
        updateNameChips();
      });
      list.appendChild(div);
    });
  });
  
  input.addEventListener("keydown", function(e) {
    var list = document.getElementById(listId);
    var items = list.getElementsByTagName("div");
    
    if (e.keyCode === 40) { // Down arrow
      currentFocus++;
      addActive(items);
    } else if (e.keyCode === 38) { // Up arrow
      currentFocus--;
      addActive(items);
    } else if (e.keyCode === 13) { // Enter
      e.preventDefault();
      if (currentFocus > -1) {
        if (items[currentFocus]) {
          items[currentFocus].click();
        }
      }
    }
  });
  
  function addActive(items) {
    removeActive(items);
    if (currentFocus >= items.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (items.length - 1);
    if (items[currentFocus]) items[currentFocus].classList.add("autocomplete-active");
  }
  
  function removeActive(items) {
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove("autocomplete-active");
    }
  }
  
  // Close autocomplete when clicking outside
  document.addEventListener("click", function(e) {
    if (e.target !== input && e.target.className !== 'dropdown-btn') {
      document.getElementById(listId).style.display = "none";
    }
  });
}

/* ===== Dropdown functionality ===== */
window.toggleDropdown = function(fieldId) {
  var list = document.getElementById(fieldId + '-list');
  var input = document.getElementById(fieldId);
  
  if (list.style.display === "block") {
    list.style.display = "none";
    return;
  }
  
  // Vis de 6 siste navnene
  var recentNames = getRecentNames(6);
  list.innerHTML = "";
  
  if (recentNames.length === 0) {
    list.style.display = "none";
    return;
  }
  
  list.style.display = "block";
  recentNames.forEach(function(name) {
    var div = document.createElement("div");
    div.textContent = name;
    div.addEventListener("click", function(e) {
      input.value = name;
      list.style.display = "none";
      updateNameChips();
    });
    list.appendChild(div);
  });
}

/* ===== Name modal bindings ===== */
function onSaveNames(){
  var n = readABFromModalInputs(); // {A,B} riktig uansett side
  var a = n.A, b = n.B;
  saveLastNames(a, b);
  hideNameModal();
  updateNameChips();
  allowScoring = true;
  saveLiveState();
  pushStateThrottled();
}
(function(){
  var cancel=$('#btnCancelNames');if(cancel)cancel.addEventListener('click',hideNameModal);
  var save=$('#btnSaveNames');if(save)save.addEventListener('click',function(){onSaveNames();hideNameModal()});
  var start=$('#btnStart');if(start)start.addEventListener('click',function(){onSaveNames();allowScoring=true;nameEditMode=false;saveLiveState();pushStateThrottled()});
  
  // Initialize autocomplete for both name fields
  var nameA = document.getElementById('nameA');
  var nameB = document.getElementById('nameB');
  if (nameA) autocomplete(nameA, 'nameA-list');
  if (nameB) autocomplete(nameB, 'nameB-list');
})();

/* ===== Summary modal bindings ===== */
(function(){
  var closeBtn = document.getElementById('summaryClose');
  var closeSummaryBtn = document.getElementById('btnCloseSummary');
  var newMatchBtn = document.getElementById('btnNewMatch');
  var showSummaryBtn = document.getElementById('showSummaryBtn');
  var mask = document.getElementById('summaryMask');
  
  if (closeBtn) closeBtn.addEventListener('click', closeSummaryModal);
  if (closeSummaryBtn) closeSummaryBtn.addEventListener('click', closeSummaryModal);
  if (newMatchBtn) newMatchBtn.addEventListener('click', function(){ closeSummaryModal(); startNewMatch(); });
  if (showSummaryBtn) showSummaryBtn.addEventListener('click', function(){ 
    var n = readABFromModalInputs();
    var nA = n.A, nB = n.B;
    var winnerName = (setsA === 2) ? nA : nB;
    renderSummary(winnerName);
  });
  if (mask) mask.addEventListener('click', function(e){ if(e.target === mask) closeSummaryModal(); });
})();

// Next Set Button bindings
(function(){
  var ns = document.getElementById('nextSetBtn');
  if (ns) ns.addEventListener('click', function(){ if (!IS_SPECTATOR) advanceToNextSet(); });

  document.addEventListener('keydown', function(e){
    if (IS_SPECTATOR) return;
    if (betweenSets && (e.key === 'Enter' || e.key === ' ' || e.key.toLowerCase() === 'n')){
      e.preventDefault();
      advanceToNextSet();
    }
  });
})();

/* ===== Init ===== */
function init(){
  // Sett standard VIEW_MODE
  if (typeof window.VIEW_MODE === 'undefined') {
    window.VIEW_MODE = 'match';
  }
  
  updateScores();fitScores();if(IS_SPECTATOR){document.body.classList.remove('areas-active');kebab.style.display='none';panel.style.display='none'}else{kebab.style.display='block';try{if(!localStorage.getItem(LS_KB_TIP)){kebab.classList.add('pulse');setTimeout(function(){kebab.classList.remove('pulse');localStorage.setItem(LS_KB_TIP,'1')},2600)}}catch(e){}bindLongPressOne($('#scoreA'),function(){removePoint('A')});bindLongPressOne($('#scoreB'),function(){removePoint('B')});bindTap($('#scoreA'),function(){addPoint('A')});bindTap($('#scoreB'),function(){addPoint('B')});bindLongPressOne($('#leftArea'),function(){removePointByPosition('left')});bindLongPressOne($('#rightArea'),function(){removePointByPosition('right')});bindTap($('#leftArea'),function(){addPointByPosition('left')});bindTap($('#rightArea'),function(){addPointByPosition('right')});renderMenu()}setupFirebase()}

document.addEventListener('DOMContentLoaded',function(){var restored=restoreLiveState();renderRecentOptions();if(!IS_SPECTATOR){if(!restored){var last=null;try{last=JSON.parse(localStorage.getItem(LS_LAST)||'[]')}catch(e){}$('#nameA').value=(last&&last[0])||'Spiller A';$('#nameB').value=(last&&last[1])||'Spiller B';showNameModal(true)}else if(!allowScoring){showNameModal(true)}updateNameChips()}updateEditableState();init()});

/* ===== tiny self-tests ===== */
(function(){try{console.assert(typeof fmtStats([])==='object','fmtStats returns object');}catch(e){}})();

})();
</script>
</body>
</html>
